<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shop Control Panel — Login</title>
<style>
  :root{
    --primary:#0073e6; --secondary:#ff9900; --bg1:#f8fbff; --bg2:#eef6ff;
    --card:#ffffff; --text:#111827; --muted:#6b7280; --shadow: 0 10px 30px rgba(2,6,23,0.08);
    font-family: Inter, Arial, sans-serif;
  }
  html,body{height:100%;margin:0;background: linear-gradient(180deg,var(--bg1),var(--bg2)); color:var(--text)}
  .center{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px;animation:fadeIn .45s ease both}
  @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
  .card{width:420px;max-width:96%;background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:28px}
  .logo{font-weight:800;color:var(--primary);font-size:18px}
  h1{margin:8px 0 18px;font-size:20px;color:#0f1724}
  label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eef9;margin-top:6px;box-sizing:border-box}
  .btn{display:inline-block;width:100%;background:var(--primary);color:#fff;padding:10px;border-radius:10px;border:0;margin-top:18px;font-weight:700;cursor:pointer;transition:transform .15s,filter .15s}
  .btn:hover{transform:translateY(-2px);filter:brightness(.94)}
  .btn:disabled{opacity:0.6;cursor:not-allowed;transform:none !important}
  .meta{font-size:13px;color:var(--muted);margin-top:8px;text-align:center}
  .error{color:#b91c1c;font-size:13px;margin-top:8px;display:none;padding:8px;background:#fee;border-radius:6px;border:1px solid #fecaca}
  .success{color:#059669;font-size:13px;margin-top:8px;display:none;padding:8px;background:#ecfdf5;border-radius:6px;border:1px solid #a7f3d0}
  .links{margin-top:12px;font-size:13px;color:var(--muted);text-align:center}
  .small{font-size:12px;color:#94a3b8}
  footer{margin-top:14px;text-align:center;font-size:12px;color:var(--muted)}
  /* Loader */
  .loader{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading{position:relative;color:transparent !important}
  .loading::after{content:'';position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:16px;height:16px;border:2px solid rgba(0,115,230,0.3);border-radius:50%;border-top-color:var(--primary);animation:spin 1s ease-in-out infinite}
  /* TOTP Modal */
  .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.75);display:flex;align-items:center;justify-content:center;z-index:1200;animation:fadeIn .2s ease}
  .modal{background:#fff;padding:24px;border-radius:12px;width:90%;max-width:380px;box-shadow:0 20px 60px rgba(2,6,23,0.3)}
  .modal-title{font-weight:700;font-size:18px;margin-bottom:4px}
  .modal-subtitle{color:var(--muted);font-size:14px;margin-bottom:16px}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}
  .btn-secondary{background:#f1f5f9;border:1px solid #e2e8f0;color:var(--text)}
  .btn-secondary:hover{background:#e2e8f0}
  .muted{color:var(--muted)}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

<script>
// Initialize Supabase client with Netlify environment variables
(async function initSupabaseClient() {
  try {
    const res = await fetch('/.netlify/functions/get-client-config');
    if (!res.ok) {
      console.error('Failed to load Supabase config', res.status, await res.text());
      document.getElementById('error').textContent = 'Service configuration error. Please contact administrator.';
      document.getElementById('error').style.display = 'block';
      return;
    }
    
    const cfg = await res.json(); 
    
    // Use camelCase property names to match your Netlify function
    if (!cfg.supabaseUrl || !cfg.supabaseAnonKey) {
      console.error('Missing Supabase configuration');
      document.getElementById('error').textContent = 'Service configuration incomplete.';
      document.getElementById('error').style.display = 'block';
      return;
    }

    // Initialize Supabase client with camelCase properties
    window.supabase = supabase.createClient(cfg.supabaseUrl, cfg.supabaseAnonKey, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: false
      }
    });
    
    console.log('Supabase client initialized successfully');
    
    // Rest of your code remains the same...
    // Check for existing session
    const { data: { session } } = await window.supabase.auth.getSession();
    if (session) {
      // Check if user has valid role before redirecting
      const userRoles = await getUserRoles(session.user.id);
      if (userRoles.length > 0) {
        // User has roles, redirect based on last used or default
        const lastRole = localStorage.getItem('last_role') || 'admin';
        redirectBasedOnRole(userRoles, lastRole);
      }
    }
    
  } catch (err) {
    console.error('Error initializing Supabase:', err);
    document.getElementById('error').textContent = 'Failed to initialize authentication service.';
    document.getElementById('error').style.display = 'block';
  }
})();

// Get user roles from user_roles table
async function getUserRoles(userId) {
  try {
    const { data, error } = await window.supabase
      .from('user_roles')
      .select('role, is_active')
      .eq('user_id', userId)
      .eq('is_active', true);
    
    if (error) throw error;
    return data || [];
  } catch (err) {
    console.error('Error fetching user roles:', err);
    return [];
  }
}

// Check if user exists and has permission for selected role
async function checkUserPermission(email, password, selectedRole) {
  try {
    // First, try to sign in with Supabase Auth
    const { data: authData, error: authError } = await window.supabase.auth.signInWithPassword({
      email,
      password
    });
    
    if (authError) {
      return {
        success: false,
        error: authError.message.includes('Invalid') 
          ? 'Invalid email or password' 
          : 'Authentication failed'
      };
    }
    
    const user = authData.user;
    
    // Check if user exists in profiles table
    const { data: profile, error: profileError } = await window.supabase
      .from('profiles')
      .select('id, is_admin')
      .eq('user_id', user.id)
      .single();
    
    if (profileError && profileError.code !== 'PGRST116') {
      console.error('Profile check error:', profileError);
    }
    
    // Get user's roles from user_roles table
    const userRoles = await getUserRoles(user.id);
    
    if (userRoles.length === 0) {
      return {
        success: false,
        error: 'No assigned roles. Contact administrator.'
      };
    }
    
    // Check if user has permission for selected role
    const selectedRoleLower = selectedRole.toLowerCase();
    const userRoleNames = userRoles.map(r => r.role.toLowerCase());
    
    // Admin can access everything
    const isAdmin = userRoleNames.includes('admin') || 
                   userRoleNames.includes('administrator') ||
                   (profile && profile.is_admin);
    
    // Check specific role permission
    const hasRole = userRoleNames.includes(selectedRoleLower);
    
    if (!hasRole && !isAdmin) {
      return {
        success: false,
        error: `You don't have permission to access ${selectedRole} section.`
      };
    }
    
    // Logistics users can only access logistics
    if (selectedRoleLower === 'logistics' && !isAdmin) {
      const hasLogisticsRole = userRoleNames.includes('logistics');
      if (!hasLogisticsRole) {
        return {
          success: false,
          error: 'Logistics access requires logistics role.'
        };
      }
    }
    
    return {
      success: true,
      user: {
        id: user.id,
        email: user.email,
        role: isAdmin ? 'admin' : selectedRoleLower,
        isAdmin: isAdmin,
        hasTOTP: userRoles.some(r => r.totp_enabled)
      },
      roles: userRoles
    };
    
  } catch (err) {
    console.error('Permission check error:', err);
    return {
      success: false,
      error: 'An unexpected error occurred. Please try again.'
    };
  }
}

// TOTP Verification Modal
function showTOTPModal() {
  return new Promise((resolve) => {
    const overlay = document.createElement('div');
    overlay.className = 'overlay';
    overlay.innerHTML = `
      <div class="modal">
        <div class="modal-title">Two-Factor Authentication</div>
        <div class="modal-subtitle">Enter the 6-digit code from your authenticator app</div>
        <label for="totpCode">TOTP Code</label>
        <input 
          id="totpCode" 
          type="text" 
          inputmode="numeric" 
          pattern="[0-9]{6}" 
          maxlength="6" 
          placeholder="123456"
          style="letter-spacing: 8px; font-size: 20px; text-align: center"
          autocomplete="one-time-code"
        />
        <div id="totpError" class="error" style="display:none; margin-top: 8px;"></div>
        <div class="modal-actions">
          <button id="cancelTOTP" class="btn-secondary" style="padding: 8px 16px;">Cancel</button>
          <button id="verifyTOTP" class="btn" style="padding: 8px 16px;">Verify</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(overlay);
    
    const codeInput = overlay.querySelector('#totpCode');
    const errorEl = overlay.querySelector('#totpError');
    const cancelBtn = overlay.querySelector('#cancelTOTP');
    const verifyBtn = overlay.querySelector('#verifyTOTP');
    
    codeInput.focus();
    
    // Handle TOTP code input
    codeInput.addEventListener('input', (e) => {
      const value = e.target.value.replace(/\D/g, '');
      e.target.value = value;
      if (value.length === 6) {
        verifyBtn.focus();
      }
    });
    
    // Cancel button
    cancelBtn.addEventListener('click', () => {
      overlay.remove();
      resolve({ cancelled: true });
    });
    
    // Verify button
    verifyBtn.addEventListener('click', async () => {
      const code = codeInput.value.trim();
      
      if (code.length !== 6 || !/^\d{6}$/.test(code)) {
        errorEl.textContent = 'Please enter a valid 6-digit code';
        errorEl.style.display = 'block';
        return;
      }
      
      // In a real implementation, you would verify the TOTP code
      // For now, we'll accept any 6-digit code for demo purposes
      // You should implement proper TOTP verification using a server function
      overlay.remove();
      resolve({ verified: true, code });
    });
    
    // Handle Enter key
    codeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        verifyBtn.click();
      }
    });
  });
}

// Redirect based on role
function redirectBasedOnRole(userRoles, selectedRole) {
  const userRoleNames = userRoles.map(r => r.role.toLowerCase());
  const isAdmin = userRoleNames.includes('admin') || 
                  userRoleNames.includes('administrator');
  
  let redirectTo = 'admin.html';
  
  if (!isAdmin && selectedRole.toLowerCase() === 'logistics') {
    redirectTo = 'logistics.html';
  }
  
  // Store last used role
  localStorage.setItem('last_role', selectedRole.toLowerCase());
  
  // Redirect
  window.location.href = redirectTo;
}

// Main login handler
document.addEventListener('DOMContentLoaded', () => {
  const loginBtn = document.getElementById('loginBtn');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const roleSelect = document.getElementById('role');
  const errorEl = document.getElementById('error');
  const successEl = document.getElementById('success');
  
  let isLoggingIn = false;
  
  function showError(message) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    successEl.style.display = 'none';
  }
  
  function showSuccess(message) {
    successEl.textContent = message;
    successEl.style.display = 'block';
    errorEl.style.display = 'none';
  }
  
  function clearMessages() {
    errorEl.style.display = 'none';
    successEl.style.display = 'none';
  }
  
  function setLoading(loading) {
    isLoggingIn = loading;
    loginBtn.disabled = loading;
    
    if (loading) {
      loginBtn.classList.add('loading');
      loginBtn.innerHTML = '<span class="loader"></span>';
    } else {
      loginBtn.classList.remove('loading');
      loginBtn.textContent = 'Login';
    }
  }
  
  async function handleLogin() {
    if (isLoggingIn || !window.supabase) return;
    
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    const selectedRole = roleSelect.value;
    
    // Validation
    if (!email || !password) {
      showError('Please enter both email and password');
      return;
    }
    
    if (!email.includes('@') || !email.includes('.')) {
      showError('Please enter a valid email address');
      return;
    }
    
    if (password.length < 6) {
      showError('Password must be at least 6 characters');
      return;
    }
    
    clearMessages();
    setLoading(true);
    
    try {
      // Check user permission
      const result = await checkUserPermission(email, password, selectedRole);
      
      if (!result.success) {
        showError(result.error);
        setLoading(false);
        return;
      }
      
      // Check if TOTP is required
      if (result.user.hasTOTP) {
        const totpResult = await showTOTPModal();
        
        if (totpResult.cancelled) {
          setLoading(false);
          showError('Login cancelled. TOTP verification required.');
          return;
        }
        
        // Verify TOTP code (you should implement this server-side)
        // For now, we'll proceed
      }
      
      // Login successful
      showSuccess('Login successful! Redirecting...');
      
      // Store user info in localStorage
      localStorage.setItem('current_user', JSON.stringify({
        id: result.user.id,
        email: result.user.email,
        role: result.user.role,
        isAdmin: result.user.isAdmin,
        timestamp: new Date().toISOString()
      }));
      
      // Redirect after short delay
      setTimeout(() => {
        redirectBasedOnRole(result.roles, selectedRole);
      }, 1000);
      
    } catch (err) {
      console.error('Login error:', err);
      showError('An unexpected error occurred. Please try again.');
      setLoading(false);
    }
  }
  
  // Event Listeners
  loginBtn.addEventListener('click', handleLogin);
  
  // Handle Enter key
  document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !isLoggingIn) {
      handleLogin();
    }
  });
  
  // Input field validation
  emailInput.addEventListener('input', clearMessages);
  passwordInput.addEventListener('input', clearMessages);
  
  // Auto-focus email field on page load
  emailInput.focus();
});

// Security: Clear sensitive data on page unload
window.addEventListener('beforeunload', () => {
  // Clear password field
  document.getElementById('password').value = '';
});

// Prevent form submission
document.addEventListener('submit', (e) => {
  e.preventDefault();
});
</script>
</head>
<body>
  <div class="center">
    <div class="card" role="main" aria-labelledby="loginTitle">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
        <div>
          <div class="logo">Shop Control Panel</div>
          <div class="small">Admin & Logistics Access</div>
        </div>
      </div>

      <h1 id="loginTitle">Sign in</h1>

      <label for="email">Email</label>
      <input id="email" type="email" placeholder="you@business.co.za" autocomplete="username" required />

      <label for="password">Password</label>
      <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" required minlength="6" />

      <label for="role">Access Section</label>
      <select id="role" aria-label="Select role" required>
        <option value="Admin">Admin Dashboard</option>
        <option value="Logistics">Logistics Portal</option>
      </select>

      <div id="error" class="error" role="alert" aria-live="assertive"></div>
      <div id="success" class="success" role="status" aria-live="polite"></div>

      <button id="loginBtn" class="btn" aria-label="Login">Login</button>

      <div class="meta">
        <div>Authentication protected. Contact administrator for access.</div>
        <div style="margin-top: 4px; font-size: 11px; color: #9ca3af;">
          • Admins can access all sections<br>
          • Logistics users can only access logistics
        </div>
      </div>
      
      <footer>
        <div style="font-size: 11px; color: #9ca3af; margin-top: 12px;">
          Secure connection • Encrypted transmission
        </div>
      </footer>
    </div>
  </div>
</body>
</html>