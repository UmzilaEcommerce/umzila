<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout ‚Äî Umzila Store</title>
  <style>
    /* ---------- BASE / RESET ---------- */
    :root {
      --bg: #f7f7f9;
      --card: #ffffff;
      --muted: #6b6b74;
      --accent: #0a2f66;
      --accent-2: #00a0ff;
      --cta: #ff6b2c;
      --success: #28a745;
      --error: #dc3545;
      --shadow: 0 6px 18px rgba(11, 13, 20, 0.08);
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    html, body {
      height: 100%;
      background: var(--bg);
      color: #111;
    }
    
    body {
      overflow-x: hidden;
    }
    
    a {
      color: inherit;
      text-decoration: none;
    }
    
    img {
      max-width: 100%;
      display: block;
    }
    
    button, input, select, textarea {
      font-family: inherit;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    /* ---------- HEADER ---------- */
    .checkout-header {
      background: white;
      padding: 20px 0;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .logo img {
      height: 40px;
      width: auto;
      border-radius: 6px;
    }
    
    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      background: var(--accent);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .btn:hover {
      background: var(--accent-2);
    }
    
    .btn.ghost {
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent);
    }
    
    .btn.ghost:hover {
      background: var(--accent);
      color: white;
    }
    
    /* ---------- CHECKOUT LAYOUT ---------- */
    .checkout-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 40px;
      margin: 40px auto;
      max-width: 1200px;
      padding: 0 20px;
    }
    
    @media (max-width: 768px) {
      .checkout-layout {
        grid-template-columns: 1fr;
        gap: 30px;
      }
    }
    
    /* ---------- CHECKOUT STEPS ---------- */
    .checkout-steps {
      display: flex;
      gap: 30px;
      margin-bottom: 40px;
      padding: 0 20px;
      max-width: 1200px;
      margin: 40px auto 30px;
    }
    
    .step {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: var(--muted);
      flex: 1;
    }
    
    .step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--muted);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    
    .step.active .step-number {
      background: var(--accent);
    }
    
    .step.completed .step-number {
      background: var(--success);
    }
    
    .step-line {
      flex: 1;
      height: 2px;
      background: var(--muted);
      margin-left: 10px;
    }
    
    .step:last-child .step-line {
      display: none;
    }
    
    /* ---------- CHECKOUT SECTIONS ---------- */
    .checkout-section {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }
    
    .section-header h2 {
      font-size: 20px;
      color: var(--accent);
    }
    
    .edit-btn {
      background: none;
      border: none;
      color: var(--accent-2);
      cursor: pointer;
      font-weight: 600;
    }
    
    /* ---------- FORM STYLES ---------- */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--accent);
      font-size: 14px;
    }
    
    .form-label .required {
      color: var(--error);
      margin-left: 2px;
    }
    
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
      transition: var(--transition);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(10, 47, 102, 0.1);
    }
    
    .form-control[readonly] {
      background: #f8f9fa;
      border-color: #e9ecef;
      cursor: not-allowed;
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
      margin-left: 8px;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background: var(--accent);
      color: white;
      text-align: center;
      padding: 8px;
      border-radius: 6px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
      font-weight: normal;
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    
    /* ---------- SHIPPING PROVINCES ---------- */
    .province-dropdown {
      width: 100%;
    }
    
    /* ---------- ORDER SUMMARY ---------- */
    .order-summary {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 100px;
    }
    
    .summary-header {
      font-size: 20px;
      color: var(--accent);
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f8f9fa;
    }
    
    .order-items {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    
    .order-item {
      display: flex;
      gap: 15px;
      padding: 15px 0;
      border-bottom: 1px solid #f8f9fa;
    }
    
    .order-item:last-child {
      border-bottom: none;
    }
    
    .item-image {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
    }
    
    .item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .item-details {
      flex: 1;
    }
    
    .item-title {
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .item-variant {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 5px;
    }
    
    .item-price {
      color: var(--cta);
      font-weight: 600;
    }
    
    /* ---------- SUMMARY TOTALS ---------- */
    .summary-totals {
      border-top: 2px solid #f8f9fa;
      padding-top: 20px;
      margin-top: 20px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 15px;
    }
    
    .summary-row.total {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #f8f9fa;
    }
    
    .summary-row.shipping {
      color: var(--success);
    }
    
    .summary-row.discount {
      color: var(--success);
    }
    
    /* Promo Code Section */
    .promo-code-section {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .promo-code-input {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .promo-code-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    
    .promo-message {
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }
    
    .promo-message.success {
      color: var(--success);
      display: block;
    }
    
    .promo-message.error {
      color: var(--error);
      display: block;
    }
    
    /* ---------- PAYMENT SECTION ---------- */
    .payment-methods {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .payment-method {
      padding: 20px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .payment-method:hover {
      border-color: var(--accent-2);
    }
    
    .payment-method.selected {
      border-color: var(--accent);
      background: rgba(10, 47, 102, 0.05);
    }
    
    .payment-icon {
      font-size: 24px;
    }
    
    .payment-details h4 {
      margin-bottom: 5px;
      font-size: 16px;
    }
    
    .payment-details p {
      font-size: 13px;
      color: var(--muted);
    }
    
    /* ---------- LOADING & ERROR STATES ---------- */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-message {
      background: rgba(220, 53, 69, 0.1);
      border: 1px solid var(--error);
      color: var(--error);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    .success-message {
      background: rgba(40, 167, 69, 0.1);
      border: 1px solid var(--success);
      color: var(--success);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    /* ---------- MODALS ---------- */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    
    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--muted);
    }
    
    .modal-title {
      font-size: 24px;
      color: var(--accent);
      margin-bottom: 20px;
      padding-right: 30px;
    }
    
    .auth-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      border-bottom: 2px solid #f8f9fa;
    }
    
    .auth-tab {
      padding: 10px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 600;
      color: var(--muted);
      position: relative;
    }
    
    .auth-tab.active {
      color: var(--accent);
    }
    
    .auth-tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
    }
    
    .auth-form {
      display: none;
    }
    
    .auth-form.active {
      display: block;
    }
    
    /* ---------- PAYFAST PAYMENT FORM ---------- */
    #payfastForm {
      display: none;
    }
    
    /* ---------- RESPONSIVE ---------- */
    @media (max-width: 768px) {
      .container {
        padding: 0 15px;
      }
      
      .checkout-section {
        padding: 20px;
      }
      
      .checkout-steps {
        padding: 0 15px;
        gap: 15px;
      }
      
      .step-line {
        display: none;
      }
      
      .order-summary {
        position: static;
        margin-top: 30px;
      }
      
      .item-image {
        width: 60px;
        height: 60px;
      }
      
      .item-title {
        font-size: 14px;
      }
      
      .promo-code-input {
        flex-direction: column;
      }
    }
    
    /* ---------- UTILITY CLASSES ---------- */
    .hidden {
      display: none !important;
    }
    
    .text-center {
      text-align: center;
    }
    
    .text-muted {
      color: var(--muted);
    }
    
    .mb-3 {
      margin-bottom: 15px;
    }
    
    .mb-4 {
      margin-bottom: 20px;
    }
    
    .mt-4 {
      margin-top: 20px;
    }
  </style>
  <!-- Include Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Header -->
  <header class="checkout-header">
    <div class="container">
      <div class="header-inner">
        <a href="index.html" class="logo">
          <img src="umzila.webp" alt="Umzila Logo">
          <span>Umzila</span>
        </a>
        <div class="header-actions">
          <button id="authBtn" class="btn ghost">Sign In</button>
          <a href="index.html" class="btn ghost">Continue Shopping</a>
        </div>
      </div>
    </div>
  </header>

  <!-- Checkout Steps -->
  <div class="checkout-steps">
    <div class="step active" data-step="shipping">
      <div class="step-number">1</div>
      <span>Shipping</span>
      <div class="step-line"></div>
    </div>
    <div class="step" data-step="payment">
      <div class="step-number">2</div>
      <span>Payment</span>
      <div class="step-line"></div>
    </div>
    <div class="step" data-step="confirmation">
      <div class="step-number">3</div>
      <span>Confirmation</span>
    </div>
  </div>

  <!-- Main Checkout Content -->
  <div class="container">
    <div class="checkout-layout">
      <!-- Left Column - Forms -->
      <div class="checkout-forms">
        <!-- Loading State -->
        <div id="loadingState" class="loading">
          <div class="loading-spinner"></div>
          <p>Loading checkout...</p>
        </div>

        <!-- Shipping Information Section -->
        <section id="shippingSection" class="checkout-section hidden">
          <div class="section-header">
            <h2>Shipping Information</h2>
            <button class="edit-btn" id="editShipping">Edit</button>
          </div>
          
          <div id="shippingForm">
            <div class="form-group">
              <label class="form-label">Email Address <span class="required">*</span></label>
              <div style="display: flex; align-items: center; gap: 10px;">
                <input type="email" id="customerEmail" class="form-control" required readonly>
                <div class="tooltip">
                  <span style="color: var(--accent); cursor: help;">‚ÑπÔ∏è</span>
                  <div class="tooltip-text">This is the email you logged in with</div>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">First Name <span class="required">*</span></label>
                <input type="text" id="firstName" class="form-control" required>
              </div>
              <div class="form-group">
                <label class="form-label">Last Name <span class="required">*</span></label>
                <input type="text" id="lastName" class="form-control" required>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Phone Number <span class="required">*</span></label>
              <input type="tel" id="phoneNumber" class="form-control" required placeholder="+27 12 345 6789">
            </div>

            <div class="form-group">
              <label class="form-label">Shipping Address <span class="required">*</span></label>
              <textarea id="shippingAddress" class="form-control" rows="3" required placeholder="Street address, apartment, suite, etc."></textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">City <span class="required">*</span></label>
                <input type="text" id="city" class="form-control" required>
              </div>
              <div class="form-group">
                <label class="form-label">Postal Code <span class="required">*</span></label>
                <input type="text" id="postalCode" class="form-control" required>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Province <span class="required">*</span></label>
              <select id="provinceSelect" class="form-control" required>
                <option value="">Select a province</option>
                <option value="KwaZulu-Natal">KwaZulu-Natal</option>
                <option value="Gauteng">Gauteng</option>
                <option value="Western Cape">Western Cape</option>
                <option value="Eastern Cape">Eastern Cape</option>
                <option value="Free State">Free State</option>
                <option value="Limpopo">Limpopo</option>
                <option value="Mpumalanga">Mpumalanga</option>
                <option value="North West">North West</option>
                <option value="Northern Cape">Northern Cape</option>
              </select>
              <input type="hidden" id="shippingCost" value="0">
            </div>

            <div class="form-group">
              <label class="form-label">Delivery Instructions (Optional)</label>
              <textarea id="deliveryInstructions" class="form-control" rows="2" placeholder="Any special instructions for delivery"></textarea>
            </div>
          </div>

          <div id="shippingReview" class="hidden">
            <div class="shipping-review-content">
              <!-- Shipping details will be shown here when in review mode -->
            </div>
          </div>

          <div class="text-center mt-4">
            <button id="continueToPayment" class="btn" style="padding: 15px 40px; font-size: 16px;">
              Continue to Payment
            </button>
          </div>
        </section>

        <!-- Payment Section -->
        <section id="paymentSection" class="checkout-section hidden">
          <div class="section-header">
            <h2>Payment Method</h2>
            <button class="edit-btn" id="editPayment">Edit</button>
          </div>

          <div class="payment-methods">
            <div class="payment-method selected" data-method="payfast">
              <div class="payment-icon">üí≥</div>
              <div class="payment-details">
                <h4>PayFast</h4>
                <p>Secure payment via PayFast (Credit Card, EFT, SnapScan)</p>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Order Notes (Optional)</label>
            <textarea id="orderNotes" class="form-control" rows="3" placeholder="Any special notes for your order"></textarea>
          </div>

          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="termsAgreement" required style="width: auto;">
              <span>I agree to the <a href="#" style="color: var(--accent);">Terms & Conditions</a> and <a href="#" style="color: var(--accent);">Privacy Policy</a></span>
            </label>
          </div>

          <div id="paymentError" class="error-message hidden"></div>

          <div class="text-center mt-4">
            <button id="payNowBtn" class="btn" style="padding: 15px 50px; font-size: 18px; background: var(--cta);">
              Pay Now
            </button>
            <div class="text-muted mt-3" style="font-size: 12px;">
              You will be redirected to PayFast's secure payment page
            </div>
          </div>
        </section>

        <!-- Confirmation Section -->
        <section id="confirmationSection" class="checkout-section hidden">
          <div class="text-center">
            <div style="font-size: 48px; color: var(--success); margin-bottom: 20px;">‚úì</div>
            <h2 style="color: var(--success); margin-bottom: 15px;">Payment Successful!</h2>
            <p class="mb-4">Your order has been placed successfully.</p>
            <div class="mb-4">
              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <div class="text-muted mb-2">Order ID</div>
                <div id="orderIdDisplay" style="font-weight: 600; font-size: 18px;"></div>
              </div>
            </div>
            <p class="mb-4">A confirmation email has been sent to <span id="confirmationEmail" style="font-weight: 600;"></span></p>
            <div class="mt-4">
              <a href="index.html" class="btn" style="margin-right: 10px;">Continue Shopping</a>
              <button id="viewOrderBtn" class="btn ghost">View Order Details</button>
            </div>
          </div>
        </section>
      </div>

      <!-- Right Column - Order Summary -->
      <div class="order-summary">
        <h2 class="summary-header">Order Summary</h2>
        
        <div id="orderItems" class="order-items">
          <!-- Order items will be populated here -->
        </div>

        <div class="promo-code-section">
          <div class="promo-code-input">
            <input type="text" id="promoCodeInput" placeholder="Enter promo code">
            <button id="applyPromoCode" class="btn">Apply</button>
          </div>
          <div id="promoMessage" class="promo-message"></div>
        </div>

        <div class="summary-totals">
          <div class="summary-row">
            <span>Subtotal</span>
            <span id="subtotalAmount">R0.00</span>
          </div>
          <div class="summary-row discount hidden" id="discountRow">
            <span>Discount</span>
            <span id="discountAmount">-R0.00</span>
          </div>
          <div class="summary-row shipping">
            <span>Shipping</span>
            <span id="shippingAmount">Calculating...</span>
          </div>
          <div class="summary-row total">
            <span>Total</span>
            <span id="totalAmount">R0.00</span>
          </div>
        </div>

        <div class="text-muted mt-4" style="font-size: 12px; text-align: center;">
          All prices include VAT where applicable
        </div>
      </div>
    </div>
  </div>

  <!-- Authentication Modal -->
  <div id="authModal" class="modal-overlay">
    <div class="modal">
      <button class="modal-close" id="closeAuthModal">√ó</button>
      <h3 class="modal-title">Sign in to Checkout</h3>
      
      <div class="auth-tabs">
        <button class="auth-tab active" data-tab="login">Sign In</button>
        <button class="auth-tab" data-tab="signup">Sign Up</button>
      </div>

      <!-- Login Form -->
      <div id="loginForm" class="auth-form active">
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <input type="email" id="loginEmail" class="form-control" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" id="loginPassword" class="form-control" placeholder="Your password">
        </div>
        <div id="loginError" class="error-message hidden"></div>
        <button id="loginSubmit" class="btn" style="width: 100%; padding: 12px;">Sign In & Continue</button>
        <div class="text-center mt-3">
          <button id="forgotPassword" class="btn ghost" style="font-size: 14px;">Forgot password?</button>
        </div>
      </div>

      <!-- Signup Form -->
      <div id="signupForm" class="auth-form">
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <input type="text" id="signupName" class="form-control" placeholder="Your name">
        </div>
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <input type="email" id="signupEmail" class="form-control" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" id="signupPassword" class="form-control" placeholder="Create a password">
          <div class="text-muted" style="font-size: 12px; margin-top: 5px;">
            Must be at least 8 characters with numbers and special characters
          </div>
        </div>
        <div id="signupError" class="error-message hidden"></div>
        <button id="signupSubmit" class="btn" style="width: 100%; padding: 12px;">Create Account & Continue</button>
      </div>

      <div class="text-muted mt-4" style="font-size: 12px; text-align: center;">
        By signing in or creating an account, you agree to our Terms and Privacy Policy.
      </div>
    </div>
  </div>

  <!-- PayFast Form (Hidden) -->
  <form id="payfastForm" method="post">
    <!-- Parameters will be added dynamically -->
  </form>

  <script>
    /********************
     * CONFIGURATION
     ********************/
    
    // Shipping costs by province (Rand)
    const SHIPPING_COSTS = {
      'KwaZulu-Natal': 90,
      'Gauteng': 120,
      'Western Cape': 130,
      'Eastern Cape': 120,
      'Free State': 110,
      'Limpopo': 130,
      'Mpumalanga': 110,
      'North West': 110,
      'Northern Cape': 140
    };
    
    // Configuration will be fetched from environment variables via Netlify Function
    let CONFIG = {
      supabaseUrl: '',
      supabaseAnonKey: '',
      payfastMerchantId: '',
      payfastMerchantKey: '',
      payfastPassphrase: '',
      payfastSandbox: true,
      siteUrl: window.location.origin
    };
    
    /********************
     * APPLICATION STATE
     ********************/
    const state = {
      user: null,
      profile: null,
      cart: [],
      shippingInfo: null,
      selectedProvince: null,
      currentStep: 'shipping',
      orderId: null,
      orderTotal: 0,
      configLoaded: false,
      discount: 0,
      couponCode: null,
      appliedPromoCode: null
    };
    
    /********************
     * DOM ELEMENTS
     ********************/
    const elements = {
      // Loading
      loadingState: document.getElementById('loadingState'),
      
      // Sections
      shippingSection: document.getElementById('shippingSection'),
      paymentSection: document.getElementById('paymentSection'),
      confirmationSection: document.getElementById('confirmationSection'),
      
      // Shipping Form
      customerEmail: document.getElementById('customerEmail'),
      firstName: document.getElementById('firstName'),
      lastName: document.getElementById('lastName'),
      phoneNumber: document.getElementById('phoneNumber'),
      shippingAddress: document.getElementById('shippingAddress'),
      city: document.getElementById('city'),
      postalCode: document.getElementById('postalCode'),
      provinceSelect: document.getElementById('provinceSelect'),
      shippingCost: document.getElementById('shippingCost'),
      deliveryInstructions: document.getElementById('deliveryInstructions'),
      continueToPayment: document.getElementById('continueToPayment'),
      
      // Payment Form
      orderNotes: document.getElementById('orderNotes'),
      termsAgreement: document.getElementById('termsAgreement'),
      payNowBtn: document.getElementById('payNowBtn'),
      paymentError: document.getElementById('paymentError'),
      
      // Order Summary
      orderItems: document.getElementById('orderItems'),
      subtotalAmount: document.getElementById('subtotalAmount'),
      shippingAmount: document.getElementById('shippingAmount'),
      totalAmount: document.getElementById('totalAmount'),
      discountRow: document.getElementById('discountRow'),
      discountAmount: document.getElementById('discountAmount'),
      promoCodeInput: document.getElementById('promoCodeInput'),
      applyPromoCode: document.getElementById('applyPromoCode'),
      promoMessage: document.getElementById('promoMessage'),
      
      // Confirmation
      orderIdDisplay: document.getElementById('orderIdDisplay'),
      confirmationEmail: document.getElementById('confirmationEmail'),
      viewOrderBtn: document.getElementById('viewOrderBtn'),
      
      // Authentication
      authModal: document.getElementById('authModal'),
      closeAuthModal: document.getElementById('closeAuthModal'),
      authBtn: document.getElementById('authBtn'),
      authTabs: document.querySelectorAll('.auth-tab'),
      loginForm: document.getElementById('loginForm'),
      signupForm: document.getElementById('signupForm'),
      loginEmail: document.getElementById('loginEmail'),
      loginPassword: document.getElementById('loginPassword'),
      loginSubmit: document.getElementById('loginSubmit'),
      loginError: document.getElementById('loginError'),
      signupName: document.getElementById('signupName'),
      signupEmail: document.getElementById('signupEmail'),
      signupPassword: document.getElementById('signupPassword'),
      signupSubmit: document.getElementById('signupSubmit'),
      signupError: document.getElementById('signupError'),
      forgotPassword: document.getElementById('forgotPassword'),
      
      // Steps
      steps: document.querySelectorAll('.step'),
      
      // PayFast Form
      payfastForm: document.getElementById('payfastForm')
    };
    
    /********************
     * HELPER FUNCTIONS
     ********************/
    
    // Format currency
    function formatCurrency(amount) {
      return 'R' + parseFloat(amount).toFixed(2);
    }
    
    // Show error message
    function showError(element, message) {
      element.textContent = message;
      element.classList.remove('hidden');
      setTimeout(() => {
        element.classList.add('hidden');
      }, 5000);
    }
    
    // Validate email
    function isValidEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }
    
    // Validate phone number
    function isValidPhone(phone) {
      const cleaned = phone.replace(/\D/g, '');
      return /^(0|27)[0-9]{9,10}$/.test(cleaned);
    }
    
    // Calculate shipping cost
    function calculateShipping(province) {
      return SHIPPING_COSTS[province] || 0;
    }
    

    
    /********************
     * FETCH CONFIGURATION FROM NETLIFY FUNCTION
     ********************/
    
    async function fetchConfiguration() {
      try {
        console.log('Fetching configuration from Netlify function...');
        const response = await fetch('/.netlify/functions/get-client-config');
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const config = await response.json();
        
        CONFIG = { ...CONFIG, ...config };
        state.configLoaded = true;
        console.log('Configuration loaded successfully');
        
        // Initialize Supabase with fetched config
        initializeSupabase();
        
      } catch (error) {
        console.error('Error fetching configuration:', error);
        showConfigurationError(error.message);
      }
    }
    
    // Show configuration error to user
    function showConfigurationError(errorDetails = '') {
      elements.loadingState.innerHTML = `
        <div class="error-message">
          <h3>Configuration Error</h3>
          <p>Unable to load checkout configuration. This might be because:</p>
          <ul style="text-align: left; margin: 10px 0; padding-left: 20px;">
            <li>The Netlify function is not set up</li>
            <li>Environment variables are missing</li>
            <li>You're running locally without the function</li>
          </ul>
          ${errorDetails ? `<p><small>Details: ${errorDetails}</small></p>` : ''}
          <div style="margin-top: 20px;">
            <button onclick="window.location.reload()" class="btn" style="margin-right: 10px;">Refresh Page</button>
            <button onclick="window.location.href='index.html'" class="btn ghost">Return to Store</button>
          </div>
        </div>
      `;
    }
    
    /********************
     * SUPABASE INITIALIZATION
     ********************/
    
    let supabaseClient = null;
    
    function initializeSupabase() {
      try {
        if (!CONFIG.supabaseUrl || !CONFIG.supabaseAnonKey) {
          console.error('Supabase configuration missing');
          showConfigurationError('Supabase URL or key is missing');
          return;
        }
        
        // Create Supabase client
        supabaseClient = window.supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseAnonKey);
        console.log('Supabase initialized successfully');
        
        // Now we can proceed with the rest of initialization
        continueInitialization();
        
      } catch (error) {
        console.error('Failed to initialize Supabase:', error);
        showConfigurationError('Failed to initialize database connection');
      }
    }
    
    /********************
     * AUTHENTICATION & PROFILE VERIFICATION
     ********************/
    
    // Check authentication status and verify profile exists
    async function checkAuth() {
      try {
        if (!supabaseClient) {
          console.error('Supabase not initialized');
          return false;
        }
        
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        
        if (error) {
          console.error('Auth session error:', error);
          return false;
        }
        
        if (session?.user) {
          state.user = session.user;
          
          // Verify profile exists (like in index.html)
          await verifyUserProfile(session.user.id);
          updateAuthUI();
          return true;
        }
        return false;
      } catch (error) {
        console.error('Auth check error:', error);
        return false;
      }
    }
    
    // Verify user profile exists (like in index.html)
    async function verifyUserProfile(userId) {
      try {
        if (!supabaseClient || !userId) return;
        
        const { data: profile, error } = await supabaseClient
          .from('profiles')
          .select('*')
          .eq('user_id', userId)
          .single();
        
        if (error) {
          // Profile doesn't exist, create one
          const { data: userData } = await supabaseClient.auth.getUser();
          const userEmail = userData?.user?.email || '';
          
          const { data: newProfile, error: createError } = await supabaseClient
            .from('profiles')
            .insert([{ 
              user_id: userId,
              email: userEmail,
              first_name: '',
              last_name: '',
              phone: ''
            }])
            .select()
            .single();
          
          if (createError) {
            console.error('Error creating profile:', createError);
            return;
          }
          
          state.profile = newProfile;
        } else {
          state.profile = profile;
        }
        
        // Pre-fill shipping form with profile data
        loadProfileData();
      } catch (error) {
        console.error('Profile verification error:', error);
      }
    }
    
    // Load profile data into form
    function loadProfileData() {
      if (!state.profile) return;
      
      elements.firstName.value = state.profile.first_name || '';
      elements.lastName.value = state.profile.last_name || '';
      elements.customerEmail.value = state.user?.email || state.profile.email || '';
      elements.phoneNumber.value = state.profile.phone || '';
      
      if (state.profile.address) {
        elements.shippingAddress.value = state.profile.address;
      }
      if (state.profile.city) {
        elements.city.value = state.profile.city;
      }
      if (state.profile.postal_code) {
        elements.postalCode.value = state.profile.postal_code;
      }
      if (state.profile.province) {
        elements.provinceSelect.value = state.profile.province;
        selectProvince(state.profile.province);
      }
    }
    
  function updateAuthUI(user) {
    if (user) {
        elements.authBtn.textContent = 'Profile';
        elements.authBtn.onclick = () => {
            window.location.href = 'profile.html';
        };
        
        // Pre-fill email if user is logged in
        elements.customerEmail.value = user.email;
        elements.customerEmail.readOnly = true;
        
        // Sync cart on login
        syncCartOnLogin(user);
    } else {
        elements.authBtn.textContent = 'Sign In';
        elements.authBtn.onclick = showAuthModal;
        elements.customerEmail.readOnly = false;
    }
}
	
	// Add cart sync function
async function syncCartOnLogin(user) {
    if (!supabaseClient || !user) return;
    
    try {
        // Get localStorage cart
        const localCart = JSON.parse(localStorage.getItem('ss_cart') || '[]');
        
        // Load server cart
        const { data: serverCart, error } = await supabaseClient
            .from('carts')
            .select('items')
            .eq('user_id', user.id)
            .single();
            
        if (!error && serverCart && serverCart.items) {
            // Merge with server cart
            const serverIds = serverCart.items.map(item => `${item.product_id}-${item.size}`);
            
            localCart.forEach(item => {
                const itemKey = `${item.id}-${item.size}`;
                if (!serverIds.includes(itemKey)) {
                    serverCart.items.push({
                        product_id: item.id,
                        name: item.name || item.title,
                        price: item.price,
                        quantity: item.quantity || item.qty,
                        size: item.size,
                        image: item.image || item.img,
                        variant_id: item.variant_id || item.variantId,
                        stock: item.stock || 0
                    });
                }
            });
            
            state.cart = serverCart.items.map(item => ({
                id: item.product_id,
                name: item.name,
                price: item.price,
                quantity: item.quantity,
                size: item.size,
                image: item.image,
                variant_id: item.variant_id
            }));
            
            // Save merged cart
            localStorage.setItem('ss_cart', JSON.stringify(state.cart));
            await saveCartToServer();
        } else if (localCart.length > 0) {
            // No server cart, save local cart to server
            await saveCartToServer();
        } else {
            // No carts, load empty
            await loadCart();
        }
        
        updateOrderSummary();
        
    } catch (error) {
        console.error('Error syncing cart on login:', error);
        await loadCart();
    }
}

// Add saveCartToServer function
async function saveCartToServer() {
    if (!supabaseClient || !state.user) return;
    
    try {
        const cartData = {
            items: state.cart.map(item => ({
                product_id: item.id,
                name: item.name,
                price: item.price,
                quantity: item.quantity,
                size: item.size,
                image: item.image,
                variant_id: item.variant_id,
                stock: item.stock || 0
            })),
            updated_at: new Date().toISOString(),
            expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
        };
        
        const { error } = await supabaseClient
            .from('carts')
            .upsert({
                user_id: state.user.id,
                items: cartData.items,
                updated_at: cartData.updated_at,
                expires_at: cartData.expires_at
            }, {
                onConflict: 'user_id'
            });
            
        if (error) {
            console.error('Error saving cart to server:', error);
        }
    } catch (error) {
        console.error('Error in saveCartToServer:', error);
    }
}

    
    // Show authentication modal
    function showAuthModal() {
      elements.authModal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    // Hide authentication modal
    function hideAuthModal() {
      elements.authModal.classList.remove('active');
      document.body.style.overflow = '';
    }
    
    /********************
     * CART MANAGEMENT WITH PRODUCT IMAGES
     ********************/
    
    // Load cart from URL parameters or localStorage
    // Load cart with server validation
async function loadCart() {
    try {
        // Check URL parameters (from index.html "Buy Now" button)
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('product');
        const couponCode = urlParams.get('coupon');
        
        if (state.user && supabaseClient) {
            // Load from Supabase server cart
            const { data, error } = await supabaseClient
                .from('carts')
                .select('items')
                .eq('user_id', state.user.id)
                .single();
                
            if (!error && data && data.items) {
                // Validate and load cart items
                await loadAndValidateCartItems(data.items);
            } else {
                // Fallback to localStorage
                await loadFromLocalStorage();
            }
        } else {
            // Not logged in, use localStorage only
            await loadFromLocalStorage();
        }
        
        // Apply coupon if provided
        if (couponCode) {
            await applyCoupon(couponCode);
        }
        
        updateOrderSummary();
        
    } catch (error) {
        console.error('Error loading cart:', error);
        state.cart = [];
        showEmptyCart();
    }
}

// Load and validate cart items from server
async function loadAndValidateCartItems(serverItems) {
    if (!supabaseClient) return;
    
    try {
        // Get all product IDs from cart
        const productIds = serverItems.map(item => item.product_id);
        
        // Fetch current product data with prices
        const { data: products, error } = await supabaseClient
            .from('products')
            .select(`
                *,
                product_variants!fk_product_variants_product(*)
            `)
            .in('id', productIds);
            
        if (error) throw error;
        
        // Create product map for quick lookup
        const productMap = {};
        products.forEach(product => {
            productMap[product.id] = product;
        });
        
        // Validate each cart item
        state.cart = [];
        serverItems.forEach(item => {
            const product = productMap[item.product_id];
            if (!product) return; // Product no longer exists
            
            let itemPrice = item.price;
            let itemStock = item.stock || 0;
            
            // Check if we need to update price from current product data
            if (product.variants && product.variants.length > 0 && item.variant_id) {
                const variant = product.variants.find(v => v.id === item.variant_id);
                if (variant) {
                    // Use variant price if available
                    itemPrice = variant.price_override || product.price;
                    itemStock = variant.stock || 0;
                }
            } else {
                // Use product price
                const salePrice = product.sale && product.sale_price ? product.sale_price : product.price;
                itemPrice = salePrice;
                itemStock = product.stock || 0;
            }
            
            // Ensure we don't exceed stock
            const quantity = Math.min(item.quantity, itemStock);
            
            if (quantity > 0) {
                state.cart.push({
                    id: item.product_id,
                    name: product.name || item.name,
                    price: itemPrice,
                    quantity: quantity,
                    size: item.size,
                    image: item.image || product.image || 'https://via.placeholder.com/400x400?text=Product+Image',
                    variant_id: item.variant_id,
                    product_data: product
                });
            }
        });
        
        // Save validated cart back to localStorage
        localStorage.setItem('ss_cart', JSON.stringify(state.cart));
        
    } catch (error) {
        console.error('Error validating cart items:', error);
        throw error;
    }
}

// Load from localStorage (fallback)
async function loadFromLocalStorage() {
    const savedCart = localStorage.getItem('ss_cart');
    const savedCoupon = localStorage.getItem('ss_coupon');
    
    if (savedCart) {
        state.cart = JSON.parse(savedCart);
        
        // Validate prices by fetching current product data
        if (supabaseClient && state.cart.length > 0) {
            const productIds = state.cart.map(item => item.id);
            
            const { data: products, error } = await supabaseClient
                .from('products')
                .select('id, price, sale, sale_price, stock, name, image')
                .in('id', productIds);
                
            if (!error && products) {
                const productMap = {};
                products.forEach(p => productMap[p.id] = p);
                
                // Update cart with current prices
                state.cart = state.cart.map(item => {
                    const product = productMap[item.id];
                    if (product) {
                        const currentPrice = product.sale && product.sale_price ? product.sale_price : product.price;
                        return {
                            ...item,
                            price: currentPrice,
                            name: product.name || item.name,
                            image: product.image || item.image
                        };
                    }
                    return item;
                }).filter(item => productMap[item.id]); // Remove items that no longer exist
            }
        }
        
        if (savedCoupon) {
            const couponData = JSON.parse(savedCoupon);
            state.couponCode = couponData.code;
            state.discount = couponData.discount || 0;
        }
    } else {
        state.cart = [];
    }
}
    
    // Load product from Supabase using product ID with images
    async function loadProductFromId(productId, couponCode = null) {
      try {
        if (!supabaseClient) {
          console.error('Supabase not initialized');
          return;
        }
        
        // Fetch product details with images
        const { data: product, error } = await supabaseClient
          .from('products')
          .select(`
            *,
            product_images!fk_product_images_product(*)
          `)
          .eq('id', productId)
          .single();
        
        if (error) throw error;
        
        // Get first product image
        let imageUrl = 'https://via.placeholder.com/400x400?text=Product+Image';
        if (product.product_images && product.product_images.length > 0) {
          // Sort by image_order if available
          const sortedImages = product.product_images.sort((a, b) => (a.image_order || 0) - (b.image_order || 0));
          imageUrl = sortedImages[0].url;
        }
        
        // Add product to cart
        state.cart = [{
          id: product.id,
          name: product.name,
          price: product.price,
          quantity: 1,
          size: product.size || 'One Size',
          image: imageUrl,
          product_data: product // Store full product data for later use
        }];
        
        // Apply coupon if provided
        if (couponCode) {
          await applyCoupon(couponCode);
        }
        
        // Save to localStorage
        localStorage.setItem('ss_cart', JSON.stringify(state.cart));
        
        updateOrderSummary();
        
      } catch (error) {
        console.error('Error loading product:', error);
        showEmptyCart();
      }
    }
    
    // Load product images for all cart items
    async function loadProductImagesForCart() {
      if (!supabaseClient || state.cart.length === 0) return;
      
      try {
        // Get all product IDs from cart
        const productIds = state.cart.map(item => item.id);
        
        // Fetch products with their images
        const { data: products, error } = await supabaseClient
          .from('products')
          .select(`
            *,
            product_images!fk_product_images_product(*)
          `)
          .in('id', productIds);
        
        if (error) throw error;
        
        // Create a map of product ID to product data with images
        const productMap = {};
        products.forEach(product => {
          let imageUrl = 'https://via.placeholder.com/400x400?text=Product+Image';
          if (product.product_images && product.product_images.length > 0) {
            const sortedImages = product.product_images.sort((a, b) => (a.image_order || 0) - (b.image_order || 0));
            imageUrl = sortedImages[0].url;
          }
          productMap[product.id] = {
            ...product,
            primary_image: imageUrl
          };
        });
        
        // Update cart items with images
        state.cart = state.cart.map(item => ({
          ...item,
          image: productMap[item.id]?.primary_image || item.image,
          product_data: productMap[item.id] || item.product_data
        }));
        
      } catch (error) {
        console.error('Error loading product images:', error);
      }
    }
    
    // Apply coupon code
    async function applyCoupon(code) {
      try {
        if (!supabaseClient) return false;
        
        const { data: coupon, error } = await supabaseClient
          .from('discount_codes')
          .select('*')
          .eq('code', code.toUpperCase())
          .eq('used', false)
          .single();
        
        if (error) {
          console.log('Invalid coupon:', error);
          return false;
        }
        
        // Check if coupon is expired
        const now = new Date();
        const expiresAt = new Date(coupon.expires_at);
        
        if (now > expiresAt) {
          console.log('Coupon expired');
          return false;
        }
        
        // Calculate discount based on coupon type
        let discount = 0;
        if (coupon.type === 'percentage') {
          const subtotal = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
          discount = (subtotal * coupon.amount) / 100;
        } else {
          discount = coupon.amount;
        }
        
        state.couponCode = coupon.code;
        state.discount = discount;
        state.appliedPromoCode = coupon;
        
        // Save coupon to localStorage
        localStorage.setItem('ss_coupon', JSON.stringify({
          code: coupon.code,
          discount: discount,
          coupon_data: coupon
        }));
        
        updateOrderSummary();
        return true;
        
      } catch (error) {
        console.error('Error applying coupon:', error);
        return false;
      }
    }
    
    // Apply promo code from input
    async function applyPromoCode() {
      const code = elements.promoCodeInput.value.trim();
      if (!code) {
        showPromoMessage('Please enter a promo code', 'error');
        return;
      }
      
      const success = await applyCoupon(code);
      if (success) {
        showPromoMessage(`Promo code applied! Discount: ${formatCurrency(state.discount)}`, 'success');
        elements.promoCodeInput.value = '';
      } else {
        showPromoMessage('Invalid or expired promo code', 'error');
      }
    }
	
	// Secure checkout validation
async function validateCheckout() {
    try {
        if (state.cart.length === 0) {
            throw new Error('Your cart is empty');
        }
        
        // Send cart to server for validation
        const response = await fetch('/.netlify/functions/validate-cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                cartItems: state.cart,
                userId: state.user?.id
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to validate cart');
        }
        
        const result = await response.json();
        
        if (result.hasChanges) {
            // Update cart with validated data
            state.cart = result.validatedCart;
            updateOrderSummary();
            
            // Show notification to user
            showNotification('Cart updated with current prices and availability', 'info');
        }
        
        return result.validatedCart;
        
    } catch (error) {
        console.error('Checkout validation error:', error);
        throw error;
    }
}

    
    // Show promo code message
    function showPromoMessage(message, type) {
      elements.promoMessage.textContent = message;
      elements.promoMessage.className = 'promo-message ' + type;
    }
    
    // Show empty cart message
    function showEmptyCart() {
      elements.orderItems.innerHTML = `
        <div class="text-center text-muted" style="padding: 40px;">
          <p>Your cart is empty.</p>
          <a href="index.html" class="btn" style="margin-top: 15px;">Continue shopping</a>
        </div>
      `;
      elements.subtotalAmount.textContent = formatCurrency(0);
      elements.totalAmount.textContent = formatCurrency(0);
    }
    
    // Update order summary
    function updateOrderSummary() {
      if (state.cart.length === 0) {
        showEmptyCart();
        return;
      }
      
      let subtotal = 0;
      let itemsHTML = '';
      
      state.cart.forEach((item, index) => {
        const itemTotal = (item.price || 0) * (item.quantity || 1);
        subtotal += itemTotal;
        
        itemsHTML += `
          <div class="order-item">
            <div class="item-image">
              <img src="${item.image || 'https://via.placeholder.com/80x80?text=Product'}" alt="${item.name}" onerror="this.src='https://via.placeholder.com/80x80?text=Product'">
            </div>
            <div class="item-details">
              <div class="item-title">${item.name}</div>
              <div class="item-variant">Size: ${item.size || 'One Size'} ‚Ä¢ Qty: ${item.quantity}</div>
              <div class="item-price">${formatCurrency(itemTotal)}</div>
            </div>
          </div>
        `;
      });
      
      elements.orderItems.innerHTML = itemsHTML;
      
      // Update shipping and total
      updateShippingAndTotal(subtotal);
    }
    
    // Update shipping and total
    function updateShippingAndTotal(subtotal) {
      if (typeof subtotal !== 'number') {
        subtotal = 0;
        state.cart.forEach(item => {
          subtotal += (item.price || 0) * (item.quantity || 1);
        });
      }
      
      const shipping = state.selectedProvince ? calculateShipping(state.selectedProvince) : 0;
      const discount = state.discount || 0;
      const total = Math.max(0, subtotal - discount + shipping);
      state.orderTotal = total;
      
      elements.subtotalAmount.textContent = formatCurrency(subtotal);
      elements.shippingAmount.textContent = state.selectedProvince ? formatCurrency(shipping) : 'Select province';
      
      // Update discount display
      if (discount > 0 && state.couponCode) {
        elements.discountRow.classList.remove('hidden');
        elements.discountAmount.textContent = `-${formatCurrency(discount)}`;
        elements.discountRow.innerHTML = `<span>Discount (${state.couponCode})</span> <span>-${formatCurrency(discount)}</span>`;
      } else {
        elements.discountRow.classList.add('hidden');
      }
      
      elements.totalAmount.textContent = formatCurrency(total);
    }
    
    /********************
     * SHIPPING MANAGEMENT
     ********************/
    
    // Select province
    function selectProvince(province) {
      state.selectedProvince = province;
      elements.shippingCost.value = SHIPPING_COSTS[province] || 0;
      updateShippingAndTotal();
    }
    
    /********************
     * CHECKOUT FLOW
     ********************/
    
    // Validate shipping form - ADD THIS FUNCTION
function validateShippingForm() {
    const requiredFields = [
        { element: elements.firstName, name: 'First Name' },
        { element: elements.lastName, name: 'Last Name' },
        { element: elements.customerEmail, name: 'Email Address' },
        { element: elements.phoneNumber, name: 'Phone Number' },
        { element: elements.shippingAddress, name: 'Shipping Address' },
        { element: elements.city, name: 'City' },
        { element: elements.postalCode, name: 'Postal Code' },
        { element: elements.provinceSelect, name: 'Province' }
    ];
    
    for (const field of requiredFields) {
        if (!field.element.value.trim()) {
            alert(`Please fill in the ${field.name} field.`);
            field.element.focus();
            return false;
        }
    }
    
    if (!isValidEmail(elements.customerEmail.value)) {
        alert('Please enter a valid email address.');
        elements.customerEmail.focus();
        return false;
    }
    
    if (!isValidPhone(elements.phoneNumber.value)) {
        alert('Please enter a valid South African phone number (e.g., 0821234567 or +27821234567).');
        elements.phoneNumber.focus();
        return false;
    }
    
    return true;
}
    
 // Save shipping information - ADD THIS FUNCTION
async function saveShippingInfo() {
    try {
        state.shippingInfo = {
            firstName: elements.firstName.value.trim(),
            lastName: elements.lastName.value.trim(),
            email: elements.customerEmail.value.trim(),
            phone: elements.phoneNumber.value.trim(),
            address: elements.shippingAddress.value.trim(),
            city: elements.city.value.trim(),
            postalCode: elements.postalCode.value.trim(),
            province: elements.provinceSelect.value,
            shippingCost: parseFloat(elements.shippingCost.value),
            instructions: elements.deliveryInstructions.value.trim()
        };
        
        // Update user profile in Supabase if logged in
        if (supabaseClient && state.user && state.profile) {
            const { error } = await supabaseClient
                .from('profiles')
                .update({
                    first_name: state.shippingInfo.firstName,
                    last_name: state.shippingInfo.lastName,
                    phone: state.shippingInfo.phone,
                    address: state.shippingInfo.address,
                    city: state.shippingInfo.city,
                    postal_code: state.shippingInfo.postalCode,
                    province: state.shippingInfo.province
                })
                .eq('id', state.profile.id);
            
            if (error) {
                console.error('Error updating profile:', error);
            }
        }
        
        return true;
    } catch (error) {
        console.error('Error saving shipping info:', error);
        return false;
    }
}

 // Show notification - ADD THIS FUNCTION
function showNotification(message, type = 'info') {
    // Remove existing notification
    const existingNotification = document.querySelector('.notification-toast');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // Create new notification
    const notification = document.createElement('div');
    notification.className = `notification-toast notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        background: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#007bff'};
        color: white;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
        max-width: 400px;
        font-size: 14px;
    `;
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}  

   
    // Go to step
    function goToStep(step) {
      elements.steps.forEach(s => {
        s.classList.remove('active', 'completed');
      });
      
      let stepReached = false;
      elements.steps.forEach(s => {
        if (s.dataset.step === step) {
          s.classList.add('active');
          stepReached = true;
        } else if (step === 'confirmation' && s.dataset.step !== 'confirmation') {
          s.classList.add('completed');
        } else if (step === 'payment' && s.dataset.step === 'shipping') {
          s.classList.add('completed');
        }
      });
      
      elements.shippingSection.classList.add('hidden');
      elements.paymentSection.classList.add('hidden');
      elements.confirmationSection.classList.add('hidden');
      
      if (step === 'shipping') {
        elements.shippingSection.classList.remove('hidden');
      } else if (step === 'payment') {
        elements.paymentSection.classList.remove('hidden');
      } else if (step === 'confirmation') {
        elements.confirmationSection.classList.remove('hidden');
      }
      
      state.currentStep = step;
    }
    
    /********************
     * PAYFAST INTEGRATION
     ********************/
    
    
// submitToPayFast: request a server-generated signature and submit the PayFast form
async function submitToPayFast(cartItems, orderId, total) {
  if (!state.configLoaded) {
    throw new Error('Configuration not loaded. Please refresh the page.');
  }

  // Build the payload to send to the serverless function.
  // IMPORTANT: do NOT include merchant_key (secret) here.
  const payload = {
    // public / non-secret fields only:
    m_payment_id: String(orderId).substring(0, 100),
    amount: parseFloat(total).toFixed(2),
    item_name: cartItems.length === 1 ? (cartItems[0].name || '') : `${cartItems.length} items from Umzila Store`,
    item_description: cartItems.length === 1 ? (cartItems[0].name || '') : `${cartItems.length} items from Umzila Store`,
    return_url: `${CONFIG.siteUrl}/checkout-success.html?m_payment_id=${orderId}&order_id=${state.orderId || ''}`,
    cancel_url: `${CONFIG.siteUrl}/checkout-cancel.html?m_payment_id=${orderId}`,
    notify_url: `${CONFIG.siteUrl}/.netlify/functions/payfast-itn`,
    name_first: (state.shippingInfo?.firstName || '').substring(0, 100),
    name_last: (state.shippingInfo?.lastName || '').substring(0, 100),
    email_address: (state.shippingInfo?.email || '').substring(0, 100),
    cell_number: (state.shippingInfo?.phone || '').replace(/\D/g, '').substring(0, 100),
    email_confirmation: '1',
    confirmation_address: (state.shippingInfo?.email || '').substring(0, 100)
    // add custom_strX / custom_intX here if you want the server to sign them
  };

  // Call your Netlify function to generate signature + final params
  const res = await fetch('/.netlify/functions/generate-payfast-signature', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ payload, returnForm: false })
  });

  if (!res.ok) {
    // show server response text to help debugging (strip in production)
    const errText = await res.text();
    console.error('generate-payfast-signature error:', errText);
    throw new Error('Failed to obtain signed PayFast parameters.');
  }

  const json = await res.json();

  // Server must return an object that includes:
  // { actionUrl, params }  where params is a key/value map of values to submit.
  // If your function returns pfHost or actionUrl, use that. We'll fallback sensibly.
  const actionUrl = json.actionUrl || (json.pfHost ? `https://${json.pfHost}/eng/process` : (CONFIG.payfastSandbox ? 'https://sandbox.payfast.co.za/eng/process' : 'https://www.payfast.co.za/eng/process'));
  const params = json.params || json; // tolerate different shapes for older functions

  // Build and submit the form in the same page
  const form = document.createElement('form');
  form.method = 'post';
  form.action = actionUrl;
  form.style.display = 'none';

  // Append parameters as hidden inputs (only keys with non-empty values)
  Object.entries(params).forEach(([key, value]) => {
  if (value === undefined || value === null || String(value).trim() === '') return;
  const input = document.createElement('input');
  input.type = 'hidden';
  input.name = key;
  input.value = String(value);
  form.appendChild(input);
});


  document.body.appendChild(form);
  form.submit();
}

    
    async function processPayment() {
    try {
        // Validate form
        if (!elements.termsAgreement.checked) {
            showError(elements.paymentError, 'You must agree to the Terms & Conditions.');
            return;
        }
        
        // Validate shipping form
        if (!validateShippingForm()) {
            return;
        }
        
        // Save shipping info
        if (!state.shippingInfo) {
            await saveShippingInfo();
        }
        
        // Disable button during processing
        elements.payNowBtn.disabled = true;
        elements.payNowBtn.textContent = 'Processing...';
        
        // Server-side cart validation
        const validatedCart = await validateCheckout();
        
        if (validatedCart.length === 0) {
            showError(elements.paymentError, 'Your cart is empty or items are out of stock.');
            elements.payNowBtn.disabled = false;
            elements.payNowBtn.textContent = 'Pay Now';
            return;
        }
        
        // Generate order ID
        const orderId = `UMZILA-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        
        // Calculate totals based on validated cart
        const subtotal = validatedCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const shipping = state.shippingInfo?.shippingCost || 0;
        const discount = state.discount || 0;
        const total = Math.max(0, subtotal - discount + shipping);
        
        // Save order to Supabase before payment
        if (supabaseClient) {
            const orderData = {
                user_id: state.user?.id || null,
                profile_id: state.profile?.id || null,
                customer_email: state.shippingInfo.email,
                customer_name: `${state.shippingInfo.firstName} ${state.shippingInfo.lastName}`,
                customer_phone: state.shippingInfo.phone,
                delivery_address: state.shippingInfo.address,
                city: state.shippingInfo.city,
                province: state.shippingInfo.province,
                postal_code: state.shippingInfo.postalCode,
                items: validatedCart,
                total: total,
                discount: discount,
                shipping_cost: shipping,
                order_status: 'pending',
                order_number: orderId,
                m_payment_id: orderId,
                label: state.shippingInfo.label || 'Standard Delivery',
                notes: elements.orderNotes.value.trim() || ''
            };
            
            const { data: order, error } = await supabaseClient
                .from('orders')
                .insert([orderData])
                .select()
                .single();
                
            if (error) {
                console.error('Error saving order:', error);
                throw new Error('Failed to create order. Please try again.');
            }
            
            state.orderId = order.id;
            
            // Update coupon as used if one was applied
            if (state.appliedPromoCode) {
                await supabaseClient
                    .from('discount_codes')
                    .update({ used: true })
                    .eq('id', state.appliedPromoCode.id);
            }
        }
        
        // Clear cart after successful order creation
        if (supabaseClient && state.user) {
            await supabaseClient
                .from('carts')
                .delete()
                .eq('user_id', state.user.id);
        }
        localStorage.removeItem('ss_cart');
        localStorage.removeItem('ss_coupon');
        
        // Generate PayFast parameters
        await submitToPayFast(validatedCart, orderId, total);
        
    } catch (error) {
        console.error('Payment processing error:', error);
        showError(elements.paymentError, error.message || 'Payment processing failed. Please try again.');
        elements.payNowBtn.disabled = false;
        elements.payNowBtn.textContent = 'Pay Now';
    }
}
    
    /********************
     * CONTINUE INITIALIZATION
     ********************/
    
    async function continueInitialization() {
      try {
        await loadCart();
        
        // Check authentication
        const isAuthenticated = await checkAuth();
        
        if (!isAuthenticated) {
          // Show auth modal if not logged in
          showAuthModal();
        }
        
        // Hide loading state
        elements.loadingState.classList.add('hidden');
        elements.shippingSection.classList.remove('hidden');
        
        // Check for successful payment return
        checkPaymentStatus();
        
      } catch (error) {
        console.error('Initialization error:', error);
        elements.loadingState.classList.add('hidden');
        elements.shippingSection.classList.remove('hidden');
      }
    }
    
    // Check payment status from URL
    function checkPaymentStatus() {
      const urlParams = new URLSearchParams(window.location.search);
      const paymentStatus = urlParams.get('payment_status');
      const mPaymentId = urlParams.get('m_payment_id');
      
      if (paymentStatus === 'COMPLETE' && mPaymentId) {
        goToStep('confirmation');
        elements.orderIdDisplay.textContent = mPaymentId;
        elements.confirmationEmail.textContent = state.user?.email || state.shippingInfo?.email || '';
      }
    }
    
    /********************
     * SETUP EVENT LISTENERS
     ********************/
    
    function setupEventListeners() {
      // Province select change
      elements.provinceSelect.addEventListener('change', (e) => {
        selectProvince(e.target.value);
      });
      
      // Continue to payment button
      elements.continueToPayment.addEventListener('click', (e) => {
        e.preventDefault();
        
        if (!validateShippingForm()) return;
        
        saveShippingInfo();
        goToStep('payment');
      });
      
      // Pay now button
      elements.payNowBtn.addEventListener('click', (e) => {
        e.preventDefault();
        processPayment();
      });
      
      // Apply promo code button
      elements.applyPromoCode.addEventListener('click', applyPromoCode);
      
      // Edit buttons
      document.getElementById('editShipping')?.addEventListener('click', () => goToStep('shipping'));
      document.getElementById('editPayment')?.addEventListener('click', () => goToStep('payment'));
      
      // View order button
      elements.viewOrderBtn.addEventListener('click', () => {
        const lastOrder = localStorage.getItem('last_order');
        if (lastOrder) {
          const order = JSON.parse(lastOrder);
          window.location.href = `order.html?id=${order.orderId}`;
        }
      });
      
      // Authentication
      elements.authBtn.addEventListener('click', showAuthModal);
      elements.closeAuthModal.addEventListener('click', hideAuthModal);
      elements.authModal.addEventListener('click', (e) => {
        if (e.target === elements.authModal) {
          hideAuthModal();
        }
      });
      
      // Auth tabs
      elements.authTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          elements.authTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          elements.loginForm.classList.toggle('active', tab.dataset.tab === 'login');
          elements.signupForm.classList.toggle('active', tab.dataset.tab === 'signup');
        });
      });
      
      // Login
      elements.loginSubmit.addEventListener('click', async () => {
        const email = elements.loginEmail.value.trim();
        const password = elements.loginPassword.value;
        
        if (!email || !password) {
          showError(elements.loginError, 'Please enter both email and password.');
          return;
        }
        
        if (!isValidEmail(email)) {
          showError(elements.loginError, 'Please enter a valid email address.');
          return;
        }
        
        try {
          if (supabaseClient) {
            const { data, error } = await supabaseClient.auth.signInWithPassword({
              email,
              password
            });
            
            if (error) throw error;
            
            state.user = data.user;
            await verifyUserProfile(data.user.id);
            elements.customerEmail.value = state.user.email;
            updateAuthUI();
            hideAuthModal();
          }
        } catch (error) {
          showError(elements.loginError, error.message || 'Login failed.');
        }
      });
      
      // Signup
      elements.signupSubmit.addEventListener('click', async () => {
        const name = elements.signupName.value.trim();
        const email = elements.signupEmail.value.trim();
        const password = elements.signupPassword.value;
        
        if (!name || !email || !password) {
          showError(elements.signupError, 'Please complete all fields.');
          return;
        }
        
        if (!isValidEmail(email)) {
          showError(elements.signupError, 'Please enter a valid email address.');
          return;
        }
        
        try {
          if (supabaseClient) {
            const { data, error } = await supabaseClient.auth.signUp({
              email,
              password,
              options: {
                data: {
                  full_name: name
                }
              }
            });
            
            if (error) throw error;
            
            state.user = data.user;
            await verifyUserProfile(data.user.id);
            elements.customerEmail.value = state.user.email;
            updateAuthUI();
            hideAuthModal();
            
            showError(elements.signupError, 'Account created! Please check your email for verification.');
            elements.signupError.style.color = 'green';
          }
        } catch (error) {
          showError(elements.signupError, error.message || 'Signup failed.');
        }
      });
      
      // Forgot password
      elements.forgotPassword.addEventListener('click', () => {
        const email = elements.loginEmail.value.trim();
        if (email && supabaseClient) {
          supabaseClient.auth.resetPasswordForEmail(email, {
            redirectTo: `${CONFIG.siteUrl}/reset-password.html`
          }).then(() => {
            alert('Password reset email sent! Check your inbox.');
          });
        } else {
          alert('Please enter your email address first.');
        }
      });
      
      // Enter key for promo code
      elements.promoCodeInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          applyPromoCode();
        }
      });
    }
    
    /********************
     * INITIALIZE
     ********************/
    
    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      fetchConfiguration();
    });
  </script>
</body>
</html>