<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Reset Password</title>

<style>
  body {
    background: #f7f7f9;
    font-family: Inter, sans-serif;
  }

  .reset-box {
    max-width: 420px;
    margin: 80px auto;
    background: #fff;
    padding: 28px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.06);
  }

  .reset-box h2 {
    margin-bottom: 16px;
    color: #0a2f66;
    font-weight: 700;
  }

  input {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #d9d9df;
    margin-bottom: 14px;
    font-size: 15px;
  }

  button {
    width: 100%;
    padding: 12px;
    background: #0a2f66;
    color: #fff;
    border-radius: 10px;
    border: none;
    font-weight: 700;
    cursor: pointer;
    margin-top: 5px;
  }

  #resetStatus {
    margin-top: 14px;
    font-size: 14px;
  }
</style>

<!-- Supabase initialization via Netlify function -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

<script>
(async function initSupabaseClient(){
  try {
    const res = await fetch('/.netlify/functions/get-client-config');
    if (!res.ok) {
      console.error('Failed to load Supabase config', res.status, await res.text());
      return;
    }
    const cfg = await res.json();

    if (!cfg.SUPABASE_URL || !cfg.SUPABASE_ANON_KEY) {
      console.error('Missing Supabase config from server');
      return;
    }

    // Initialize Supabase client
    const supabaseClient = supabase.createClient(cfg.SUPABASE_URL, cfg.SUPABASE_ANON_KEY);
    window.supabase = supabaseClient; // make it accessible globally

    // Optional: notify other scripts that Supabase is ready
    document.dispatchEvent(new CustomEvent('supabase-ready', { detail: { supabase: supabaseClient } }));
    console.log('Supabase client initialized');
  } catch (err) {
    console.error('Error initializing Supabase client', err);
  }
})();
</script>
</head>

<body>

<div class="reset-box">
  <h2>Reset Your Password</h2>

  <input id="newPassword" type="password" placeholder="New password" />
  <button id="resetBtn">Reset Password</button>

  <div id="resetStatus"></div>
</div>

<script>
  // Wait for Supabase to be initialized
  document.addEventListener('supabase-ready', function(event) {
    const client = event.detail.supabase;
    
    const newPasswordInput = document.getElementById("newPassword");
    const resetBtn = document.getElementById("resetBtn");
    const statusBox = document.getElementById("resetStatus");

    // 1. Detect session from reset link (#access_token)
    async function checkSessionFromUrl() {
      const { data, error } = await client.auth.getSession();

      if (!data?.session) {
        statusBox.textContent = "Invalid or expired reset link.";
        statusBox.style.color = "red";
        resetBtn.disabled = true;
        return false;
      }

      return true;
    }

    resetBtn.addEventListener("click", async () => {
      const ok = await checkSessionFromUrl();
      if (!ok) return;

      const newPassword = newPasswordInput.value.trim();

      if (!newPassword || newPassword.length < 6) {
        statusBox.textContent = "Password must be at least 6 characters.";
        statusBox.style.color = "red";
        return;
      }

      statusBox.textContent = "Updating password...";
      statusBox.style.color = "#0a2f66";

      const { data, error } = await client.auth.updateUser({
        password: newPassword
      });

      if (error) {
        statusBox.textContent = error.message;
        statusBox.style.color = "red";
        return;
      }

      statusBox.textContent = "Password updated! Redirecting...";
      statusBox.style.color = "green";

      setTimeout(() => {
        window.location.href = "/login.html";
      }, 2000);
    });

    checkSessionFromUrl();
  });

  // Fallback in case Supabase initialization takes time or fails
  setTimeout(() => {
    if (!window.supabase) {
      const statusBox = document.getElementById("resetStatus");
      if (statusBox) {
        statusBox.textContent = "Failed to initialize. Please refresh the page.";
        statusBox.style.color = "red";
      }
    }
  }, 3000);
</script>

</body>
</html>