<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Umzila ‚Äî Student Streetwear Marketplace</title>
  <style>
    /* ---------- BASE / RESET ---------- */
    :root{
      --bg:#f7f7f9;
      --card:#ffffff;
      --muted:#6b6b74;
      --accent:#0a2f66;
      --accent-2:#00a0ff;
      --cta:#ff6b2c;
      --success:#28a745;
      --shadow: 0 6px 18px rgba(11,13,20,0.08);
      --glass: rgba(255,255,255,0.6);
      --sidebar-w: 220px; /* central sidebar width variable */
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter, "Segoe UI", Roboto, system-ui, -apple-system, Arial, sans-serif}
    html,body{height:100%;background:var(--bg);color:#111}
    body{overflow-x:hidden;}
    a{color:inherit;text-decoration:none}
    img{display:block;max-width:100%}
    button{font-family:inherit}
    
    /* ---------- MOBILE SPECIFIC VARIABLES ---------- */
    :root {
      --mobile-breakpoint: 768px;
    }
    
    /* ---------- LAYOUT ---------- */
    header{
      position:sticky;top:0;z-index:1100;
      background:linear-gradient(180deg,rgba(255,255,255,0.8),rgba(255,255,255,0.95));
      backdrop-filter: blur(4px);
      box-shadow: 0 2px 8px rgba(10,15,30,0.04);
      padding:10px 18px;display:flex;align-items:center;gap:16px;
    }
    
    /* Mobile header adjustments - MORE SPACING */
    @media (max-width: 768px) {
      header {
        padding: 12px 16px;
        gap: 12px;
      }
    }
    
    .container{max-width:1200px;margin:0 auto;width:100%}
    .header-inner{display:flex;align-items:center;gap:14px;width:100%}
    
    /* Mobile header inner adjustments - REORDERED FOR MOBILE */
    @media (max-width: 768px) {
      .header-inner {
        gap: 12px;
        justify-content: space-between;
        flex-wrap: nowrap;
      }
    }
    
    .logo{display:flex;align-items:center;gap:10px}
    .logo img{height:68px;width:auto;border-radius:6px;object-fit:cover}
    .logo .brand{display:none} /* removed StreetSale text as requested */

    /* Mobile logo adjustments */
    @media (max-width: 768px) {
      .logo img {
        height: 48px;
        order: 1; /* Logo comes after hamburger */
        margin-left: 8px;
      }
    }

    /* left hamburger (header) - HIDE ON MOBILE (now replaced by mobile-menu-icon) */
    .left-hamburger{
      background:transparent;border:1px solid transparent;padding:8px 10px;border-radius:8px;cursor:pointer;font-size:18px;
      display:flex;align-items:center;justify-content:center;margin-right:6px;
    }

    @media (max-width: 768px) {
      .left-hamburger {
        display: none !important; /* HIDE ON MOBILE */
      }
    }

    /* about link next to logo */
    .about-link{font-size:14px;color:var(--muted);margin-left:6px}
    
    /* Hide about link on mobile - it's in hamburger menu */
    @media (max-width: 768px) {
      .about-link {
        display: none;
      }
    }

    /* search bar */
    .search-bar{flex:1;position:relative;max-width:700px}
    
    /* Mobile search bar adjustments */
    @media (max-width: 768px) {
      .search-bar {
        display: none; /* Hidden by default on mobile */
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        max-width: 100%;
        background: white;
        padding: 12px;
        z-index: 1101;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      .search-bar.mobile-active {
        display: flex;
      }
    }
    
    .search-input{
      width:100%;padding:10px 36px 10px 14px;border-radius:999px;border:1px solid #e3e3e8;
      box-shadow:0 1px 2px rgba(0,0,0,0.03);font-size:14px;
      transition:box-shadow .18s, border-color .18s;
    }
    
    /* Mobile search input */
    @media (max-width: 768px) {
      .search-input {
        padding: 12px 40px 12px 16px;
        font-size: 16px;
      }
    }
    
    .search-input:focus{outline:none;border-color:var(--accent);box-shadow:0 6px 20px rgba(10,47,102,0.06)}
    .search-suggestions{
      position:absolute;left:0;right:0;background:#fff;border:1px solid #e9e9ee;border-radius:8px;margin-top:8px;box-shadow:var(--shadow);
      display:none;max-height:240px;overflow:auto;z-index:1200;
    }
    .search-suggestions div{padding:10px 12px;cursor:pointer}
    .search-suggestions div:hover{background:#f5f6fb}
    .search-clear{
      position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:none;font-size:16px;cursor:pointer;display:none;padding:6px;border-radius:6px
    }
    
    /* Mobile search clear button */
    @media (max-width: 768px) {
      .search-clear {
        right: 12px;
        font-size: 18px;
      }
    }
    
    /* Mobile search icon */
    .mobile-search-icon {
      display: none;
      background: transparent;
      border: none;
      padding: 8px;
      font-size: 18px;
      cursor: pointer;
      margin-right: 8px;
    }
    
    @media (max-width: 768px) {
      .mobile-search-icon {
        display: block;
        order: 2; /* Place after logo */
      }
      
      /* Mobile search close button */
      .mobile-search-close {
        background: transparent;
        border: none;
        font-size: 24px;
        padding: 4px 8px;
        margin-left: 8px;
        cursor: pointer;
      }
    }

    /* header right - UPDATED FOR MOBILE SPACING */
    .header-right{display:flex;gap:12px;align-items:center}
    
    /* Mobile header right adjustments - REORDERED */
    @media (max-width: 768px) {
      .header-right {
        gap: 8px;
        flex-shrink: 0;
        order: 3; /* Place at the end */
        margin-left: auto;
      }
      
      /* Mobile hamburger menu icon - MOVED TO FAR LEFT */
      .mobile-menu-icon {
        display: block !important;
        background: transparent;
        border: none;
        font-size: 20px;
        padding: 8px;
        order: 0; /* First item on mobile */
        margin-right: 4px;
      }
      
      /* Ensure cart is on far right on mobile */
      .cart {
        margin-left: auto;
      }
    }
    
    .btn{padding:8px 14px;border-radius:999px;border:none;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid #e6e6ea}
    
    /* Mobile button adjustments */
    @media (max-width: 768px) {
      .btn {
        padding: 8px 12px;
        font-size: 14px;
      }
      .btn.ghost {
        padding: 7px 11px;
      }
    }
    
    .icon-btn{background:transparent;border:1px solid transparent;padding:8px;border-radius:8px;cursor:pointer}
    .cart{position:relative;font-size:18px;cursor:pointer}
    
    /* Mobile cart adjustments */
    @media (max-width: 768px) {
      .cart {
        font-size: 20px;
        order: 3; /* Ensures cart is on far right */
      }
    }
    
    .cart-count{
      position:absolute;top:-6px;right:-6px;background:var(--accent-2);color:#fff;padding:2px 6px;border-radius:999px;font-size:12px;font-weight:700;
    }
    /* Mini cart removed - redirecting directly to checkout.html */

    /* ---------- MAIN LAYOUT ---------- */
    .layout{display:flex;gap:18px;max-width:1200px;margin:16px auto;padding:0 18px;align-items:flex-start;overflow:hidden}
    
    /* Mobile layout adjustments */
    @media (max-width: 768px) {
      .layout {
        padding: 0 12px;
        margin: 12px auto;
        flex-direction: column;
      }
    }

    /* SIDEBAR: now fixed to leftmost viewport and no horizontal scroll */
    .sidebar{
      --w:var(--sidebar-w);
      position:fixed;left:0;top:86px; /* sits under header */
      width:var(--w);height:calc(100vh - 86px);z-index:1200;
      background:var(--card);border-radius:0 10px 10px 0;padding:14px;box-shadow:var(--shadow);
      overflow-y:auto;overflow-x:hidden; /* strictly NO horizontal scroll */
      transition:transform .28s ease, width .2s ease, opacity .18s ease;
      will-change:transform,width,opacity;
      display:flex;flex-direction:column;gap:12px;
    }
    
    /* Mobile sidebar - hidden by default */
    @media (max-width: 768px) {
      .sidebar {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        border-radius: 0;
        z-index: 2000;
        background: var(--card);
        padding: 20px;
        overflow-y: auto;
      }
      
      .sidebar.mobile-active {
        display: flex;
      }
    }

    /* collapsed state -> hide off-canvas left by full width */
    .sidebar.collapsed{
      transform:translateX(calc(-1 * var(--w)));opacity:0;pointer-events:none;
    }

    .sidebar h3{color:var(--accent);margin-bottom:10px}
    .categories ul{list-style:none;padding:0;margin:0}
    .categories li{padding:8px 6px;border-radius:6px;cursor:pointer;color:#333;font-weight:600}
    .categories li:hover,.categories li.active{background:linear-gradient(90deg,var(--accent-2),#bfeaff);color:var(--accent)}
    .filter-section{margin-top:14px}
    .filter-section label{display:block;font-size:13px;margin:8px 0;color:var(--muted)}
    .price-range{display:flex;gap:8px;align-items:center}
    input[type="range"]{width:100%}

    /* hide the in-sidebar 'x' close control (user requested removal) */
    #collapseSidebar{display:none}
    
    /* Mobile sidebar close button */
    .mobile-sidebar-close {
      display: none;
      background: transparent;
      border: none;
      font-size: 24px;
      position: absolute;
      top: 16px;
      right: 16px;
      cursor: pointer;
    }
    
    @media (max-width: 768px) {
      .mobile-sidebar-close {
        display: block;
      }
    }

    /* show/hide button removed to avoid duplicate hamburger */
    #showSidebarBtn{display:none !important}

    /* main content: when sidebar open we offset with margin-left; when closed margin-left:0 */
    main{
      margin-left:var(--sidebar-w);
      transition:margin-left .28s ease,width .28s ease;
      width:calc(100% - var(--sidebar-w));min-width:0;
    }
    main.full{
      margin-left:0;width:100%;
    }
    
    /* Mobile main content */
    @media (max-width: 768px) {
      main {
        margin-left: 0;
        width: 100%;
      }
    }

    .breadcrumb{font-size:13px;color:var(--muted);margin-bottom:12px}
    /* hero */
    .hero{position:relative;border-radius:12px;overflow:hidden;min-height:340px;background:#ddd}
    
    /* Mobile hero adjustments */
    @media (max-width: 768px) {
      .hero {
        min-height: 280px;
        border-radius: 10px;
        margin-top: 8px;
      }
    }
    
    .hero .slides{display:flex;transition:transform .6s ease;will-change:transform}
    .hero .slide{min-width:100%;position:relative;height:340px;display:flex;align-items:center;justify-content:center;background-size:cover;background-position:center}
    
    /* Mobile slide adjustments */
    @media (max-width: 768px) {
      .hero .slide {
        height: 280px;
      }
    }
    
    .hero .slide .overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(8,8,10,0.04),rgba(8,8,10,0.15))}
    .hero .content{position:relative;z-index:2;color:#fff;padding:20px;text-align:left;max-width:700px}
    
    /* Mobile hero content */
    @media (max-width: 768px) {
      .hero .content {
        padding: 16px;
        max-width: 90%;
      }
    }
    
    .hero h1{font-size:28px;margin-bottom:8px;text-shadow:0 4px 18px rgba(0,0,0,0.25)}
    
    /* Mobile hero h1 */
    @media (max-width: 768px) {
      .hero h1 {
        font-size: 22px;
        margin-bottom: 6px;
      }
    }
    
    .hero p{font-size:15px;margin-bottom:12px}
    
    /* Mobile hero p */
    @media (max-width: 768px) {
      .hero p {
        font-size: 14px;
        margin-bottom: 10px;
      }
    }
    
    .hero .cta{display:inline-block;padding:10px 18px;border-radius:999px;background:var(--cta);color:#fff;font-weight:700;cursor:pointer}
    
    /* Mobile hero cta */
    @media (max-width: 768px) {
      .hero .cta {
        padding: 8px 16px;
        font-size: 14px;
      }
    }
    
    .hero .nav{position:absolute;left:18px;right:18px;bottom:14px;display:flex;align-items:center;justify-content:space-between;z-index:3}
    .hero .dots{display:flex;gap:6px}
    .dot{width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,0.45);cursor:pointer}
    .dot.active{background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.12)}
    .hero .arrows{display:flex;gap:8px}
    .arrow-btn{background:rgba(255,255,255,0.15);backdrop-filter: blur(4px);border-radius:8px;padding:6px 8px;color:#fff;border:none;cursor:pointer}

    /* sections */
    section{margin-top:18px}
    
    /* Mobile section adjustments */
    @media (max-width: 768px) {
      section {
        margin-top: 20px;
      }
    }
    
    section h2{display:flex;justify-content:space-between;align-items:center;font-size:18px;color:var(--accent);margin-bottom:10px}
    
    /* Mobile section h2 */
    @media (max-width: 768px) {
      section h2 {
        font-size: 16px;
        margin-bottom: 12px;
      }
    }
    
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
    
    /* MOBILE GRID: 2 products per row */
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: repeat(2,1fr);
        gap: 12px;
      }
    }
    
    @media (max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:780px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:520px){.grid{grid-template-columns:1fr}}

    .product-card{background:var(--card);border-radius:12px;padding:10px;box-shadow:0 4px 12px rgba(12,16,25,0.04);overflow:hidden;position:relative;transition:transform .18s,box-shadow .18s}
    .product-card:hover{transform:translateY(-6px);box-shadow:0 10px 30px rgba(12,16,25,0.07)}
    .product-media{position:relative;border-radius:8px;overflow:hidden;height:180px}
    
    /* Mobile product media */
    @media (max-width: 768px) {
      .product-media {
        height: 160px;
      }
    }
    
    .product-media img{width:100%;height:100%;object-fit:cover;transition:opacity .25s}
    .product-media img.secondary{position:absolute;inset:0;opacity:0}
    .product-card:hover .product-media img.secondary{opacity:1}
    .badges{position:absolute;top:10px;left:10px;display:flex;gap:6px;z-index:4}
    .badge{background:var(--accent-2);color:#fff;padding:5px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .badge.sale{background:#ff6b2c;}
    .card-body{padding-top:8px;display:flex;flex-direction:column;gap:8px}
    .title{font-weight:700;font-size:15px;color:#222}
    
    /* Mobile title */
    @media (max-width: 768px) {
      .title {
        font-size: 14px;
      }
    }
    
    .meta{font-size:13px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    
    /* Mobile meta */
    @media (max-width: 768px) {
      .meta {
        font-size: 12px;
      }
    }
    
    .price{font-weight:800;color:var(--cta);font-size:16px}
    .price .original{text-decoration:line-through;color:#9ca3af;font-size:13px;font-weight:normal;margin-right:5px}
    
    /* Mobile price */
    @media (max-width: 768px) {
      .price {
        font-size: 14px;
      }
    }
    
    .actions{display:flex;gap:8px;align-items:center}
    .quick-add{position:absolute;right:8px;bottom:50px;background:var(--accent);color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer;opacity:0;transform:translateY(8px);transition:all .18s}
    .product-card:hover .quick-add{opacity:1;transform:translateY(0)}
    .controls{display:flex;gap:8px;align-items:center}
    select.qty, .size-select{padding:6px;border-radius:8px;border:1px solid #eee;background:#fff}
    
    /* Mobile controls */
    @media (max-width: 768px) {
      .controls {
        gap: 6px;
      }
      
      select.qty, .size-select {
        padding: 4px;
        font-size: 12px;
      }
    }
    
    .add-btn{flex:1;padding:8px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    
    /* Mobile add button */
    @media (max-width: 768px) {
      .add-btn {
        padding: 6px;
        font-size: 12px;
      }
    }

    /* ===== UPDATED PRODUCT MODAL - REDESIGNED ===== */
    .product-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      padding: 20px;
    }
    
    .product-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .product-modal {
      background-color: #fff;
      border-radius: 16px;
      max-width: 1200px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      transform: translateY(30px);
      transition: transform 0.3s ease;
    }
    
    .product-modal-overlay.active .product-modal {
      transform: translateY(0);
    }
    
    .product-modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: #2d3748;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 10;
      transition: all 0.3s ease;
      border: none;
    }
    
    .product-modal-close:hover {
      background-color: #e63946;
    }
    
    .product-modal-content {
      display: flex;
      flex-wrap: wrap;
      min-height: 600px;
    }
    
    .product-modal-images {
      flex: 1;
      min-width: 300px;
      padding: 40px;
      background-color: #edf2f7;
    }
    
    .product-modal-main-image {
      width: 100%;
      height: 400px;
      overflow: hidden;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .product-modal-main-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .product-modal-thumbnails {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    
    .product-thumbnail {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }
    
    .product-thumbnail.active {
      border-color: #0a2f66;
    }
    
    .product-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .product-modal-details {
      flex: 1;
      min-width: 300px;
      padding: 40px;
    }
    
    .product-modal-title {
      font-size: 2.5rem;
      margin-bottom: 10px;
      color: #2d3748;
    }
    
    .product-modal-rating {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .product-modal-price {
      font-size: 2rem;
      font-weight: 700;
      color: #ff6b2c;
      margin-bottom: 20px;
    }
    
    .product-modal-original-price {
      text-decoration: line-through;
      color: #a0aec0;
      margin-left: 10px;
      font-size: 1.5rem;
    }
    
    .product-modal-sizes {
      margin-bottom: 25px;
    }
    
    .product-modal-sizes h3 {
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    
    .size-options {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .size-option {
      padding: 10px 20px;
      border: 1px solid #a0aec0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .size-option.selected {
      background-color: #0a2f66;
      color: white;
      border-color: #0a2f66;
    }
    
    .product-modal-colors {
      margin-bottom: 25px;
    }
    
    .product-modal-colors h3 {
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    
    .color-options {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }
    
    .color-option.selected {
      border-color: #2d3748;
      transform: scale(1.1);
    }
    
    .product-modal-quantity {
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .quantity-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .quantity-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid #a0aec0;
      background: white;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .quantity-value {
      font-size: 1.2rem;
      font-weight: 600;
      min-width: 30px;
      text-align: center;
    }
    
    .product-modal-add-to-cart {
      background-color: #2d3748;
      color: white;
      border: none;
      padding: 18px 40px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-bottom: 25px;
    }
    
    .product-modal-add-to-cart:hover {
      background-color: #0a2f66;
    }
    
    /* Bundle Suggestion Section */
    .bundle-suggestion {
      margin: 25px 0;
      padding: 20px;
      background-color: #edf2f7;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    
    .bundle-product-image {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .bundle-product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .bundle-info {
      flex: 1;
      min-width: 200px;
    }
    
    .bundle-title {
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .bundle-text {
      color: #4a5568;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }
    
    .bundle-button {
      background-color: #0a2f66;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .bundle-button:hover {
      background-color: #00a0ff;
    }
    
    .product-modal-description {
      margin-top: 30px;
      padding-top: 30px;
      border-top: 1px solid #edf2f7;
    }
    
    .product-modal-description h3 {
      margin-bottom: 15px;
      font-size: 1.3rem;
    }
    
    .description-text {
      line-height: 1.8;
      color: #4a5568;
      margin-bottom: 15px;
    }
    
    .description-text.collapsed {
      max-height: 120px;
      overflow: hidden;
      position: relative;
    }
    
    .description-text.collapsed::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: linear-gradient(transparent, white);
    }
    
    .see-more-btn {
      background: none;
      border: none;
      color: #00a0ff;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      padding: 0;
    }
    
    /* Mobile responsive for modal */
    @media (max-width: 992px) {
      .product-modal-content {
        flex-direction: column;
      }
      
      .product-modal-images {
        padding: 20px;
      }
      
      .product-modal-details {
        padding: 20px;
      }
      
      .product-modal-title {
        font-size: 2rem;
      }
      
      .product-modal-price {
        font-size: 1.5rem;
      }
    }
    
    @media (max-width: 768px) {
      .product-modal {
        width: 95%;
        max-height: 95vh;
      }
      
      .product-modal-main-image {
        height: 300px;
      }
    }

    /* horizontal carousels */
    .hscroll{display:flex;gap:12px;overflow:auto;padding-bottom:10px;scroll-behavior:smooth}
    .hscroll::-webkit-scrollbar{display:none}
    
    /* Mobile hscroll */
    @media (max-width: 768px) {
      .hscroll {
        gap: 10px;
      }
    }

    /* CTA & footer */
    .cta{margin-top:18px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:18px;border-radius:10px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    
    /* Mobile CTA */
    @media (max-width: 768px) {
      .cta {
        flex-direction: column;
        gap: 16px;
        padding: 16px;
        text-align: center;
      }
    }
    
    .cta input{padding:10px;border-radius:999px;border:none;width:300px}
    
    /* Mobile CTA input */
    @media (max-width: 768px) {
      .cta input {
        width: 100%;
        max-width: 300px;
      }
    }
    
    footer{margin-top:20px;background:var(--accent);color:#fff;padding:24px;border-radius:10px}
    
    /* Mobile footer */
    @media (max-width: 768px) {
      footer {
        padding: 20px 16px;
        border-radius: 10px;
      }
    }
    
    .footer-grid{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
    
    /* Mobile footer grid */
    @media (max-width: 768px) {
      .footer-grid {
        flex-direction: column;
        gap: 20px;
      }
    }
    
    .socials{display:flex;gap:10px;align-items:center}
    
    /* Footer logo size reduced */
    #footerLogo {
      height: 60px;
      width: auto;
      margin-bottom: 15px;
    }
    
    @media (max-width: 768px) {
      #footerLogo {
        height: 50px;
      }
    }
    
    /* reveal animation */
    .fade-up{opacity:0;transform:translateY(18px);transition:all .6s cubic-bezier(.2,.9,.2,1)}
    .fade-up.show{opacity:1;transform:translateY(0)}
    
    /* small screens */
    @media (max-width:900px){
      .sidebar{display:none}
      .sidebar-toggle{display:block}
      .layout{padding:0 10px}
      header{padding:10px}
      .hero .content{padding:12px}
      .show-sidebar-btn{display:none !important}
      main{margin-left:0;width:100%}
    }

    /* full screen panel (see more) */
    .panel{position:fixed;inset:0;background:#fff;z-index:1500;padding:18px;display:none;flex-direction:column;overflow:auto}
    .panel.open{display:flex}
    .panel .panel-header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:12px}
    .panel .panel-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media (max-width:1100px){.panel .panel-grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:780px){.panel .panel-grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:520px){.panel .panel-grid{grid-template-columns:1fr}}

    /* small adjustments so panel content fits without needing to scroll on desktop */
    @media (min-height:720px){ .panel{justify-content:flex-start} }

    /* ---------- MOBILE FILTERS SECTION ---------- */
    .mobile-filters-container {
      display: none;
      margin-top: 20px;
      background: var(--card);
      border-radius: 10px;
      padding: 16px;
      box-shadow: var(--shadow);
    }
    
    @media (max-width: 768px) {
      .mobile-filters-container {
        display: block;
      }
      
      .mobile-filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      
      .mobile-filters-header h3 {
        color: var(--accent);
        font-size: 18px;
        margin: 0;
      }
      
      .mobile-filters-toggle {
        background: var(--accent);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }
      
      .mobile-filters-content {
        display: none;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }
      
      .mobile-filters-content.active {
        display: grid;
      }
      
      .mobile-filter-group {
        margin-bottom: 16px;
      }
      
      .mobile-filter-group label {
        display: block;
        font-size: 14px;
        color: var(--muted);
        margin-bottom: 8px;
        font-weight: 600;
      }
      
      .mobile-filter-select {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #e3e3e8;
        font-size: 14px;
      }
      
      .mobile-sizes {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .mobile-size-btn {
        padding: 6px 12px;
        border: 1px solid #e3e3e8;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
      }
      
      .mobile-size-btn.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }
      
      .mobile-apply-filters {
        grid-column: span 2;
        background: var(--accent);
        color: white;
        border: none;
        padding: 12px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 8px;
      }
      
      .mobile-clear-filters {
        grid-column: span 2;
        background: transparent;
        color: var(--muted);
        border: 1px solid #e3e3e8;
        padding: 12px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 8px;
      }
    }

    /* ---------- MOBILE HAMBURGER MENU ---------- */
    .mobile-menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1900;
      display: none;
    }
    
    .mobile-menu-overlay.active {
      display: block;
    }
    
    .mobile-menu {
      position: fixed;
      top: 0;
      left: 0;
      width: 280px;
      height: 100%;
      background: white;
      z-index: 2000;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      overflow-y: auto;
    }
    
    .mobile-menu.active {
      transform: translateX(0);
    }
    
    .mobile-menu-header {
      padding: 20px;
      background: var(--accent);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .mobile-menu-header h3 {
      margin: 0;
      color: white;
    }
    
    .mobile-menu-close {
      background: transparent;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
    }
    
    .mobile-menu-nav {
      padding: 20px;
    }
    
    .mobile-menu-item {
      padding: 12px 0;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    
    .mobile-menu-item a {
      display: block;
      color: #333;
      text-decoration: none;
      font-weight: 600;
    }
    
    .mobile-menu-subitem {
      padding: 8px 0 8px 16px;
      border-bottom: none;
    }
    
    .mobile-menu-subitem a {
      font-weight: normal;
      color: var(--muted);
    }
    
    .mobile-menu-categories {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .mobile-menu-categories.active {
      max-height: 300px;
    }

    /* Quick add modal */
    .quick-add-modal {
      position: fixed;
      inset: 0;
      background: rgba(4,6,12,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1400;
      padding: 18px;
    }
    .quick-add-modal.open {
      display: flex;
    }
    .quick-add-modal-card {
      background: #fff;
      border-radius: 12px;
      max-width: 500px;
      width: 100%;
      padding: 20px;
    }
    .quick-add-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .quick-add-modal-title {
      font-weight: 700;
      font-size: 18px;
    }
    .quick-add-modal-content {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .stock-info {
      font-size: 13px;
      color: var(--muted);
    }
    .stock-error {
      color: #dc3545;
      font-size: 13px;
      display: none;
    }

    /* ---------- MODAL STYLES ---------- */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
    }
    
    .modal.open {
      display: flex;
    }
    
    .modal-card {
      background: #fff;
      border-radius: 12px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      margin: 0;
      color: var(--accent);
    }
    
    .modal-close {
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--muted);
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-footer {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--accent);
    }
    
    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .error-message {
      color: #dc3545;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }
    
    .success-message {
      color: #28a745;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }
    
    .forgot-password {
      text-align: right;
      margin-top: 10px;
    }
    
    .forgot-password a {
      color: var(--accent-2);
      text-decoration: none;
      font-size: 14px;
    }
    
    .auth-switch {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
    }
    
    .auth-switch a {
      color: var(--accent-2);
      text-decoration: none;
      font-weight: 600;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

	<script>
  (async function initSupabaseClient(){
    try {
      const res = await fetch('/.netlify/functions/get-client-config');
      if (!res.ok) {
        console.error('Failed to load Supabase config', res.status, await res.text());
        return;
      }
      const cfg = await res.json();

      // Support multiple key styles (camelCase and UPPER_SNAKE)
      const supabaseUrl =
        cfg.supabaseUrl ||
        cfg.SUPABASE_URL ||
        cfg.supabase_url ||
        '';
      const supabaseAnonKey =
        cfg.supabaseAnonKey ||
        cfg.SUPABASE_ANON_KEY ||
        cfg.supabase_anon_key ||
        '';

      if (!supabaseUrl || !supabaseAnonKey) {
        console.error('Missing Supabase config from server');
        return;
      }

      // Initialize Supabase client
      const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
      window.supabase = supabaseClient; // global

      // Notify other scripts
      document.dispatchEvent(new CustomEvent('supabase-ready', { detail: { supabase: supabaseClient } }));
      console.log('Supabase client initialized');
    } catch (err) {
      console.error('Error initializing Supabase client', err);
    }
  })();
</script>

</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="container header-inner" style="align-items:center">
      <!-- Mobile hamburger menu icon - NOW ON FAR LEFT -->
      <button class="mobile-menu-icon" id="mobileMenuIcon" style="display:none">‚ò∞</button>

      <!-- Left hamburger - HIDDEN ON MOBILE -->
      <button id="leftHamburger" class="left-hamburger" aria-label="Toggle categories (left)">‚ò∞</button>

      <div class="logo" aria-hidden="false">
        <img id="logoImg" src="umzila.webp" alt="Umzila logo">
        <a class="about-link" href="about.html">About</a>
      </div>

      <div class="search-bar" style="margin-left:6px" id="mainSearchBar">
        <input id="searchInput" class="search-input" placeholder="Search streetwear, hoodies, mystery boxes..." aria-label="Search products" />
        <button id="searchClear" class="search-clear" aria-label="Clear search">‚úï</button>
        <div id="suggestions" class="search-suggestions" role="listbox"></div>
        <button class="mobile-search-close" id="mobileSearchClose" style="display:none">‚úï</button>
      </div>

      <div class="header-right">
        <button class="mobile-search-icon" id="mobileSearchIcon" aria-label="Search">üîç</button>
        <button class="btn ghost" id="signBtn">Sign In / Sign Up</button>
        
        <!-- ADDED FROM FILE 2: Profile button & order badge -->
        <button id="profileBtnHeader" class="btn ghost" style="display:none;margin-left:6px">Profile</button>
        <span id="orderUpdatesBadge" style="display:none;background:#ff6b2c;color:white;padding:3px 7px;border-radius:6px;font-size:11px;margin-left:6px">updated</span>

        <!-- Cart button - NOW REDIRECTS DIRECTLY TO CHECKOUT -->
        <div class="cart" id="cartBtn" aria-haspopup="false">
          üõí <span class="cart-count" id="cartCount">0</span>
        </div>

        <!-- mobile hamburger to open sidebar - HIDDEN ON MOBILE (REMOVED AS REQUESTED) -->
        <button class="icon-btn sidebar-toggle" id="sidebarToggleBtn" title="Toggle categories" style="display:none">‚ò∞</button>
      </div>
    </div>
  </header>
  
  <!-- Mobile Menu Overlay -->
  <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
  
  <!-- Mobile Menu -->
  <div class="mobile-menu" id="mobileMenu">
    <div class="mobile-menu-header">
      <h3>Menu</h3>
      <button class="mobile-menu-close" id="mobileMenuClose">‚úï</button>
    </div>
    <div class="mobile-menu-nav">
      <div class="mobile-menu-item" id="mobileShopItem">
        <a href="#">Shop</a>
      </div>
      <div class="mobile-menu-categories" id="mobileCategoriesList">
        <!-- Categories will be populated dynamically -->
      </div>
      <div class="mobile-menu-item">
        <a href="about.html">About</a>
      </div>
      <div class="mobile-menu-item">
        <a href="#" id="mobileSignIn">Sign In / Sign Up</a>
      </div>
    </div>
  </div>

  <!-- LAYOUT -->
  <div class="layout container">
    <!-- SIDEBAR -->
    <aside id="sidebar" class="sidebar" aria-label="Categories">
      <!-- user asked removal of x close button -->
      <button class="mobile-sidebar-close" id="mobileSidebarClose">‚úï</button>
      <div class="categories">
        <h3>Categories</h3>
        <ul id="catList">
          <li data-cat="All" class="active">All</li>
          <!-- Categories will be populated dynamically -->
        </ul>
      </div>

      <div class="filter-section">
        <h3 style="color:var(--accent)">Filters</h3>
        
        <!-- Updated Price Filter with two dropdowns -->
        <label>Price Range</label>
        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 12px;">
          <select id="priceMin" class="size-select" style="flex: 1;">
            <option value="min">Min</option>
            <!-- Options will be populated dynamically -->
          </select>
          <span style="color: var(--muted); font-size: 13px;">to</span>
          <select id="priceMax" class="size-select" style="flex: 1;">
            <option value="max">Max</option>
            <!-- Options will be populated dynamically -->
          </select>
        </div>

        <!-- Sizes will be populated dynamically -->
        <label>Sizes</label>
        <div id="sizesFilter">
          <!-- Sizes will be populated dynamically -->
        </div>

        <!-- Type filter will be populated dynamically -->
        <label>Type</label>
        <div id="typeFilter">
          <!-- Types will be populated dynamically -->
        </div>

        <!-- Color filter will be populated dynamically -->
        <label>Color</label>
        <select id="colorSel" class="size-select">
          <option value="Any">Any</option>
          <!-- Colors will be populated dynamically -->
        </select>

        <!-- Tags filter (new) -->
        <label>Tags</label>
        <select id="tagSel" class="size-select">
          <option value="Any">Any</option>
          <!-- Tags will be populated dynamically -->
        </select>

        <label>Sort by</label>
        <select id="sortSel" class="size-select">
          <option value="popular">Popularity</option>
          <option value="new">Newest</option>
          <option value="price-asc">Price: Low ‚Üí High</option>
          <option value="price-desc">Price: High ‚Üí Low</option>
        </select>

        <div id="dealsBtn" style="margin-top:12px;padding:10px;border-radius:8px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:700;text-align:center;cursor:pointer">
          Deals of the Week
        </div>

        <div id="studentBtn" style="margin-top:8px;padding:10px;border-radius:8px;background:#fff;border:1px dashed #e8e8ef;color:var(--muted);text-align:center;cursor:pointer">
          Student Specials
        </div>

        <div style="margin-top:12px;font-size:13px;color:var(--muted)">
          <div style="margin-bottom:6px">Filter summary:</div>
          <div id="filterSummary">None</div>
          <button id="clearFilters" class="btn ghost" style="margin-top:8px">Clear all</button>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main id="mainContent">
      <div class="breadcrumb">Home ‚Ä∫ Streetwear</div>

      <!-- HERO -->
      <div class="hero fade-up" id="hero">
        <div class="slides" id="slides">
          <div class="slide" data-slide="hotDeals">
            <div class="overlay"></div>
            <div class="content">
              <h1>Weekly Hot Deals</h1>
              <p>Up to 50% off selected hoodies & tees ‚Äî limited stock.</p>
              <div class="cta" data-action="shop">Shop Now</div>
            </div>
          </div>

          <div class="slide" data-slide="mystery">
            <div class="overlay"></div>
            <div class="content">
              <h1>Mystery Box Spotlight</h1>
              <p>Student-friendly boxes from R120 ‚Äî surprise drops every week.</p>
              <div class="cta" data-action="mystery">Grab Yours</div>
            </div>
          </div>

          <div class="slide" data-slide="newDrops">
            <div class="overlay"></div>
            <div class="content">
              <h1>New Drops</h1>
              <p>Fresh designs ‚Äî stay ahead of the campus vibe.</p>
              <div class="cta" data-action="new">Shop New</div>
            </div>
          </div>

          <div class="slide" data-slide="flash">
            <div class="overlay"></div>
            <div class="content">
              <h1>Flash Sale ‚Äî 24 Hours</h1>
              <p>Extra discounts on top-sellers ‚Äî while stocks last.</p>
              <div class="cta" data-action="flash">Shop Flash</div>
            </div>
          </div>
        </div>

        <div class="nav">
          <div class="dots" id="dots"></div>
          <div class="arrows">
            <button class="arrow-btn" id="prevBtn" aria-label="Previous slide">‚Äπ</button>
            <button class="arrow-btn" id="nextBtn" aria-label="Next slide">‚Ä∫</button>
          </div>
        </div>
      </div>
      
      <!-- MOBILE FILTERS SECTION -->
      <div class="mobile-filters-container">
        <div class="mobile-filters-header">
          <h3>Filters</h3>
          <button class="mobile-filters-toggle" id="mobileFiltersToggle">Show Filters</button>
        </div>
        <div class="mobile-filters-content" id="mobileFiltersContent">
          <div class="mobile-filter-group">
            <label>Category</label>
            <select class="mobile-filter-select" id="mobileCategorySelect">
              <option value="All">All Categories</option>
            </select>
          </div>
          
          <div class="mobile-filter-group">
            <label>Price Range</label>
            <div style="display: flex; gap: 8px;">
              <select class="mobile-filter-select" id="mobilePriceMin">
                <option value="min">Min</option>
              </select>
              <select class="mobile-filter-select" id="mobilePriceMax">
                <option value="max">Max</option>
              </select>
            </div>
          </div>
          
          <div class="mobile-filter-group">
            <label>Sizes</label>
            <div class="mobile-sizes" id="mobileSizesFilter">
              <!-- Sizes will be populated dynamically -->
            </div>
          </div>
          
          <div class="mobile-filter-group">
            <label>Popularity</label>
            <select class="mobile-filter-select" id="mobileSortSelect">
              <option value="popular">Most Popular</option>
              <option value="new">Newest</option>
              <option value="price-asc">Price: Low to High</option>
              <option value="price-desc">Price: High to Low</option>
            </select>
          </div>
          
          <div class="mobile-filter-group">
            <label>Deals</label>
            <select class="mobile-filter-select" id="mobileDealsSelect">
              <option value="all">All Products</option>
              <option value="deals">Deals of the Week</option>
              <option value="student">Student Specials</option>
            </select>
          </div>
          
          <button class="mobile-apply-filters" id="mobileApplyFilters">Apply Filters</button>
          <button class="mobile-clear-filters" id="mobileClearFilters">Clear All</button>
        </div>
      </div>

      <!-- Filter summary and sort bar -->
      <div style="display:flex;gap:12px;align-items:center;margin-top:12px;flex-wrap:wrap">
        <div id="activeFilters" style="font-size:14px;color:var(--muted)">Showing <strong id="resultCount">0</strong> items</div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <label style="font-size:13px;color:var(--muted)">Sort</label>
          <select id="topSort" class="size-select">
            <option value="popular">Popularity</option>
            <option value="new">Newest</option>
            <option value="price-asc">Price: Low ‚Üí High</option>
            <option value="price-desc">Price: High ‚Üí Low</option>
          </select>
        </div>
      </div>

      <!-- HOT DEALS (moved first under hero) -->
      <section class="fade-up" id="hotSection">
        <h2> Hot Deals <a href="#" class="see-more" data-section="hot" style="font-size:14px;color:var(--accent-2)">See all ‚Üí</a></h2>
        <div class="hscroll" id="hotGrid"></div>
      </section>

      <!-- Mystery Boxes (now scrollable like trending) -->
      <section class="fade-up" id="mysterySection">
        <h2> Mystery Boxes <a href="#" class="see-more" data-section="mystery" style="font-size:14px;color:var(--accent-2)">See more ‚Üí</a></h2>
        <div class="hscroll" id="mysteryGrid"></div>
      </section>

      <!-- Trending / New Arrivals (horizontal) -->
      <section class="fade-up" id="trendingSection">
        <h2> Trending & New Arrivals <a href="#" class="see-more" data-section="trending" style="font-size:14px;color:var(--accent-2)">See more ‚Üí</a></h2>
        <div class="hscroll" id="trendingScroll"></div>
      </section>

      <!-- Bundles -->
      <section class="fade-up" id="bundlesSection">
        <h2> Bundles & Combo Deals <a href="#" class="see-more" data-section="bundles" style="font-size:14px;color:var(--accent-2)">See more ‚Üí</a></h2>
        <div class="hscroll" id="bundlesScroll"></div>
      </section>

      <!-- Recommended -->
      <section class="fade-up" id="recSection">
        <h2> Recommended For You <a href="#" class="see-more" data-section="recommended" style="font-size:14px;color:var(--accent-2)">Refresh ‚Üí</a></h2>
        <div class="hscroll" id="recScroll"></div>
      </section>

      <!-- CTA -->
      <div class="cta fade-up">
        <div>
          <strong style="font-size:18px">Sign up & get exclusive drops and student discounts!</strong>
          <div style="font-size:14px;margin-top:6px;color:rgba(255,255,255,0.9)">Special early access, student codes and mystery box bundles.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="newsEmail" placeholder="Enter your email" />
          <button id="subscribeBtn" class="btn">Subscribe</button>
        </div>
      </div>

      <!-- Referral Banner (text updated to mention R40 off) -->
      <div style="margin-top:12px;padding:12px;border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow)">
        <div>
          <strong>Share with friends & get rewards.</strong>
          <div style="font-size:13px;color:var(--muted)">
            Refer a friend ‚Äî they'll get R40 off their order when they sign up with your code.
            <div id="referralCodeDisplay" style="display:none; margin-top: 6px; font-size: 12px; color: var(--accent);">
              Your referral code: <strong id="userReferralCode">Loading...</strong>
            </div>
            <div id="referralLinkDisplay" style="display:none; margin-top: 4px; font-size: 11px; color: var(--muted);">
              Link: <span id="userReferralLink">Loading...</span>
            </div>
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn ghost" id="copyReferral">Copy code</button>
          <button class="btn" id="shareBtn">Share</button>
        </div>
      </div>

      <!-- FOOTER -->
      <footer style="margin-top:18px">
        <div class="footer-grid">
          <div style="min-width:220px">
            <img id="footerLogo" src="umzila.webp" alt="logo" style="margin-bottom:10px">
            <p style="color:rgba(255,255,255,0.9)">Affordable, trendy streetwear for students & fashion lovers.</p>
          </div>

          <div style="display:flex;gap:18px;flex-wrap:wrap">
            <div>
              <h4 style="margin-bottom:6px">Quick links</h4>
              <div style="display:flex;flex-direction:column;gap:6px">
                <a href="#">About</a><a href="#">Contact</a><a href="#">FAQ</a><a href="#">Returns & Exchanges</a>
              </div>
            </div>

            <div>
              <h4 style="margin-bottom:6px">Payments</h4>
              <div style="display:flex;gap:8px;align-items:center">
                <!-- inline SVG placeholders for payment icons -->
                <svg width="36" height="24" viewBox="0 0 36 24"><rect width="36" height="24" fill="#3cc" rx="3"></rect></svg>
                <svg width="36" height="24" viewBox="0 0 36 24"><rect width="36" height="24" fill="#111" rx="3"></rect></svg>
                <svg width="36" height="24" viewBox="0 0 36 24"><rect width="36" height="24" fill="#f79" rx="3"></rect></svg>
              </div>
            </div>

            <div>
              <h4 style="margin-bottom:6px">Follow</h4>
              <div class="socials">
                <a href="#" aria-label="instagram">üì∏</a>
                <a href="#" aria-label="tiktok">üéµ</a>
                <a href="#" aria-label="facebook">üìò</a>
              </div>
            </div>
          </div>
        </div>
      </footer>
    </main>
  </div>

  <!-- ===== UPDATED PRODUCT MODAL (redesigned) ===== -->
  <div id="productModal" class="product-modal-overlay">
    <div class="product-modal">
      <div class="product-modal-close" id="closeProductModal">&times;</div>
      <div class="product-modal-content" id="productModalContent">
        <!-- Content will be dynamically generated -->
      </div>
    </div>
  </div>

  <!-- Quick Add Modal -->
  <div id="quickAddModal" class="quick-add-modal">
    <div class="quick-add-modal-card">
      <div class="quick-add-modal-header">
        <div class="quick-add-modal-title">Quick Add</div>
        <button class="close-btn" id="quickAddClose">‚úï</button>
      </div>
      <div class="quick-add-modal-content">
        <div>
          <label>Size</label>
          <select id="quickAddSize" class="size-select" style="width:100%">
            <!-- Sizes will be populated dynamically -->
          </select>
          <div class="stock-info" id="quickAddStockInfo" style="margin-top:5px;"></div>
        </div>
        <div>
          <label>Quantity</label>
          <select id="quickAddQty" class="qty" style="width:100%">
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          </select>
        </div>
        <div class="stock-error" id="quickAddStockError">Quantity exceeds available stock for selected size</div>
        <button id="quickAddSubmit" class="add-btn" style="width:100%">Add to Cart</button>
      </div>
    </div>
  </div>

  <!-- Panel used for See More only (cart page removed) -->
  <div id="sectionPanel" class="panel" aria-hidden="true">
    <div class="panel-header">
      <h2 id="panelTitle"></h2>
      <div><button id="panelClose" class="btn ghost">‚úï Close</button></div>
    </div>
    <div id="panelContent" class="panel-grid"></div>
  </div>

  <!-- ===== AUTH MODALS ===== -->
  <!-- Login Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-card">
      <div class="modal-header">
        <h3>Sign In</h3>
        <button class="modal-close" id="loginModalClose">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="modalLoginEmail">Email</label>
          <input type="email" id="modalLoginEmail" placeholder="Enter your email">
          <div class="error-message" id="modalLoginEmailError"></div>
        </div>
        <div class="form-group">
          <label for="modalLoginPassword">Password</label>
          <input type="password" id="modalLoginPassword" placeholder="Enter your password">
          <div class="error-message" id="modalLoginPasswordError"></div>
        </div>
        <div class="forgot-password">
          <a href="#" id="modalForgotPassword">Forgot Password?</a>
        </div>
        <div class="error-message" id="modalLoginError"></div>
        <div class="success-message" id="modalLoginSuccess"></div>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" id="modalOpenSignup">Create Account</button>
        <button class="btn" id="modalLoginSubmit">Sign In</button>
      </div>
    </div>
  </div>

  <!-- Signup Modal -->
  <div id="signupModal" class="modal">
    <div class="modal-card">
      <div class="modal-header">
        <h3>Create Account</h3>
        <button class="modal-close" id="signupModalClose">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="modalSignupName">Full Name</label>
          <input type="text" id="modalSignupName" placeholder="Enter your full name">
          <div class="error-message" id="modalSignupNameError"></div>
        </div>
        <div class="form-group">
          <label for="modalSignupEmail">Email</label>
          <input type="email" id="modalSignupEmail" placeholder="Enter your email">
          <div class="error-message" id="modalSignupEmailError"></div>
        </div>
        <div class="form-group">
          <label for="modalSignupPassword">Password</label>
          <input type="password" id="modalSignupPassword" placeholder="Create a password">
          <div class="error-message" id="modalSignupPasswordError"></div>
          <div style="margin-top: 8px; font-size: 12px; color: var(--muted);">
            Password must be at least 8 characters with 1 number and 1 special character.
          </div>
        </div>
        <!-- Hidden referral code input -->
        <input type="hidden" id="modalSignupReferralCode" value="" />
        <div class="error-message" id="modalSignupError"></div>
        <div class="success-message" id="modalSignupSuccess"></div>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" id="modalOpenLogin">Already have an account?</button>
        <button class="btn" id="modalSignupSubmit">Create Account</button>
      </div>
    </div>
  </div>

  <!-- Forgot Password Modal -->
  <div id="forgotPasswordModal" class="modal">
    <div class="modal-card">
      <div class="modal-header">
        <h3>Reset Password</h3>
        <button class="modal-close" id="forgotPasswordModalClose">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 20px; color: var(--muted);">Enter your email address and we'll send you a link to reset your password.</p>
        <div class="form-group">
          <label for="modalForgotPasswordEmail">Email</label>
          <input type="email" id="modalForgotPasswordEmail" placeholder="Enter your email">
          <div class="error-message" id="modalForgotPasswordError"></div>
          <div class="success-message" id="modalForgotPasswordSuccess"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" id="modalForgotPasswordCancel">Cancel</button>
        <button class="btn" id="modalForgotPasswordSubmit">Send Reset Link</button>
      </div>
    </div>
  </div>

  <script>
    /********************
     * SECURITY FUNCTIONS
     ********************/
    // Prevent price tampering - validate all prices on server
    function validatePriceIntegrity(cartItem, serverPrice) {
      // Allow small rounding differences
      const priceDiff = Math.abs(cartItem.price - serverPrice);
      const allowedDiff = 0.01; // 1 cent tolerance
      
      if (priceDiff > allowedDiff) {
        console.warn(`Price mismatch for ${cartItem.name}: Client ${cartItem.price}, Server ${serverPrice}`);
        return serverPrice; // Use server price
      }
      
      return cartItem.price;
    }

    // Rate limiting for cart updates
    const cartUpdateLimiter = {
      lastUpdate: 0,
      minInterval: 1000, // 1 second between updates
      
      canUpdate() {
        const now = Date.now();
        if (now - this.lastUpdate > this.minInterval) {
          this.lastUpdate = now;
          return true;
        }
        return false;
      }
    };

    // Sanitize cart data
    function sanitizeCartData(cart) {
      return cart.map(item => {
        // Accept either item.id or item.product_id; normalize to id (string)
        const rawId = item.id || item.product_id || item.productId || item.product_id;
        const id = (typeof rawId === 'string' || typeof rawId === 'number') ? String(rawId) : null;

        // Price: accept numbers or numeric strings
        let price = 0;
        if (typeof item.price === 'number') {
          price = Number(item.price);
        } else if (typeof item.price === 'string' && item.price.trim() !== '') {
          const p = parseFloat(item.price.replace(/[^0-9.-]+/g, ''));
          price = Number.isFinite(p) ? p : 0;
        }

        const quantity = (typeof item.quantity === 'number') ? Math.max(1, Math.floor(item.quantity)) :
                         (typeof item.qty === 'number' ? Math.max(1, Math.floor(item.qty)) : 1);

        return {
          // keep both id and product_id so other code can use either
          id,
          product_id: id,
          name: typeof item.name === 'string' ? item.name.substring(0, 100) : '',
          price: Math.max(0, Number(price.toFixed ? Number(price).toFixed(2) : price)),
          quantity,
          size: typeof item.size === 'string' ? item.size.substring(0, 20) : 'One Size',
          image: typeof item.image === 'string' ? item.image.substring(0, 500) : '',
          variant_id: item.variant_id || item.variantId || null
        };
      })
      .filter(item => item.id && item.price > 0);
    }

    /********************
     * SECURE CART MANAGEMENT WITH SUPABASE SYNC
     ********************/

    // Enhanced cart item structure
    const cartItemStructure = {
      product_id: null,
      name: '',
      price: 0,
      quantity: 1,
      size: 'One Size',
      image: '',
      variant_id: null,
      stock: 0,
      max_quantity: 0,
      created_at: new Date().toISOString()
    };

    // Save cart to Supabase (if logged in) and localStorage
    async function saveCartToServer() {
      if (!supabaseClient || !currentUser) return;
      
      // Rate limiting check
      if (!cartUpdateLimiter.canUpdate()) {
        console.log('Rate limited: skipping cart update');
        return;
      }
      
      try {
        const cartData = {
          items: state.cart.map(item => ({
            product_id: item.id,
            name: item.title,
            price: item.price,
            quantity: item.qty,
            size: item.size,
            image: item.img,
            variant_id: item.variantId || null,
            stock: item.stock || 0,
            max_quantity: item.maxQuantity || item.qty
          })),
          updated_at: new Date().toISOString(),
          expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
        };
        
        // Sanitize data before sending
        const sanitizedItems = sanitizeCartData(cartData.items);
        
        // Upsert cart to Supabase
        const { data, error } = await supabaseClient
          .from('carts')
          .upsert({
            user_id: currentUser.id,
            items: sanitizedItems,
            updated_at: cartData.updated_at,
            expires_at: cartData.expires_at
          }, {
            onConflict: 'user_id'
          })
          .select()
          .single();
          
        if (error) {
          console.error('Error saving cart to server:', error);
        } else {
          console.log('Cart saved to server successfully');
        }
      } catch (error) {
        console.error('Error in saveCartToServer:', error);
      }
    }

    // Load cart from Supabase (if logged in) or localStorage
    async function loadCartWithSync() {
      try {
        if (supabaseClient && currentUser) {
          // Load from Supabase
          const { data, error } = await supabaseClient
            .from('carts')
            .select('items')
            .eq('user_id', currentUser.id)
            .single();
            
          if (!error && data && data.items) {
            // Sanitize and validate server cart items
            const sanitizedItems = sanitizeCartData(data.items);
            
            // Convert server cart items to local format
            state.cart = sanitizedItems.map(item => ({
              id: item.product_id,
              title: item.name,
              price: item.price,
              qty: item.quantity,
              size: item.size,
              img: item.image,
              variantId: item.variant_id,
              stock: item.stock,
              maxQuantity: item.max_quantity
            }));
            
            // Validate prices against current product data
            await validateCartPrices();
            
            // Save to localStorage for consistency
            localStorage.setItem('ss_cart', JSON.stringify(state.cart));
          } else {
            // Fallback to localStorage
            const savedCart = localStorage.getItem('ss_cart');
            if (savedCart) {
              state.cart = JSON.parse(savedCart);
              // Sync to server
              await saveCartToServer();
            }
          }
        } else {
          // Not logged in, use localStorage only
          const savedCart = localStorage.getItem('ss_cart');
          if (savedCart) {
            state.cart = JSON.parse(savedCart);
          }
        }
        
        updateCartBadge();
        
      } catch (error) {
        console.error('Error loading cart:', error);
        const savedCart = localStorage.getItem('ss_cart');
        state.cart = savedCart ? JSON.parse(savedCart) : [];
      }
    }

    // Validate cart prices against current product data
    async function validateCartPrices() {
      if (!supabaseClient || state.cart.length === 0) return;
      
      try {
        // Get all product IDs from cart
        const productIds = state.cart.map(item => item.id);
        
        // Fetch current product data
        const { data: products, error } = await supabaseClient
          .from('products')
          .select(`
            id,
            price,
            sale,
            sale_price,
            product_variants!fk_product_variants_product(*)
          `)
          .in('id', productIds);
          
        if (error || !products) return;
        
        // Create product map
        const productMap = {};
        products.forEach(product => {
          productMap[product.id] = product;
        });
        
        // Validate each cart item
        state.cart = state.cart.map(item => {
          const product = productMap[item.id];
          if (!product) return item;
          
          let correctPrice = product.price;
          
          // Check if product is on sale
          if (product.sale && product.sale_price) {
            correctPrice = product.sale_price;
          }
          
          // Check for variant price override
          if (item.variantId && product.product_variants) {
            const variant = product.product_variants.find(v => v.id === item.variantId);
            if (variant && variant.price_override) {
              correctPrice = variant.price_override;
            }
          }
          
          // Validate price integrity
          item.price = validatePriceIntegrity(item, correctPrice);
          return item;
        });
        
      } catch (error) {
        console.error('Error validating cart prices:', error);
      }
    }

    // Enhanced add to cart function with validation - FIXED TO WORK PROPERLY
    async function addToCart(id, qty = 1, size = 'M') {
      const p = state.products.find(x => x.id === id);
      if (!p) return;
      
      // Check stock
      const variant = p.variants?.find(v => v.size === size);
      const variantId = variant ? variant.id : null;
      const variantStock = variant ? variant.stock : p.stock;
      
      if (variantStock < qty) {
        alert(`Only ${variantStock} items available for size ${size}`);
        return;
      }
      
      // Get correct price (use variant price_override if available)
      const price = variant && variant.price_override ? variant.price_override : 
                    (p.sale && p.salePrice ? p.salePrice : p.price);
      
      const existing = state.cart.find(i => i.id === id && i.size === size);
      
      if (existing) {
        // Check if we can add more
        if (existing.qty + qty > variantStock) {
          alert(`Cannot add more items. Only ${variantStock - existing.qty} more available for size ${size}`);
          return;
        }
        existing.qty += qty;
      } else {
        state.cart.push({
          id,
          title: p.title,
          price,
          qty,
          size,
          img: (p.primary_image || (p.imgs && p.imgs[0]) || svgPlaceholder(p.title)),
          variantId: variantId,
          stock: variantStock,
          maxQuantity: variantStock
        });
      }
      
      // Save to localStorage
      localStorage.setItem('ss_cart', JSON.stringify(state.cart));
      
      // Save to Supabase if logged in
      if (supabaseClient && currentUser) {
        await saveCartToServer();
      }
      
      updateCartBadge();
      
      // Show success notification
      showNotification(`Added ${qty} ${p.title} to cart!`);
    }

    // Update cart badge
    function updateCartBadge() {
      const totalItems = state.cart.reduce((sum, item) => sum + item.qty, 0);
      if (cartCount) cartCount.textContent = totalItems;
      
      // Update all cart count elements
      document.querySelectorAll('.cart-count').forEach(element => {
        element.textContent = totalItems;
      });
    }

    // Clear cart from server and localStorage
    async function clearCart() {
      state.cart = [];
      localStorage.removeItem('ss_cart');
      
      if (supabaseClient && currentUser) {
        try {
          await supabaseClient
            .from('carts')
            .delete()
            .eq('user_id', currentUser.id);
        } catch (error) {
          console.error('Error clearing server cart:', error);
        }
      }
      
      updateCartBadge();
    }

    // Initialize cart on page load
    async function initializeCart() {
      await loadCartWithSync();
    }

    // Call this when user logs in
    async function syncCartOnLogin(user) {
      // Get localStorage cart
      const localCart = JSON.parse(localStorage.getItem('ss_cart') || '[]');
      
      if (localCart.length > 0) {
        // Merge with server cart
        await loadCartWithSync();
        
        // Add localStorage items to server cart if not already present
        const serverIds = state.cart.map(item => `${item.id}-${item.size}`);
        
        localCart.forEach(item => {
          const itemKey = `${item.id}-${item.size}`;
          if (!serverIds.includes(itemKey)) {
            state.cart.push(item);
          }
        });
        
        // Save merged cart
        localStorage.setItem('ss_cart', JSON.stringify(state.cart));
        await saveCartToServer();
      } else {
        // No local cart, just load server cart
        await loadCartWithSync();
      }
      
      updateCartBadge();
    }

    /********************
     * MOBILE FUNCTIONALITY
     ********************/
    
    // Mobile detection
    const isMobile = () => window.innerWidth <= 768;
    
    // Mobile search functionality
    function initMobileSearch() {
      const mobileSearchIcon = document.getElementById('mobileSearchIcon');
      const mobileSearchClose = document.getElementById('mobileSearchClose');
      const mainSearchBar = document.getElementById('mainSearchBar');
      const searchInput = document.getElementById('searchInput');
      
      if (mobileSearchIcon && mainSearchBar && mobileSearchClose) {
        mobileSearchIcon.addEventListener('click', () => {
          mainSearchBar.classList.add('mobile-active');
          mobileSearchClose.style.display = 'block';
          searchInput.focus();
        });
        
        mobileSearchClose.addEventListener('click', () => {
          mainSearchBar.classList.remove('mobile-active');
          mobileSearchClose.style.display = 'none';
        });
        
        // Hide mobile search on window resize
        window.addEventListener('resize', () => {
          if (!isMobile()) {
            mainSearchBar.classList.remove('mobile-active');
            mobileSearchClose.style.display = 'none';
          }
        });
      }
    }
    
    // Mobile menu functionality
    function initMobileMenu() {
      const mobileMenu = document.getElementById('mobileMenu');
      const mobileMenuClose = document.getElementById('mobileMenuClose');
      const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
      const mobileShopItem = document.getElementById('mobileShopItem');
      const mobileCategoriesList = document.getElementById('mobileCategoriesList');
      const mobileSignIn = document.getElementById('mobileSignIn');
      const mobileMenuIcon = document.getElementById('mobileMenuIcon');
      
      if (mobileMenuIcon) {
        // Show mobile menu icon on mobile
        if (isMobile()) {
          mobileMenuIcon.style.display = 'block';
        }
        
        mobileMenuIcon.addEventListener('click', () => {
          mobileMenu.classList.add('active');
          mobileMenuOverlay.classList.add('active');
          document.body.style.overflow = 'hidden';
        });
      }
      
      if (mobileMenu) {
        mobileMenuClose.addEventListener('click', () => {
          mobileMenu.classList.remove('active');
          mobileMenuOverlay.classList.remove('active');
          document.body.style.overflow = '';
        });
        
        mobileMenuOverlay.addEventListener('click', () => {
          mobileMenu.classList.remove('active');
          mobileMenuOverlay.classList.remove('active');
          document.body.style.overflow = '';
        });
        
        // Toggle categories in mobile menu
        if (mobileShopItem && mobileCategoriesList) {
          mobileShopItem.addEventListener('click', () => {
            mobileCategoriesList.classList.toggle('active');
          });
        }
        
        // Mobile sign in
        if (mobileSignIn) {
          mobileSignIn.addEventListener('click', (e) => {
            e.preventDefault();
            mobileMenu.classList.remove('active');
            mobileMenuOverlay.classList.remove('active');
            document.body.style.overflow = '';
            showModal(document.getElementById('loginModal'));
          });
        }
      }
      
      // Update on resize
      window.addEventListener('resize', () => {
        if (mobileMenuIcon) {
          if (isMobile()) {
            mobileMenuIcon.style.display = 'block';
          } else {
            mobileMenuIcon.style.display = 'none';
            mobileMenu.classList.remove('active');
            mobileMenuOverlay.classList.remove('active');
          }
        }
      });
    }
    
    // Mobile filters functionality
    function initMobileFilters() {
      const mobileFiltersToggle = document.getElementById('mobileFiltersToggle');
      const mobileFiltersContent = document.getElementById('mobileFiltersContent');
      const mobileApplyFilters = document.getElementById('mobileApplyFilters');
      const mobileClearFilters = document.getElementById('mobileClearFilters');
      const mobileCategorySelect = document.getElementById('mobileCategorySelect');
      const mobilePriceMin = document.getElementById('mobilePriceMin');
      const mobilePriceMax = document.getElementById('mobilePriceMax');
      const mobileSizesFilter = document.getElementById('mobileSizesFilter');
      const mobileSortSelect = document.getElementById('mobileSortSelect');
      const mobileDealsSelect = document.getElementById('mobileDealsSelect');
      
      if (mobileFiltersToggle && mobileFiltersContent) {
        mobileFiltersToggle.addEventListener('click', () => {
          const isActive = mobileFiltersContent.classList.contains('active');
          mobileFiltersContent.classList.toggle('active');
          mobileFiltersToggle.textContent = isActive ? 'Show Filters' : 'Hide Filters';
        });
        
        // Apply mobile filters
        if (mobileApplyFilters) {
          mobileApplyFilters.addEventListener('click', () => {
            // Apply category filter
            if (mobileCategorySelect) {
              state.filters.category = mobileCategorySelect.value;
            }
            
            // Apply price filter
            if (mobilePriceMin && mobilePriceMax) {
              state.filters.priceMin = mobilePriceMin.value === 'min' ? null : Number(mobilePriceMin.value);
              state.filters.priceMax = mobilePriceMax.value === 'max' ? null : Number(mobilePriceMax.value);
            }
            
            // Apply size filter
            if (mobileSizesFilter) {
              const selectedSizes = Array.from(mobileSizesFilter.querySelectorAll('.mobile-size-btn.active'))
                .map(btn => btn.dataset.size);
              state.filters.sizes = selectedSizes;
            }
            
            // Apply sort
            if (mobileSortSelect) {
              state.filters.sort = mobileSortSelect.value;
              if (topSort) topSort.value = mobileSortSelect.value;
              if (document.getElementById('sortSel')) document.getElementById('sortSel').value = mobileSortSelect.value;
            }
            
            // Apply deals filter
            if (mobileDealsSelect) {
              const dealsValue = mobileDealsSelect.value;
              if (dealsValue === 'deals') {
                state.filters.priceMax = 400;
                if (priceMax) priceMax.value = '400';
              } else if (dealsValue === 'student') {
                state.filters.priceMax = 200;
                if (priceMax) priceMax.value = '200';
              }
            }
            
            // Close mobile filters
            mobileFiltersContent.classList.remove('active');
            mobileFiltersToggle.textContent = 'Show Filters';
            
            // Apply filters
            applyFilters();
          });
        }
        
        // Clear mobile filters
        if (mobileClearFilters) {
          mobileClearFilters.addEventListener('click', () => {
            // Clear all mobile filter inputs
            if (mobileCategorySelect) mobileCategorySelect.value = 'All';
            if (mobilePriceMin) mobilePriceMin.value = 'min';
            if (mobilePriceMax) mobilePriceMax.value = 'max';
            if (mobileSizesFilter) {
              mobileSizesFilter.querySelectorAll('.mobile-size-btn').forEach(btn => {
                btn.classList.remove('active');
              });
            }
            if (mobileSortSelect) mobileSortSelect.value = 'popular';
            if (mobileDealsSelect) mobileDealsSelect.value = 'all';
            
            // Reset main filters
            state.filters = { 
              category:'All', 
              priceMin: null, 
              priceMax: null, 
              sizes:[], 
              type:'All', 
              color:'Any', 
              search:'', 
              sort:'popular',
              tag: 'Any'
            };
            
            // Reset UI elements
            if (priceMin) priceMin.value = 'min';
            if (priceMax) priceMax.value = 'max';
            document.querySelectorAll('input[name="size"]').forEach(i=>i.checked=false);
            document.querySelector('input[name="type"][value="All"]').checked=true;
            if (colorSel) colorSel.value='Any';
            if (tagSel) tagSel.value='Any';
            if (document.getElementById('sortSel')) document.getElementById('sortSel').value='popular';
            if (topSort) topSort.value='popular';
            if (searchInput) searchInput.value='';
            if (searchClear) searchClear.style.display='none';
            if (suggestions) suggestions.style.display='none';
            
            // Reset active category
            if (catList) {
              Array.from(catList.querySelectorAll('li')).forEach(li=>li.classList.remove('active'));
              catList.querySelector('li[data-cat="All"]').classList.add('active');
            }
            
            applyFilters();
          });
        }
      }
    }
    
    // Populate mobile filters
    function populateMobileFilters() {
      const mobileCategorySelect = document.getElementById('mobileCategorySelect');
      const mobileSizesFilter = document.getElementById('mobileSizesFilter');
      
      // Populate mobile category select
      if (mobileCategorySelect && filterOptions.categories) {
        filterOptions.categories.forEach(category => {
          if (category !== 'All') {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            mobileCategorySelect.appendChild(option);
          }
        });
      }
      
      // Populate mobile sizes filter
      if (mobileSizesFilter && filterOptions.sizes) {
        filterOptions.sizes.forEach(size => {
          const sizeBtn = document.createElement('button');
          sizeBtn.type = 'button';
          sizeBtn.className = 'mobile-size-btn';
          sizeBtn.dataset.size = size;
          sizeBtn.textContent = size;
          sizeBtn.addEventListener('click', () => {
            sizeBtn.classList.toggle('active');
          });
          mobileSizesFilter.appendChild(sizeBtn);
        });
      }
      
      // Populate mobile price dropdowns
      const mobilePriceMin = document.getElementById('mobilePriceMin');
      const mobilePriceMax = document.getElementById('mobilePriceMax');
      
      if (mobilePriceMin && mobilePriceMax && filterOptions.priceRange.max > 0) {
        const maxPrice = filterOptions.priceRange.max;
        
        // Clear existing options (keep first placeholder)
        while (mobilePriceMin.options.length > 1) mobilePriceMin.remove(1);
        while (mobilePriceMax.options.length > 1) mobilePriceMax.remove(1);
        
        // Create price options (increments of 50)
        for (let price = 0; price <= maxPrice; price += 50) {
          const optionText = price === 0 ? 'R0' : `R${price}`;
          
          const minOption = document.createElement('option');
          minOption.value = price;
          minOption.textContent = optionText;
          mobilePriceMin.appendChild(minOption);
          
          const maxOption = document.createElement('option');
          maxOption.value = price;
          maxOption.textContent = optionText;
          mobilePriceMax.appendChild(maxOption);
        }
        
        // Add "max" option at the end
        const maxOption = document.createElement('option');
        maxOption.value = maxPrice;
        maxOption.textContent = `R${maxPrice}`;
        mobilePriceMax.appendChild(maxOption);
      }
    }
    
    // Populate mobile menu categories
    function populateMobileMenuCategories() {
      const mobileCategoriesList = document.getElementById('mobileCategoriesList');
      
      if (mobileCategoriesList && filterOptions.categories) {
        filterOptions.categories.forEach(category => {
          if (category !== 'All') {
            const categoryItem = document.createElement('div');
            categoryItem.className = 'mobile-menu-item mobile-menu-subitem';
            
            const categoryLink = document.createElement('a');
            categoryLink.href = '#';
            categoryLink.textContent = category;
            categoryLink.addEventListener('click', (e) => {
              e.preventDefault();
              mobileMenu.classList.remove('active');
              mobileMenuOverlay.classList.remove('active');
              document.body.style.overflow = '';
              
              // Set category filter
              state.filters.category = category;
              
              // Update UI
              if (catList) {
                Array.from(catList.querySelectorAll('li')).forEach(li=>li.classList.remove('active'));
                const catItem = catList.querySelector(`li[data-cat="${category}"]`);
                if (catItem) catItem.classList.add('active');
              }
              
              // Update mobile category select
              const mobileCategorySelect = document.getElementById('mobileCategorySelect');
              if (mobileCategorySelect) {
                mobileCategorySelect.value = category;
              }
              
              applyFilters();
            });
            
            categoryItem.appendChild(categoryLink);
            mobileCategoriesList.appendChild(categoryItem);
          }
        });
      }
    }

    /********************
     * Helper: create SVG placeholder dataURI
     ********************/
    function svgPlaceholder(text, w=400, h=300, bg='#ddd', fg='#222') {
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}' viewBox='0 0 ${w} ${h}'>
        <rect width='100%' height='100%' fill='${bg}' />
        <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='${fg}' font-family='Arial, Helvetica, sans-serif' font-weight='700' font-size='${Math.round(Math.min(w,h)/10)}'>${text}</text>
      </svg>`;
      return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
    }

    /********************
	 * Supabase initialization via Netlify function
	 ********************/
	let supabaseClient = null;

	// Listen for the supabase-ready event
	document.addEventListener('supabase-ready', function(e) {
	  supabaseClient = e.detail.supabase;
	  console.log('Supabase client received via event');
	  
	  // Now that Supabase is ready, load products and check auth state
	  if (typeof loadProducts === 'function') {
		loadProducts();
	  }
	  if (typeof checkInitialAuthState === 'function') {
		checkInitialAuthState();
	  }
	  if (typeof loadFilterOptions === 'function') {
		loadFilterOptions();
	  }
	});

	/********************
     * State & basic helpers
     ********************/
    let state = { 
      products: [], 
      filters: { 
        category:'All', 
        priceMin: null, 
        priceMax: null, 
        sizes:[], 
        type:'All', 
        color:'Any', 
        search:'', 
        sort:'popular',
        tag: 'Any'
      }, 
      cart: [],
      productVariants: {} // Store variants by product_id
    };
    
    // Store current user referral info
    let userReferralInfo = {
      code: null,
      link: null
    };
    
    // Store current auth user
    let currentUser = null;
    
    // Current product for quick add modal
    let currentQuickAddProduct = null;
    
    const $ = (s)=>document.querySelector(s);
    const format = (n)=> 'R'+n.toFixed(2);

    /* DOM refs */
    const slides = document.getElementById('slides');
    const dots = document.getElementById('dots');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const cartBtn = document.getElementById('cartBtn');
    const cartCount = document.getElementById('cartCount');
    const searchInput = document.getElementById('searchInput');
    const suggestions = document.getElementById('suggestions');
    const searchClear = document.getElementById('searchClear');
    const priceMin = document.getElementById('priceMin');
    const priceMax = document.getElementById('priceMax');
    const catList = document.getElementById('catList');
    const resultCount = document.getElementById('resultCount');
    const topSort = document.getElementById('topSort');
    const mysteryGrid = document.getElementById('mysteryGrid');
    const hotGrid = document.getElementById('hotGrid');
    const trendingScroll = document.getElementById('trendingScroll');
    const bundlesScroll = document.getElementById('bundlesScroll');
    const recScroll = document.getElementById('recScroll');
    const filterSummary = document.getElementById('filterSummary');
    const clearFilters = document.getElementById('clearFilters');
    const sidebar = document.getElementById('sidebar');
    const leftHamburger = document.getElementById('leftHamburger');
    const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
    const sectionPanel = document.getElementById('sectionPanel');
    const panelTitle = document.getElementById('panelTitle');
    const panelContent = document.getElementById('panelContent');
    const panelClose = document.getElementById('panelClose');
    const signBtn = document.getElementById('signBtn');
    const modal = document.getElementById('productModal');
    const modalClose = document.getElementById('closeProductModal');
    const copyReferralBtn = document.getElementById('copyReferral');
    const shareBtn = document.getElementById('shareBtn');
    const userReferralCode = document.getElementById('userReferralCode');
    const userReferralLink = document.getElementById('userReferralLink');
    const referralCodeDisplay = document.getElementById('referralCodeDisplay');
    const referralLinkDisplay = document.getElementById('referralLinkDisplay');
    const profileBtnHeader = document.getElementById('profileBtnHeader');
    const orderUpdatesBadge = document.getElementById('orderUpdatesBadge');
    const quickAddModal = document.getElementById('quickAddModal');
    const quickAddClose = document.getElementById('quickAddClose');
    const quickAddSize = document.getElementById('quickAddSize');
    const quickAddQty = document.getElementById('quickAddQty');
    const quickAddSubmit = document.getElementById('quickAddSubmit');
    const quickAddStockInfo = document.getElementById('quickAddStockInfo');
    const quickAddStockError = document.getElementById('quickAddStockError');
    
    // Modal elements
    const loginModal = document.getElementById('loginModal');
    const signupModal = document.getElementById('signupModal');
    const forgotPasswordModal = document.getElementById('forgotPasswordModal');
    const loginModalClose = document.getElementById('loginModalClose');
    const signupModalClose = document.getElementById('signupModalClose');
    const forgotPasswordModalClose = document.getElementById('forgotPasswordModalClose');
    const modalLoginEmail = document.getElementById('modalLoginEmail');
    const modalLoginPassword = document.getElementById('modalLoginPassword');
    const modalLoginSubmit = document.getElementById('modalLoginSubmit');
    const modalOpenSignup = document.getElementById('modalOpenSignup');
    const modalSignupName = document.getElementById('modalSignupName');
    const modalSignupEmail = document.getElementById('modalSignupEmail');
    const modalSignupPassword = document.getElementById('modalSignupPassword');
    const modalSignupSubmit = document.getElementById('modalSignupSubmit');
    const modalOpenLogin = document.getElementById('modalOpenLogin');
    const modalForgotPassword = document.getElementById('modalForgotPassword');
    const modalForgotPasswordEmail = document.getElementById('modalForgotPasswordEmail');
    const modalForgotPasswordSubmit = document.getElementById('modalForgotPasswordSubmit');
    const modalForgotPasswordCancel = document.getElementById('modalForgotPasswordCancel');
    const modalSignupReferralCode = document.getElementById('modalSignupReferralCode');
    
    /********************
     * Checkout Redirection - DIRECT TO checkout.html
     ********************/
    function redirectToCheckout() {
      if (state.cart.length === 0) {
        alert('Your cart is empty.');
        return;
      }
      
      // Save cart to localStorage to pass to checkout page
      try {
        // Include user info if logged in
        const checkoutData = {
          cart: state.cart,
          user: currentUser ? {
            id: currentUser.id,
            email: currentUser.email
          } : null,
          timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('checkoutCart', JSON.stringify(checkoutData));
      } catch (e) {
        console.error('Failed to save cart:', e);
      }
      
      // Redirect to checkout.html
      window.location.href = 'checkout.html';
    }
    
    /********************
     * Load product variants from Supabase
     ********************/
    async function loadProductVariants() {
      if (!supabaseClient) return;
      
      try {
        const { data, error } = await supabaseClient
          .from('product_variants')
          .select('*');
        
        if (error) {
          console.warn('Error loading product variants:', error);
          return;
        }
        
        // Group variants by product_id
        const variantsByProduct = {};
        data.forEach(variant => {
          if (!variantsByProduct[variant.product_id]) {
            variantsByProduct[variant.product_id] = [];
          }
          variantsByProduct[variant.product_id].push(variant);
        });
        
        state.productVariants = variantsByProduct;
        console.info('Product variants loaded:', Object.keys(variantsByProduct).length);
      } catch (e) {
        console.error('Error loading variants:', e);
      }
    }

    /********************
     * Initialize product data from Supabase
     ********************/
    async function loadProducts() {
      if(!supabaseClient) return;
      
      try {
        // First load variants
        await loadProductVariants();
        
        const { data, error } = await supabaseClient
          .from('products')
          .select(`
            *,
            product_images!fk_product_images_product(*)
          `)
          .order('created_at', { ascending: false });
        
        if(error) {
          console.warn('Error loading products:', error);
          return;
        }
        
        const mapped = data.map((row) => {
          const tags = row.tags || [];
          const sale = row.sale || false;
          const salePrice = row.sale_price || 0;
          const sizes = row.sizes || [];
          
          // Get images from product_images table with lazy loading support
          let allImages = [];
          if (row.product_images && Array.isArray(row.product_images) && row.product_images.length > 0) {
            const sortedImages = row.product_images.sort((a, b) => (a.image_order || 0) - (b.image_order || 0));
            allImages = sortedImages.map(img => img.url);
          } else if (row.image) {
            // Fallback to image column in products table
            allImages = [row.image];
          } else {
            // Fallback to placeholder
            const seed = encodeURIComponent((row.name||'product') + '_' + row.id);
            allImages = [
              `https://picsum.photos/seed/${seed}/400/300`,
              `https://picsum.photos/seed/${seed}_back/400/300`
            ];
          }
          
          // Get variants for this product
          const variants = state.productVariants[row.id] || [];
          
          // Calculate total stock from variants
          let totalStock = row.stock || 0;
          if (variants.length > 0) {
            totalStock = variants.reduce((sum, variant) => sum + (variant.stock || 0), 0);
          }
          
          // Get available sizes from variants
          const availableSizes = [];
          if (variants.length > 0) {
            variants.forEach(variant => {
              if (variant.size && !availableSizes.includes(variant.size)) {
                availableSizes.push(variant.size);
              }
            });
          } else if (sizes.length > 0) {
            availableSizes.push(...sizes);
          } else {
            availableSizes.push('S', 'M', 'L', 'XL');
          }
          
          return {
            id: row.id,
            title: row.name || 'Product',
            price: Number(row.price) || 0,
            sale: sale,
            salePrice: salePrice,
            category: row.category || 'All',
            primary_image: allImages[0] || null,
            secondary_image: allImages[1] || null,
            all_images: allImages,
            size: availableSizes,
            badge: row.badge || (sale ? 'Sale' : ''),
            stock: totalStock,
            variants: variants,
            type: 'New',
            color: '',
            tags: tags,
            popularity: Number(row.popularity || 50),
            desc: row.description || '',
            metadata: row.metadata || {}
          };
        });
        
        state.products = mapped;
        applyFilters();
        
      } catch (e) {
        console.warn('Error loading products:', e);
      }
    }

    /********************
     * Referral System
     ********************/
    
    // Generate a random referral code
    function generateReferralCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }
    
    // Get or create referral code for user
    async function getUserReferralInfo(userId) {
      if (!supabaseClient || !userId) return null;
      
      try {
        const { data: profileData, error: profileError } = await supabaseClient
          .from('profiles')
          .select('referral_code, id')
          .eq('user_id', userId)
          .maybeSingle();
        
        if (profileError) return null;
        
        let referralCode = null;
        
        if (!profileData) {
          const { data: userData } = await supabaseClient.auth.getUser();
          const userEmail = userData?.user?.email || '';
          
          referralCode = generateReferralCode();
          
          const { data: newProfile, error: createError } = await supabaseClient
            .from('profiles')
            .insert([{ 
              user_id: userId,
              email: userEmail,
              referral_code: referralCode,
              first_name: 'User',
              last_name: ''
            }])
            .select('referral_code')
            .single();
          
          if (createError) return null;
          referralCode = newProfile.referral_code;
        } else {
          referralCode = profileData.referral_code;
          
          if (!referralCode) {
            referralCode = generateReferralCode();
            
            const { error: updateError } = await supabaseClient
              .from('profiles')
              .update({ referral_code: referralCode })
              .eq('id', profileData.id);
            
            if (updateError) return null;
          }
        }
        
        return {
          code: referralCode,
          link: `${window.location.origin}?ref=${referralCode}`
        };
      } catch (e) {
        console.error('Error in getUserReferralInfo:', e);
        return null;
      }
    }
    
    // Get referrer from referral code
    async function getReferrerFromCode(referralCode) {
      if (!supabaseClient || !referralCode) return null;
      
      try {
        const { data, error } = await supabaseClient
          .from('profiles')
          .select('id, user_id, email, first_name, last_name')
          .eq('referral_code', referralCode)
          .single();
        
        if (error) return null;
        return data;
      } catch (e) {
        console.error('Error in getReferrerFromCode:', e);
        return null;
      }
    }
    
    // Create R20 discount code for new user (referee)
    async function createRefereeDiscountCode(refereeEmail, referralCode) {
      if (!supabaseClient) return null;
      
      try {
        const discountCode = `WELCOME${generateReferralCode().substring(0, 6)}`;
        const expiresAt = new Date();
        expiresAt.setMonth(expiresAt.getMonth() + 1);
        
        const { data, error } = await supabaseClient
          .from('discount_codes')
          .insert([{
            code: discountCode,
            amount: 20.00,
            used: false,
            expires_at: expiresAt.toISOString(),
            email: refereeEmail,
            referral_code: referralCode,
            type: 'referee_welcome'
          }])
          .select()
          .single();
        
        if (error) {
          console.error('Error creating referee discount:', error);
          return null;
        }
        
        return data;
      } catch (e) {
        console.error('Error in createRefereeDiscountCode:', e);
        return null;
      }
    }
    
    // Create R40 discount code for referrer
    async function createReferrerRewardCode(referrerUserId, refereeEmail, referralCode) {
      if (!supabaseClient || !referrerUserId) return null;
      
      try {
        const { data: referrerProfile, error: profileError } = await supabaseClient
          .from('profiles')
          .select('email')
          .eq('user_id', referrerUserId)
          .single();
        
        if (profileError) return null;
        
        const discountCode = `REFERRAL${generateReferralCode().substring(0, 6)}`;
        const expiresAt = new Date();
        expiresAt.setMonth(expiresAt.getMonth() + 3);
        
        const { data, error } = await supabaseClient
          .from('discount_codes')
          .insert([{
            user_id: referrerUserId,
            code: discountCode,
            amount: 40.00,
            used: false,
            expires_at: expiresAt.toISOString(),
            referral_reward: true,
            referee_email: refereeEmail,
            referral_code: referralCode,
            type: 'referrer_reward'
          }])
          .select()
          .single();
        
        if (error) {
          console.error('Error creating referrer reward:', error);
          return null;
        }
        
        return {
          ...data,
          referrer_email: referrerProfile.email
        };
      } catch (e) {
        console.error('Error in createReferrerRewardCode:', e);
        return null;
      }
    }
    
    // Check URL for referral parameter
    function checkUrlForReferral() {
      const urlParams = new URLSearchParams(window.location.search);
      const refCode = urlParams.get('ref');
      
      if (refCode) {
        if (modalSignupReferralCode) {
          modalSignupReferralCode.value = refCode;
        }
        
        try {
          localStorage.setItem('pending_referral', refCode);
        } catch (e) {}
      }
    }
    
    /********************
     * Update auth state handler
     ********************/
    function updateAuthUI(user) {
      currentUser = user;
      
      const signBtn = document.getElementById('signBtn');
      const profileBtnHeader = document.getElementById('profileBtnHeader');
      const mobileSignIn = document.getElementById('mobileSignIn');
      
      if (user) {
        if (signBtn) signBtn.style.display = 'none';
        if (mobileSignIn) mobileSignIn.textContent = 'Profile';
        if (profileBtnHeader) {
          profileBtnHeader.style.display = 'inline-flex';
          profileBtnHeader.onclick = function() {
            window.location.href = 'profile.html';
          };
        }
        updateReferralBanner(user);
        
        // Sync cart on login
        syncCartOnLogin(user);
      } else {
        if (signBtn) signBtn.style.display = 'inline-flex';
        if (mobileSignIn) mobileSignIn.textContent = 'Sign In / Sign Up';
        if (profileBtnHeader) profileBtnHeader.style.display = 'none';
        updateReferralBanner(null);
      }
    }
    
    // Update referral banner
    function updateReferralBanner(user) {
      const copyBtn = document.getElementById('copyReferral');
      const shareBtn = document.getElementById('shareBtn');
      const referralCodeDisplay = document.getElementById('referralCodeDisplay');
      const referralLinkDisplay = document.getElementById('referralLinkDisplay');
      const userReferralCodeEl = document.getElementById('userReferralCode');
      const userReferralLinkEl = document.getElementById('userReferralLink');
      
      if (!copyBtn || !shareBtn) return;
      
      const newCopyBtn = copyBtn.cloneNode(true);
      const newShareBtn = shareBtn.cloneNode(true);
      copyBtn.parentNode.replaceChild(newCopyBtn, copyBtn);
      shareBtn.parentNode.replaceChild(newShareBtn, shareBtn);
      
      const updatedCopyBtn = document.getElementById('copyReferral');
      const updatedShareBtn = document.getElementById('shareBtn');
      
      if (user) {
        getUserReferralInfo(user.id).then(info => {
          if (info) {
            userReferralInfo = info;
            userReferralCodeEl.textContent = info.code;
            userReferralLinkEl.textContent = info.link;
            referralCodeDisplay.style.display = 'block';
            referralLinkDisplay.style.display = 'block';
            
            updatedCopyBtn.addEventListener('click', function() {
              navigator.clipboard.writeText(info.code).then(() => {
                showNotification(`Referral code copied: ${info.code}`);
              });
            });
            
            updatedShareBtn.addEventListener('click', function() {
              if (navigator.share) {
                navigator.share({
                  title: 'Join Umzila!',
                  text: `Get R20 off your first order at Umzila with my referral code: ${info.code}`,
                  url: info.link
                });
              } else {
                navigator.clipboard.writeText(info.link).then(() => {
                  showNotification(`Referral link copied to clipboard: ${info.link}`);
                });
              }
            });
          }
        });
      } else {
        referralCodeDisplay.style.display = 'none';
        referralLinkDisplay.style.display = 'none';
        
        updatedCopyBtn.addEventListener('click', function() {
          showModal(loginModal);
        });
        
        updatedShareBtn.addEventListener('click', function() {
          showModal(loginModal);
        });
      }
    }

    /********************
     * Modal management
     ********************/
    function showModal(modal) {
      if (modal) {
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
      }
    }
    
    function hideModal(modal) {
      if (modal) {
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }
    }
    
    // Close buttons for modals
    if (loginModalClose) {
      loginModalClose.addEventListener('click', () => hideModal(loginModal));
    }
    
    if (signupModalClose) {
      signupModalClose.addEventListener('click', () => hideModal(signupModal));
    }
    
    if (forgotPasswordModalClose) {
      forgotPasswordModalClose.addEventListener('click', () => hideModal(forgotPasswordModal));
    }
    
    // Close modals when clicking outside
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        hideModal(e.target);
      }
    });

    /********************
     * AUTHENTICATION SYSTEM - UPDATED FOR MODALS
     ********************/
    
    // Password validation
    function checkPasswordRules(password) {
      const rules = {
        len: password && password.length >= 8,
        num: /[0-9]/.test(password || ''),
        spec: /[!@#$%^&*(),.?":{}|<>]/.test(password || '')
      };
      
      return rules.len && rules.num && rules.spec;
    }
    
    // Signup functionality with referral tracking
    if (modalSignupSubmit) {
      modalSignupSubmit.addEventListener('click', async function(e) {
        e.preventDefault();
        
        const errorElement = document.getElementById('modalSignupError');
        const successElement = document.getElementById('modalSignupSuccess');
        
        if (errorElement) {
          errorElement.style.display = 'none';
          errorElement.textContent = '';
        }
        if (successElement) successElement.style.display = 'none';
        
        const name = (modalSignupName && modalSignupName.value || '').trim();
        const email = (modalSignupEmail && modalSignupEmail.value || '').trim();
        const password = (modalSignupPassword && modalSignupPassword.value) || '';
        const referralCode = modalSignupReferralCode ? modalSignupReferralCode.value : '';
        
        if (!name || !email || !password) {
          if (errorElement) {
            errorElement.textContent = 'Please complete all fields.';
            errorElement.style.display = 'block';
          }
          return;
        }
        
        if (!checkPasswordRules(password)) {
          if (errorElement) {
            errorElement.textContent = 'Password does not meet the requirements.';
            errorElement.style.display = 'block';
          }
          return;
        }
        
        const client = supabaseClient;
        if (!client || !client.auth) {
          if (errorElement) {
            errorElement.textContent = 'Auth client not available.';
            errorElement.style.display = 'block';
          }
          return;
        }
        
        const signupSubmit = modalSignupSubmit;
        signupSubmit.disabled = true;
        const originalText = signupSubmit.textContent;
        signupSubmit.textContent = 'Creating account...';
        
        try {
          const options = { 
            data: { 
              full_name: name 
            } 
          };
          
          const { data, error } = await client.auth.signUp({ 
            email, 
            password 
          }, options);
          
          if (error) {
            console.error('Signup error:', error);
            if (errorElement) {
              errorElement.textContent = error.message || 'Sign up failed.';
              errorElement.style.display = 'block';
            }
            return;
          }
          
          const userId = data?.user?.id;
          let referrerId = null;
          let referrerCodeUsed = null;
          
          // Handle referral if a code was provided
          if (referralCode) {
            const referrer = await getReferrerFromCode(referralCode);
            if (referrer) {
              referrerId = referrer.user_id;
              referrerCodeUsed = referralCode;
              
              // Create R20 discount code for the NEW USER
              const refereeDiscount = await createRefereeDiscountCode(email, referralCode);
              
              if (refereeDiscount) {
                console.log(`R20 discount code created for new user: ${refereeDiscount.code}`);
              }
            }
          }
          
          // Create profile with referral info
          if (userId && client.from) {
            try {
              await client.from('profiles').upsert([{ 
                user_id: userId, 
                email: email,
                first_name: name.split(' ')[0] || name,
                last_name: name.split(' ').slice(1).join(' ') || '',
                referral_code: generateReferralCode(),
                referred_by: referrerId
              }], { 
                onConflict: 'user_id',
                returning: 'minimal' 
              });
              
              // Create a referral tracking record
              if (referrerId && referrerCodeUsed) {
                await client.from('referral_tracking').insert([{
                  referrer_id: referrerId,
                  referee_id: userId,
                  referral_code: referrerCodeUsed,
                  referee_email: email,
                  status: 'signed_up',
                  created_at: new Date().toISOString()
                }]);
              }
            } catch (profileError) {
              console.warn('Profile creation failed:', profileError);
            }
          }
          
          // Show success message
          if (successElement) {
            let successMsg = 'Account created! Check your email to verify your address.';
            if (referralCode && referrerId) {
              successMsg += '<br><strong>You will receive a R20 discount code via email!</strong>';
            }
            successElement.innerHTML = successMsg;
            successElement.style.display = 'block';
          }
          
          // Clear forms
          if (modalSignupName) modalSignupName.value = '';
          if (modalSignupEmail) modalSignupEmail.value = '';
          if (modalSignupPassword) modalSignupPassword.value = '';
          if (modalSignupReferralCode) modalSignupReferralCode.value = '';
          
          // Clear stored referral
          try {
            localStorage.removeItem('pending_referral');
          } catch (e) {}
          
          // Close modal after success
          setTimeout(() => {
            hideModal(signupModal);
            if (data?.session) {
              updateAuthUI(data.user);
            }
          }, 2000);
          
        } catch (err) {
          console.error('Unexpected signup error:', err);
          if (errorElement) {
            errorElement.textContent = err?.message || 'Unexpected error during signup.';
            errorElement.style.display = 'block';
          }
        } finally {
          signupSubmit.disabled = false;
          signupSubmit.textContent = originalText;
        }
      });
    }
    
    // Login functionality
    if (modalLoginSubmit) {
      modalLoginSubmit.addEventListener('click', async function(e) {
        e.preventDefault();
        
        const errorElement = document.getElementById('modalLoginError');
        const successElement = document.getElementById('modalLoginSuccess');
        
        if (errorElement) {
          errorElement.style.display = 'none';
          errorElement.textContent = '';
        }
        if (successElement) successElement.style.display = 'none';
        
        const email = (modalLoginEmail && modalLoginEmail.value || '').trim();
        const password = (modalLoginPassword && modalLoginPassword.value) || '';
        
        if (!email || !password) {
          if (errorElement) {
            errorElement.textContent = 'Please enter email and password.';
            errorElement.style.display = 'block';
          }
          return;
        }
        
        const client = supabaseClient;
        if (!client || !client.auth) {
          if (errorElement) {
            errorElement.textContent = 'Auth client not available.';
            errorElement.style.display = 'block';
          }
          return;
        }
        
        const loginSubmit = modalLoginSubmit;
        loginSubmit.disabled = true;
        const originalText = loginSubmit.textContent;
        loginSubmit.textContent = 'Signing in...';
        
        try {
          const { data, error } = await client.auth.signInWithPassword({ 
            email, 
            password 
          });
          
          if (error) {
            console.error('Login error:', error);
            if (errorElement) {
              errorElement.textContent = error.message || 'Wrong credentials or email not registered.';
              errorElement.style.display = 'block';
            }
            return;
          }
          
          const user = data?.user;
          if (!user) {
            if (errorElement) {
              errorElement.textContent = 'No user returned from auth.';
              errorElement.style.display = 'block';
            }
            return;
          }
          
          if (successElement) {
            successElement.textContent = 'Signed in successfully!';
            successElement.style.display = 'block';
          }
          
          updateAuthUI(user);
          
          setTimeout(() => {
            hideModal(loginModal);
            if (modalLoginEmail) modalLoginEmail.value = '';
            if (modalLoginPassword) modalLoginPassword.value = '';
          }, 1000);
          
        } catch (err) {
          console.error('Unexpected login error:', err);
          if (errorElement) {
            errorElement.textContent = err?.message || 'Unexpected error during sign in.';
            errorElement.style.display = 'block';
          }
        } finally {
          loginSubmit.disabled = false;
          loginSubmit.textContent = originalText;
        }
      });
    }

    // Forgot password functionality
    if (modalForgotPassword) {
      modalForgotPassword.addEventListener('click', function(e) {
        e.preventDefault();
        hideModal(loginModal);
        showModal(forgotPasswordModal);
      });
    }
    
    if (modalForgotPasswordCancel) {
      modalForgotPasswordCancel.addEventListener('click', function(e) {
        e.preventDefault();
        hideModal(forgotPasswordModal);
        showModal(loginModal);
      });
    }
    
    if (modalForgotPasswordSubmit) {
      modalForgotPasswordSubmit.addEventListener('click', async function(e) {
        e.preventDefault();
        
        const email = modalForgotPasswordEmail.value.trim();
        const errorElement = document.getElementById('modalForgotPasswordError');
        const successElement = document.getElementById('modalForgotPasswordSuccess');
        
        if (!email) {
          if (errorElement) {
            errorElement.textContent = 'Please enter your email address.';
            errorElement.style.display = 'block';
          }
          return;
        }
        
        if (!supabaseClient) {
          if (errorElement) {
            errorElement.textContent = 'Auth client not available.';
            errorElement.style.display = 'block';
          }
          return;
        }
        
        const submitBtn = modalForgotPasswordSubmit;
        submitBtn.disabled = true;
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Sending...';
        
        try {
          const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
            redirectTo: `${window.location.origin}/reset-password.html`
          });
          
          if (error) {
            console.error('Password reset error:', error);
            if (errorElement) {
              errorElement.textContent = error.message || 'Failed to send reset email.';
              errorElement.style.display = 'block';
            }
            return;
          }
          
          if (successElement) {
            successElement.textContent = 'Password reset email sent! Check your inbox.';
            successElement.style.display = 'block';
          }
          
          // Clear email field
          modalForgotPasswordEmail.value = '';
          
          // Close modal after 3 seconds
          setTimeout(() => {
            hideModal(forgotPasswordModal);
          }, 3000);
          
        } catch (err) {
          console.error('Unexpected reset error:', err);
          if (errorElement) {
            errorElement.textContent = err?.message || 'Unexpected error.';
            errorElement.style.display = 'block';
          }
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    }

    // Modal navigation
    if (modalOpenSignup) {
      modalOpenSignup.addEventListener('click', function(e) {
        e.preventDefault();
        hideModal(loginModal);
        showModal(signupModal);
      });
    }
    
    if (modalOpenLogin) {
      modalOpenLogin.addEventListener('click', function(e) {
        e.preventDefault();
        hideModal(signupModal);
        showModal(loginModal);
      });
    }

    /********************
     * Auth State Management
     ********************/
    async function checkInitialAuthState() {
      if (!supabaseClient || !supabaseClient.auth) return;
      
      try {
        const { data } = await supabaseClient.auth.getUser();
        const user = data?.user;
        updateAuthUI(user);
      } catch (e) {
        console.warn('Auth state check failed:', e);
      }
    }
    
    // Listen for auth state changes
    if (supabaseClient && supabaseClient.auth) {
      supabaseClient.auth.onAuthStateChange((event, session) => {
        const user = session?.user || null;
        updateAuthUI(user);
      });
    }

    /********************
     * Product data (fallback)
     ********************/
    const fallbackProducts = [
      { id:1, title:'Campus Hoodie ‚Äî Charcoal', price:350, category:'Hoodies', imgs:['Hoodie+1','Hoodie+1+back'], size:['S','M','L','XL'], badge:'Hot', stock:3, type:'New', color:'Black', popularity: 95, desc:'Cozy campus hoodie ‚Äî premium cotton blend.'},
      { id:2, title:'Graphic Tee ‚Äî White', price:150, category:'T-Shirts', imgs:['Tee+1','Tee+1+back'], size:['S','M','L'], badge:'New', stock:12, type:'New', color:'White', popularity: 88, desc:'Lightweight graphic tee.'},
      { id:3, title:'Street Cap ‚Äî Snapback', price:120, category:'Caps', imgs:['Cap+1','Cap+1+side'], size:['One'], badge:'Trending', stock:10, type:'Pre-owned', color:'Black', popularity:75, desc:'Classic snapback.'},
      { id:4, title:'Mystery Box #1', price:150, category:'Mystery Boxes', imgs:['Box+1'], size:['M'], badge:'Limited', stock:5, type:'New', color:'Mixed', popularity:70, desc:'Random goodies ‚Äî value pack.'},
      { id:5, title:'Retro Joggers', price:299, category:'Bottoms', imgs:['Joggers+1','Joggers+back'], size:['M','L','XL'], badge:'Hot', stock:2, type:'New', color:'Blue', popularity:90, desc:'Comfort joggers with tapered leg.'},
      { id:6, title:'Beanie ‚Äî Knit', price:100, category:'Accessories', imgs:['Beanie+1'], size:['One'], badge:'New', stock:20, type:'New', color:'Red', popularity:50, desc:'Warm knit beanie.'},
      { id:7, title:'Street Sneakers', price:450, category:'Tops', imgs:['Sneakers+1','Sneakers+side'], size:['8','9','10'], badge:'Hot', stock:4, type:'New', color:'White', popularity:92, desc:'Comfort sneakers.'},
      { id:8, title:'Bundle: Tee + Cap', price:420, category:'Bundles', imgs:['Bundle+1'], size:['M'], badge:'Bundle', stock:6, type:'New', color:'Black', popularity:78, desc:'Value combo pack.'},
      { id:9, title:'Pre-loved Vintage Tee', price:89, category:'T-Shirts', imgs:['Vintage+Tee'], size:['M','L'], badge:'Pre-owned', stock:1, type:'Pre-owned', color:'Green', popularity:60, desc:'Gently used vintage tee.'},
      { id:10, title:'Mystery Box #2', price:200, category:'Mystery Boxes', imgs:['Box+2'], size:['L'], badge:'Limited', stock:3, type:'New', color:'Mixed', popularity:65, desc:'Premium mystery box.'}
    ];

    // convert imgs to picsum seeded urls (keeps visual randomness but consistent per product)
    fallbackProducts.forEach(p=>{
      const base = encodeURIComponent(p.title.replace(/\s+/g,'_') + '_' + p.id);
      p.imgs = p.imgs.map((s,i)=>`https://picsum.photos/seed/${base}${i?'-'+i:''}/400/300`);
    });

    // set logos directly
    document.getElementById('logoImg').src = 'umzila.webp';
    document.getElementById('footerLogo').src = 'umzila.webp';

    /********************
     * Store for filter options from Supabase - UPDATED FOR CORRECT FILTERING
     ********************/
    let filterOptions = {
      categories: ['All'],
      sizes: [],
      types: ['All'],
      colors: ['Any'],
      tags: ['Any'],
      priceRange: { min: 0, max: 0 }
    };

    /********************
     * HERO init (unchanged behavior)
     ********************/
    const heroPlaceholders = [
      `thumbnail1.webp`,
      `https://picsum.photos/seed/hero_mystery/1200/400`,
      `https://picsum.photos/seed/hero_new/1200/400`,
      `https://picsum.photos/seed/hero_flash/1200/400`
    ];
    Array.from(document.querySelectorAll('.slide')).forEach((el,idx)=>{ el.style.backgroundImage = `url("${heroPlaceholders[idx]}")`; el.style.backgroundSize='cover'; el.style.backgroundPosition='center'; });

    let slideIndex = 0; const slideCount = slides.children.length;
    function makeDots(){ for(let i=0;i<slideCount;i++){ const d=document.createElement('div'); d.className='dot'; if(i===0) d.classList.add('active'); d.addEventListener('click',()=>goToSlide(i)); dots.appendChild(d);} }
    function goToSlide(i){ slideIndex = i; slides.style.transform = 'translateX('+(-i*100)+'%)'; Array.from(dots.children).forEach((d,idx)=>d.classList.toggle('active', idx===i)); }
    makeDots(); let heroTimer = setInterval(()=>goToSlide((slideIndex+1)%slideCount),4000);
    document.getElementById('hero').addEventListener('mouseenter',()=>clearInterval(heroTimer)); document.getElementById('hero').addEventListener('mouseleave',()=>heroTimer = setInterval(()=>goToSlide((slideIndex+1)%slideCount),4000));
    prevBtn.addEventListener('click',()=>goToSlide((slideIndex-1+slideCount)%slideCount)); nextBtn.addEventListener('click',()=>goToSlide((slideIndex+1)%slideCount));

    /********************
     * SEARCH predictive + clear/backspace behavior (as requested)
     ********************/
    function updateSuggestions(q){ suggestions.innerHTML=''; if(!q){ suggestions.style.display='none'; return;}
      const termsLocal = Array.from(new Set(state.products.concat(fallbackProducts).flatMap(p=>[p.title,p.category,p.badge].map(t=>t))));
      const found = termsLocal.filter(t=>t && t.toLowerCase().includes(q.toLowerCase())).slice(0,8);
      found.forEach(f=>{ const d=document.createElement('div'); d.textContent=f; d.addEventListener('click',()=>{ searchInput.value=f; suggestions.style.display='none'; state.filters.search = f; applyFilters(); }); suggestions.appendChild(d); });
      suggestions.style.display = found.length? 'block':'none';
    }

    searchInput.addEventListener('input',(e)=>{ const q=e.target.value; if(q && q.length>0) searchClear.style.display='block'; else searchClear.style.display='none'; updateSuggestions(q); });

    // Clear button: restore state before search (clear search filter and re-run filters)
    searchClear.addEventListener('click', ()=>{ searchInput.value=''; searchClear.style.display='none'; suggestions.style.display='none'; state.filters.search=''; applyFilters(); });

    // Backspace behavior
    searchInput.addEventListener('keydown',(e)=>{
      if(e.key==='Backspace'){
        setTimeout(()=>{
          const q = searchInput.value;
          if(!q){ searchClear.style.display='none'; suggestions.style.display='none'; state.filters.search=''; applyFilters(); }
          else { updateSuggestions(q); }
        },0);
      }
      if(e.key==='Enter'){
        state.filters.search = searchInput.value.trim(); applyFilters(); suggestions.style.display='none';
      }
    });

    document.addEventListener('click',(e)=>{ if(!searchInput.contains(e.target) && !suggestions.contains(e.target)) suggestions.style.display='none'; });

    /********************
     * Filtering / Sorting (updated for new price filters)
     ********************/
    function applyFilters(){ 
      const f = state.filters; 
      let out = state.products.filter(p=>{ 
        if(f.category!=='All' && p.category!==f.category) return false; 
        
        // Price filtering with min and max
        const price = p.sale && p.salePrice ? p.salePrice : p.price;
        if(f.priceMin !== null && price < f.priceMin) return false;
        if(f.priceMax !== null && price > f.priceMax) return false;
        
        if(f.sizes.length && !f.sizes.some(s=>p.size && p.size.includes(s))) return false; 
        if(f.type!=='All' && p.type!==f.type) return false; 
        if(f.color!=='Any' && p.color!==f.color) return false;
        if(f.tag!=='Any' && p.tags && !p.tags.includes(f.tag)) return false; 
        if(f.search && !((p.title+p.desc+p.category).toLowerCase().includes(f.search.toLowerCase()))) return false; 
        return true; 
      }); 
      
      // Sorting
      if(f.sort==='price-asc') out.sort((a,b)=> {
        const priceA = a.sale && a.salePrice ? a.salePrice : a.price;
        const priceB = b.sale && b.salePrice ? b.salePrice : b.price;
        return priceA - priceB;
      }); 
      else if(f.sort==='price-desc') out.sort((a,b)=> {
        const priceA = a.sale && a.salePrice ? a.salePrice : a.price;
        const priceB = b.sale && b.salePrice ? b.salePrice : b.price;
        return priceB - priceA;
      }); 
      else if(f.sort==='new') out.sort((a,b)=>b.id - a.id); 
      else out.sort((a,b)=> (b.popularity||0) - (a.popularity||0)); 
      
      renderAll(out); 
      
      // Update filter summary
      let summaryParts = [];
      if(f.category !== 'All') summaryParts.push(f.category);
      if(f.priceMin !== null || f.priceMax !== null) {
        const minStr = f.priceMin !== null ? `R${f.priceMin}` : 'Min';
        const maxStr = f.priceMax !== null ? `R${f.priceMax}` : 'Max';
        summaryParts.push(`${minStr} - ${maxStr}`);
      }
      if(f.type !== 'All') summaryParts.push(f.type);
      if(f.color !== 'Any') summaryParts.push(f.color);
      if(f.tag !== 'Any') summaryParts.push(f.tag);
      if(f.sizes.length) summaryParts.push(`Sizes: ${f.sizes.join(',')}`);
      if(f.search) summaryParts.push(`Search: ${f.search}`);
      
      filterSummary.textContent = summaryParts.length > 0 ? summaryParts.join(' ‚Ä¢ ') : 'None';
    }

    /********************
     * Event listeners for new filter elements
     ********************/
    priceMin.addEventListener('change',(e)=>{
      state.filters.priceMin = e.target.value === 'min' ? null : Number(e.target.value);
      applyFilters();
    });

    priceMax.addEventListener('change',(e)=>{
      state.filters.priceMax = e.target.value === 'max' ? null : Number(e.target.value);
      applyFilters();
    });

    catList.addEventListener('click',(e)=>{ 
      if(e.target.tagName==='LI'){ 
        Array.from(catList.querySelectorAll('li')).forEach(li=>li.classList.remove('active')); 
        e.target.classList.add('active'); 
        state.filters.category = e.target.dataset.cat; 
        applyFilters(); 
      }
    });

    colorSel.addEventListener('change', (e)=>{ 
      state.filters.color = e.target.value; 
      applyFilters(); 
    });

    tagSel.addEventListener('change', (e)=>{ 
      state.filters.tag = e.target.value; 
      applyFilters(); 
    });

    document.getElementById('sortSel').addEventListener('change', (e)=>{ 
      state.filters.sort = e.target.value; 
      topSort.value = e.target.value; 
      applyFilters(); 
    });

    topSort.addEventListener('change',(e)=>{ 
      state.filters.sort = e.target.value; 
      document.getElementById('sortSel').value = e.target.value; 
      applyFilters(); 
    });

    /********************
     * Clear filters function (updated for new filters)
     ********************/
    clearFilters.addEventListener('click',()=>{ 
      state.filters = { 
        category:'All', 
        priceMin: null, 
        priceMax: null, 
        sizes:[], 
        type:'All', 
        color:'Any', 
        search:'', 
        sort:'popular',
        tag: 'Any'
      }; 
      
      // Reset UI elements
      priceMin.value = 'min';
      priceMax.value = 'max';
      document.querySelectorAll('input[name="size"]').forEach(i=>i.checked=false);
      document.querySelector('input[name="type"][value="All"]').checked=true;
      colorSel.value='Any';
      tagSel.value='Any';
      document.getElementById('sortSel').value='popular';
      topSort.value='popular';
      searchInput.value='';
      searchClear.style.display='none';
      suggestions.style.display='none';
      
      // Reset active category
      Array.from(catList.querySelectorAll('li')).forEach(li=>li.classList.remove('active'));
      catList.querySelector('li[data-cat="All"]').classList.add('active');
      
      applyFilters(); 
    });

    /********************
     * Deal buttons (updated for new price filters)
     ********************/
    document.getElementById('dealsBtn').addEventListener('click',()=>{ 
      state.filters.priceMax = 400; 
      priceMax.value = '400'; 
      applyFilters(); 
    });

    document.getElementById('studentBtn').addEventListener('click',()=>{ 
      state.filters.priceMax = 200; 
      priceMax.value = '200'; 
      applyFilters(); 
    });

    /********************
     * Lazy Loading Implementation
     ********************/
    function setupLazyLoading() {
      // Use Intersection Observer for lazy loading
      const lazyLoadObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            if (img.dataset.src) {
              img.src = img.dataset.src;
              img.removeAttribute('data-src');
            }
            observer.unobserve(img);
          }
        });
      }, {
        rootMargin: '50px 0px',
        threshold: 0.1
      });
      
      // Observe all product images
      document.addEventListener('DOMContentLoaded', () => {
        const lazyImages = document.querySelectorAll('img[data-src]');
        lazyImages.forEach(img => {
          lazyLoadObserver.observe(img);
        });
      });
      
      // Also observe dynamically added images
      const originalRenderAll = renderAll;
      renderAll = function(products) {
        originalRenderAll.call(this, products);
        
        // Set up lazy loading for newly added images
        setTimeout(() => {
          const newLazyImages = document.querySelectorAll('img[data-src]');
          newLazyImages.forEach(img => {
            lazyLoadObserver.observe(img);
          });
        }, 100);
      };
    }

    /********************
     * Rendering helpers (updated with lazy loading)
     ********************/
    function makeCardHTML(p){ 
      // Check if product is on sale
      const isOnSale = p.sale || false;
      const salePrice = p.salePrice || 0;
      const displayPrice = isOnSale ? salePrice : p.price;
      const originalPrice = isOnSale ? p.price : null;
      
      // Get images from product_images if available
      const primaryImage = p.primary_image || (p.imgs && p.imgs[0]) || svgPlaceholder(p.title,400,300);
      const secondaryImage = p.secondary_image || (p.imgs && p.imgs[1]) || null;
      
      // Get available stock
      const totalStock = p.stock || 0;
      
      // Determine loading attribute - lazy load all except first few items
      const shouldLazyLoad = true; // We'll use Intersection Observer for all
      
      return `<div class="product-card fade-up" data-id="${p.id}">
        <div class="product-media" role="button" aria-label="Open ${p.title}">
          <div class="badges">
            ${p.badge?`<span class="badge ${p.badge === 'Sale' ? 'sale' : ''}">${p.badge}</span>`:''}
            ${isOnSale && !p.badge ? '<span class="badge sale">Sale</span>' : ''}
          </div>
          <img src="${svgPlaceholder(p.title,400,300,'#f0f0f0','#999')}" data-src="${primaryImage}" loading="lazy" alt="${p.title}" onerror="this.src='${svgPlaceholder(p.title,400,300)}'; this.removeAttribute('data-src')">
          ${secondaryImage ? `<img class="secondary" src="${svgPlaceholder(p.title,400,300,'#f0f0f0','#999')}" data-src="${secondaryImage}" loading="lazy" alt="${p.title} back" onerror="this.src='${svgPlaceholder(p.title,400,300)}'; this.removeAttribute('data-src')">` : ''}
          <div class="quick-add" data-id="${p.id}">+ Quick add</div>
        </div>
        <div class="card-body">
          <div class="title">${p.title}</div>
          <div class="meta">
            <div style="font-size:13px">${p.color || ''} ${totalStock > 0 ? `‚Ä¢ ${totalStock} left` : '‚Ä¢ Out of stock'}</div>
            <div class="price">
              ${isOnSale && originalPrice ? 
                `<span class="original">${format(originalPrice)}</span>` : ''}
              ${format(displayPrice)}
            </div>
          </div>
          <div class="controls">
            <select class="size-select">${(p.size||['M']).map(s=>`<option>${s}</option>`).join('')}</select>
            <select class="qty"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
            <button class="add-btn" data-id="${p.id}">Add</button>
          </div>
        </div>
      </div>`; 
    }

    function renderAll(products){
      const visible = products || state.products;
      resultCount.textContent = visible.length;

      // hot (prioritise badge 'hot' case-insensitive)
      hotGrid.innerHTML = visible.filter(p=> (p.badge||'').toString().toLowerCase()==='hot' || (p.popularity||0) > 85 ).slice(0,12).map(p=>`<div style="min-width:220px">${makeCardHTML(p)}</div>`).join('') || '<div style="padding:12px;color:var(--muted)">No hot deals</div>';

      // mystery boxes as hscroll like trending
      mysteryGrid.innerHTML = visible.filter(p=>p.category==='Mystery Boxes').slice(0,12).map(p=>`<div style="min-width:220px">${makeCardHTML(p)}</div>`).join('') || '<div style="padding:12px;color:var(--muted)">No mystery boxes</div>';

      // trending scroll (sorted by popularity)
      trendingScroll.innerHTML = visible.slice().sort((a,b)=> (b.popularity||0)-(a.popularity||0)).slice(0,12).map(p=>{ return `<div style="min-width:200px">${makeCardHTML(p)}</div>` }).join('');

      // bundles
      bundlesScroll.innerHTML = visible.filter(p=>p.category==='Bundles').slice(0,12).map(p=>`<div style="min-width:240px">${makeCardHTML(p)}</div>`).join('') || '<div style="color:var(--muted);padding:12px">No bundles</div>';

      // recommended (use current filtered results)
      recScroll.innerHTML = visible.slice(0,12).map(p=>`<div style="min-width:200px">${makeCardHTML(p)}</div>`).join('');

      attachProductListeners();
      runReveal();
    }

    /********************
     * Get variant stock for specific size
     ********************/
    function getVariantStock(product, size) {
      if (!product.variants || product.variants.length === 0) {
        return product.stock || 0;
      }
      
      const variant = product.variants.find(v => v.size === size);
      return variant ? (variant.stock || 0) : 0;
    }
    
    /********************
     * Get variant for specific size
     ********************/
    function getVariant(product, size) {
      if (!product.variants || product.variants.length === 0) {
        return null;
      }
      
      return product.variants.find(v => v.size === size) || null;
    }

    /********************
     * Product interactions: open modal, add to cart
     ********************/
    function attachProductListeners(){ 
      document.querySelectorAll('.product-card').forEach(card=>{ 
        const media = card.querySelector('.product-media'); 
        if (media) media.addEventListener('click',()=>openProductModal(card.dataset.id)); 
        
        card.querySelectorAll('.add-btn').forEach(btn=>btn.addEventListener('click',(ev)=>{ 
          ev.stopPropagation(); 
          const id=btn.dataset.id ? Number(btn.dataset.id) : Number(btn.getAttribute('data-id')); 
          const qty = Number(btn.previousElementSibling.value||1); 
          const size = btn.parentElement.querySelector('.size-select').value; 
          
          const product = state.products.find(x=>x.id===id);
          if (!product) return;
          
          // Check stock
          const variantStock = getVariantStock(product, size);
          if (variantStock < qty) {
            alert(`Only ${variantStock} items available for size ${size}`);
            return;
          }
          
          addToCart(product.id, qty, size);
        })); 
        
        const q = card.querySelector('.quick-add'); 
        if (q) q.addEventListener('click',(ev)=>{ 
          ev.stopPropagation(); 
          const id = Number(q.dataset.id);
          const product = state.products.find(x=>x.id===id);
          if (product) {
            openQuickAddModal(product);
          }
        }); 
      }); 
    }

    /********************
     * Open quick add modal
     ********************/
    function openQuickAddModal(product) {
      currentQuickAddProduct = product;
      
      // Populate size dropdown
      quickAddSize.innerHTML = '';
      product.size.forEach(size => {
        const option = document.createElement('option');
        option.value = size;
        option.textContent = size;
        quickAddSize.appendChild(option);
      });
      
      // Update stock info
      updateQuickAddStockInfo();
      
      // Show modal
      quickAddModal.classList.add('open');
      quickAddStockError.style.display = 'none';
    }
    
    /********************
     * Update quick add stock info
     ********************/
    function updateQuickAddStockInfo() {
      if (!currentQuickAddProduct) return;
      
      const selectedSize = quickAddSize.value;
      const stock = getVariantStock(currentQuickAddProduct, selectedSize);
      quickAddStockInfo.textContent = `${stock} items available`;
      
      // Update max quantity
      const selectedQty = parseInt(quickAddQty.value);
      if (selectedQty > stock) {
        quickAddStockError.style.display = 'block';
      } else {
        quickAddStockError.style.display = 'none';
      }
    }

    /********************
     * UPDATED PRODUCT MODAL - REDESIGNED (as requested)
     ********************/
    let currentModalProduct = null;
    
    async function openProductModal(id) {
      currentModalProduct = state.products.find(x => x.id == id);
      if (!currentModalProduct) return;
      
      try {
        // Get the most popular product for bundle suggestion (excluding current product)
        const bundleProduct = state.products
          .filter(p => p.id !== id)
          .sort((a, b) => (b.popularity || 0) - (a.popularity || 0))[0];
        
        // Generate description with "see more" functionality
        const words = currentModalProduct.desc ? currentModalProduct.desc.split(' ') : [];
        const shortDescription = words.slice(0, 10).join(' ') + (words.length > 10 ? '...' : '');
        const fullDescription = currentModalProduct.desc || '';
        const hasLongDescription = words.length > 10;
        
        // Generate size options
        const sizes = currentModalProduct.size || ['M'];
        const sizeOptions = sizes.map(size => 
          `<div class="size-option" data-size="${size}">${size}</div>`
        ).join('');
        
        // Generate color options (if available)
        let colorOptionsHTML = '';
        if (currentModalProduct.color) {
          colorOptionsHTML = `
            <div class="product-modal-colors">
              <h3>Color</h3>
              <div class="color-options">
                <div class="color-option selected" data-color="${currentModalProduct.color}" style="background-color: ${currentModalProduct.color.toLowerCase() === 'black' ? '#000' : currentModalProduct.color.toLowerCase() === 'white' ? '#fff' : currentModalProduct.color.toLowerCase() === 'blue' ? '#3a86ff' : '#ddd'}"></div>
              </div>
            </div>
          `;
        }
        
        // Generate thumbnails
        const images = currentModalProduct.all_images || currentModalProduct.imgs || [];
        const thumbnails = images.map((img, index) => 
          `<div class="product-thumbnail ${index === 0 ? 'active' : ''}" data-image="${img}">
            <img src="${img}" alt="${currentModalProduct.title} thumbnail ${index + 1}" loading="lazy">
          </div>`
        ).join('');
        
        // Generate bundle suggestion HTML
        let bundleSuggestionHTML = '';
        if (bundleProduct) {
          bundleSuggestionHTML = `
            <div class="bundle-suggestion">
              <div class="bundle-product-image">
                <img src="${bundleProduct.primary_image || (bundleProduct.imgs && bundleProduct.imgs[0]) || svgPlaceholder(bundleProduct.title,80,80)}" alt="${bundleProduct.title}" loading="lazy">
              </div>
              <div class="bundle-info">
                <div class="bundle-title">Bundle with "${bundleProduct.title}"</div>
                <div class="bundle-text">Get free shipping when you buy 2+ items!</div>
                <button class="bundle-button" data-bundle-id="${bundleProduct.id}">Add Bundle</button>
              </div>
            </div>
          `;
        }
        
        // Check if product is on sale
        const isOnSale = currentModalProduct.sale || false;
        const salePrice = currentModalProduct.salePrice || 0;
        const displayPrice = isOnSale ? salePrice : currentModalProduct.price;
        const originalPrice = isOnSale ? currentModalProduct.price : null;
        
        const modalContent = document.getElementById('productModalContent');
        modalContent.innerHTML = `
          <div class="product-modal-images">
            <div class="product-modal-main-image">
              <img src="${images[0] || svgPlaceholder(currentModalProduct.title,400,300)}" alt="${currentModalProduct.title}" id="main-product-image" loading="lazy">
            </div>
            <div class="product-modal-thumbnails">
              ${thumbnails}
            </div>
          </div>
          <div class="product-modal-details">
            <h1 class="product-modal-title">${currentModalProduct.title}</h1>
            <div class="product-modal-rating">
              <div class="stars" style="color: #ffd700; font-size: 16px;">
                ${'‚òÖ'.repeat(5)}
              </div>
              <span>5.0 (1 review)</span>
            </div>
            <div class="product-modal-price">
              R${displayPrice.toFixed(2)}
              ${isOnSale && originalPrice ? 
                `<span class="product-modal-original-price">R${originalPrice.toFixed(2)}</span>` : ''}
            </div>
            
            <div class="product-modal-sizes">
              <h3>Size</h3>
              <div class="size-options">
                ${sizeOptions}
              </div>
            </div>
            
            ${colorOptionsHTML}
            
            <div class="product-modal-quantity">
              <h3>Quantity</h3>
              <div class="quantity-selector">
                <button class="quantity-btn" id="decrease-qty">-</button>
                <span class="quantity-value" id="quantity-value">1</span>
                <button class="quantity-btn" id="increase-qty">+</button>
              </div>
            </div>
            
            ${bundleSuggestionHTML}
            
            <button class="product-modal-add-to-cart" id="modal-add-to-cart" data-id="${currentModalProduct.id}">Add to Cart</button>
            
            <div class="product-modal-description">
              <h3>Description</h3>
              <div class="description-text ${hasLongDescription ? 'collapsed' : ''}" id="product-description">
                ${hasLongDescription ? shortDescription : fullDescription}
              </div>
              ${hasLongDescription ? '<button class="see-more-btn" id="see-more-btn">See More</button>' : ''}
            </div>
          </div>
        `;
        
        // Show modal
        modal.classList.add('active');
        
        // Add event listeners for the modal
        setupProductModalEvents(bundleProduct);
        
      } catch (error) {
        console.error('Error opening product modal:', error);
      }
    }
    
    /********************
     * Setup product modal events
     ********************/
    function setupProductModalEvents(bundleProduct) {
      // Thumbnail click
      document.querySelectorAll('.product-thumbnail').forEach(thumb => {
        thumb.addEventListener('click', function() {
          const imageUrl = this.dataset.image;
          document.getElementById('main-product-image').src = imageUrl;
          
          // Update active thumbnail
          document.querySelectorAll('.product-thumbnail').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
        });
      });
      
      // Size selection
      document.querySelectorAll('.size-option').forEach(option => {
        option.addEventListener('click', function() {
          document.querySelectorAll('.size-option').forEach(o => o.classList.remove('selected'));
          this.classList.add('selected');
        });
      });
      
      // Color selection
      document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
          document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
          this.classList.add('selected');
        });
      });
      
      // Quantity controls
      document.getElementById('increase-qty').addEventListener('click', function() {
        const valueElement = document.getElementById('quantity-value');
        let value = parseInt(valueElement.textContent);
        valueElement.textContent = value + 1;
      });
      
      document.getElementById('decrease-qty').addEventListener('click', function() {
        const valueElement = document.getElementById('quantity-value');
        let value = parseInt(valueElement.textContent);
        if (value > 1) {
          valueElement.textContent = value - 1;
        }
      });
      
      // See more button
      const seeMoreBtn = document.getElementById('see-more-btn');
      if (seeMoreBtn) {
        seeMoreBtn.addEventListener('click', function() {
          const descriptionElement = document.getElementById('product-description');
          if (descriptionElement.classList.contains('collapsed')) {
            descriptionElement.textContent = currentModalProduct.desc;
            descriptionElement.classList.remove('collapsed');
            this.textContent = 'See Less';
          } else {
            const words = currentModalProduct.desc.split(' ');
            const shortDescription = words.slice(0, 10).join(' ') + '...';
            descriptionElement.textContent = shortDescription;
            descriptionElement.classList.add('collapsed');
            this.textContent = 'See More';
          }
        });
      }
      
      // Bundle button
      const bundleButton = document.querySelector('.bundle-button');
      if (bundleButton && bundleProduct) {
        bundleButton.addEventListener('click', function() {
          const bundleProductId = this.getAttribute('data-bundle-id');
          const selectedSize = document.querySelector('.size-option.selected')?.dataset.size || currentModalProduct.size[0];
          const quantity = parseInt(document.getElementById('quantity-value').textContent);
          
          // Add both products to cart
          addToCart(currentModalProduct.id, quantity, selectedSize);
          addToCart(bundleProductId, 1, bundleProduct.size[0]);
          
          // Show notification
          showNotification(`Added ${currentModalProduct.title} and ${bundleProduct.title} to cart for free shipping!`);
          
          // Close modal
          modal.classList.remove('active');
        });
      }
      
      // Modal add to cart
      document.getElementById('modal-add-to-cart').addEventListener('click', function() {
        const productId = this.dataset.id;
        const quantity = parseInt(document.getElementById('quantity-value').textContent);
        const selectedSize = document.querySelector('.size-option.selected')?.dataset.size || currentModalProduct.size[0];
        
        // Check stock
        const variantStock = getVariantStock(currentModalProduct, selectedSize);
        if (variantStock < quantity) {
          alert(`Only ${variantStock} items available for size ${selectedSize}`);
          return;
        }
        
        addToCart(productId, quantity, selectedSize);
        showNotification(`Added ${quantity} "${currentModalProduct.title}" to cart!`);
        modal.classList.remove('active');
      });
      
      // Select first size and color by default
      if (document.querySelector('.size-option')) {
        document.querySelector('.size-option').classList.add('selected');
      }
      if (document.querySelector('.color-option')) {
        document.querySelector('.color-option').classList.add('selected');
      }
    }

    // Close product modal
    modalClose.addEventListener('click', () => {
      modal.classList.remove('active');
    });
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('active');
      }
    });

    /********************
     * Sidebar open/close behavior
     ********************/
    function setSidebarCollapsed(collapsed){ 
      if(collapsed){ 
        sidebar.classList.add('collapsed'); 
        document.documentElement.style.setProperty('--sidebar-w','0px'); 
        document.getElementById('mainContent').classList.add('full'); 
      } else { 
        const needed = Math.min(Math.max(180, sidebar.scrollWidth || 220), 340); 
        document.documentElement.style.setProperty('--sidebar-w', needed+'px'); 
        sidebar.style.setProperty('--w', needed+'px'); 
        sidebar.classList.remove('collapsed'); 
        document.getElementById('mainContent').classList.remove('full'); 
      } 
      runReveal(); 
    }

    // Mobile sidebar functionality
    const mobileSidebarClose = document.getElementById('mobileSidebarClose');
    if (mobileSidebarClose) {
      mobileSidebarClose.addEventListener('click', () => {
        sidebar.classList.remove('mobile-active');
      });
    }

    // Show sidebar on mobile when hamburger is clicked (for filters)
    if (leftHamburger) {
      leftHamburger.addEventListener('click', (e) => {
        if (isMobile()) {
          e.preventDefault();
          sidebar.classList.add('mobile-active');
        } else {
          setSidebarCollapsed(!sidebar.classList.contains('collapsed'));
        }
      });
    }

    if (sidebarToggleBtn) {
      sidebarToggleBtn.addEventListener('click', (e) => {
        if (isMobile()) {
          e.preventDefault();
          sidebar.classList.add('mobile-active');
        } else {
          setSidebarCollapsed(!sidebar.classList.contains('collapsed'));
        }
      });
    }

    // Start with sidebar OPEN
    setSidebarCollapsed(false);

    window.addEventListener('resize', ()=>{ 
      if(!sidebar.classList.contains('collapsed')){ 
        const needed = Math.min(Math.max(180, sidebar.scrollWidth || 220), 340); 
        document.documentElement.style.setProperty('--sidebar-w',needed+'px'); 
        sidebar.style.setProperty('--w',needed+'px'); 
      } 
      runReveal(); 
    });

    /********************
     * Full-screen "See more" panel
     ********************/
    function openSectionView(key){ 
      panelContent.innerHTML=''; 
      panelTitle.textContent = key.title||'Items'; 
      let items=[]; 
      if(key.type==='mystery') items=state.products.filter(p=>p.category==='Mystery Boxes'); 
      else if(key.type==='hot') items=state.products.filter(p=> (p.badge||'').toString().toLowerCase()==='hot' || p.price<200); 
      else if(key.type==='trending') items=state.products.slice().sort((a,b)=> (b.popularity||0)-(a.popularity||0)); 
      else if(key.type==='bundles') items=state.products.filter(p=>p.category==='Bundles'); 
      else if(key.type==='recommended') items = state.products.slice(); 
      else items=state.products.slice(); 
      items = items.slice(0,24); 
      panelContent.className='panel-grid'; 
      panelContent.innerHTML = items.map(p=>makeCardHTML(p)).join(''); 
      sectionPanel.classList.add('open'); 
      sectionPanel.setAttribute('aria-hidden','false'); 
      attachProductListeners(); 
    }
    
    document.querySelectorAll('.see-more').forEach(a=>a.addEventListener('click',e=>{ 
      e.preventDefault(); 
      const sec=a.dataset.section; 
      const map = { 
        mystery:{type:'mystery',title:'Mystery Boxes'}, 
        hot:{type:'hot',title:'Hot Deals'}, 
        trending:{type:'trending',title:'Trending & New Arrivals'}, 
        bundles:{type:'bundles',title:'Bundles & Combo Deals'}, 
        recommended:{type:'recommended',title:'Recommended For You'} 
      }; 
      openSectionView(map[sec]||{type:'all',title:'All items'}); 
    }));
    
    panelClose.addEventListener('click', ()=>{ 
      sectionPanel.classList.remove('open'); 
      sectionPanel.setAttribute('aria-hidden','true'); 
      panelContent.innerHTML=''; 
    });

    /********************
     * Subscribe function
     ********************/
    async function handleSubscribe(email){
      if(!email) return { success:false, error: 'no email' };
      if(!supabaseClient) {
        try{ localStorage.setItem('demo_subscribe_'+email, Date.now()); }catch(e){} 
        return { success: true, demo:true };
      }
      try {
        const { data, error } = await supabaseClient
          .from('subscribers')
          .insert([{ email, referral_code: null, referred_by: null }]);
        if(error) return { success:false, error };
        return { success:true, data };
      } catch(e){
        return { success:false, error:e };
      }
    }

    document.getElementById('subscribeBtn').addEventListener('click', async ()=>{ 
      const email=document.getElementById('newsEmail').value.trim(); 
      if(!email){ 
        alert('Enter your email'); 
        return;
      } 
      const res = await handleSubscribe(email); 
      if(res.success) { 
        alert('Thanks ‚Äî subscription saved.'); 
        document.getElementById('newsEmail').value=''; 
      } else { 
        console.error(res.error); 
        alert('Could not save your email (check console).'); 
      } 
    });

    /********************
     * Load filter options from Supabase - UPDATED FOR CORRECT FILTERING
     ********************/
    async function loadFilterOptions() {
      if (!supabaseClient) {
        console.warn('Supabase client not available for loading filter options');
        return;
      }

      try {
        // Get unique categories from products table
        const { data: categoriesData, error: categoriesError } = await supabaseClient
          .from('products')
          .select('category')
          .not('category', 'is', null);

        if (categoriesError) {
          console.error('Error loading categories:', categoriesError);
        } else if (categoriesData) {
          const uniqueCategories = ['All', ...new Set(categoriesData.map(item => item.category).filter(Boolean))];
          filterOptions.categories = uniqueCategories;
          
          // Populate categories list
          if (catList) {
            // Clear existing items (keep "All")
            catList.innerHTML = '';
            catList.innerHTML = '<li data-cat="All" class="active">All</li>';
            
            // Add other categories
            uniqueCategories.forEach(cat => {
              if (cat !== 'All') {
                const li = document.createElement('li');
                li.dataset.cat = cat;
                li.textContent = cat;
                li.addEventListener('click', () => {
                  Array.from(catList.querySelectorAll('li')).forEach(li=>li.classList.remove('active'));
                  li.classList.add('active');
                  state.filters.category = cat;
                  applyFilters();
                });
                catList.appendChild(li);
              }
            });
          }
        }

        // Get price range from actual products
        const { data: priceData, error: priceError } = await supabaseClient
          .from('products')
          .select('price, sale_price')
          .order('price', { ascending: false })
          .limit(1);

        if (priceError) {
          console.error('Error loading price range:', priceError);
        } else if (priceData && priceData.length > 0) {
          const maxPrice = Math.ceil(priceData[0].price / 50) * 50; // Round up to nearest 50
          filterOptions.priceRange.max = maxPrice;
          filterOptions.priceRange.min = 0;
          
          // Populate price dropdowns
          populatePriceDropdowns(maxPrice);
        }

        // Get unique sizes from product_variants table
        const { data: variantsData, error: variantsError } = await supabaseClient
          .from('product_variants')
          .select('size')
          .not('size', 'is', null);

        if (variantsError) {
          console.error('Error loading variants:', variantsError);
        } else if (variantsData) {
          const uniqueSizes = [...new Set(variantsData.map(item => item.size).filter(Boolean))];
          uniqueSizes.sort();
          filterOptions.sizes = uniqueSizes;
          
          // Populate sizes filter
          if (sizesFilter) {
            sizesFilter.innerHTML = '';
            uniqueSizes.forEach(size => {
              const label = document.createElement('label');
              label.style.marginRight = '8px';
              label.style.display = 'inline-block';
              label.style.marginBottom = '8px';
              
              const input = document.createElement('input');
              input.type = 'checkbox';
              input.name = 'size';
              input.value = size;
              input.style.marginRight = '4px';
              
              input.addEventListener('change', () => {
                state.filters.sizes = Array.from(sizesFilter.querySelectorAll('input[name="size"]:checked')).map(i => i.value);
                applyFilters();
              });
              
              label.appendChild(input);
              label.appendChild(document.createTextNode(size));
              sizesFilter.appendChild(label);
            });
          }
        }

        // Get unique types from metadata or products table
        const { data: productsData, error: productsError } = await supabaseClient
          .from('products')
          .select('type')
          .not('type', 'is', null);

        if (productsError) {
          console.error('Error loading types:', productsError);
        } else if (productsData) {
          const types = ['All', ...new Set(productsData.map(item => item.type).filter(Boolean))];
          filterOptions.types = types;
          
          // Populate type filter
          if (typeFilter) {
            typeFilter.innerHTML = '';
            types.forEach(type => {
              const label = document.createElement('label');
              label.style.marginRight = '8px';
              label.style.display = 'inline-block';
              label.style.marginBottom = '8px';
              
              const input = document.createElement('input');
              input.type = 'radio';
              input.name = 'type';
              input.value = type;
              if (type === 'All') input.checked = true;
              
              input.addEventListener('change', () => {
                state.filters.type = type;
                applyFilters();
              });
              
              label.appendChild(input);
              label.appendChild(document.createTextNode(type));
              typeFilter.appendChild(label);
            });
          }
        }

        // Get unique colors from metadata or products table
        const { data: colorsData, error: colorsError } = await supabaseClient
          .from('products')
          .select('color')
          .not('color', 'is', null);

        if (colorsError) {
          console.error('Error loading colors:', colorsError);
        } else if (colorsData) {
          const colors = ['Any', ...new Set(colorsData.map(item => item.color).filter(Boolean))];
          filterOptions.colors = colors;
          
          // Populate color dropdown
          if (colorSel) {
            colorSel.innerHTML = '';
            colors.forEach(color => {
              const option = document.createElement('option');
              option.value = color;
              option.textContent = color;
              colorSel.appendChild(option);
            });
          }
        }

        // Get unique tags from tags column
        const { data: tagsData, error: tagsError } = await supabaseClient
          .from('products')
          .select('tags')
          .not('tags', 'is', null);

        if (tagsError) {
          console.error('Error loading tags:', tagsError);
        } else if (tagsData) {
          const tags = new Set(['Any']);
          tagsData.forEach(item => {
            if (item.tags && Array.isArray(item.tags)) {
              item.tags.forEach(tag => tags.add(tag));
            }
          });
          filterOptions.tags = Array.from(tags);
          
          // Populate tags dropdown
          if (tagSel) {
            tagSel.innerHTML = '';
            filterOptions.tags.forEach(tag => {
              const option = document.createElement('option');
              option.value = tag;
              option.textContent = tag;
              tagSel.appendChild(option);
            });
          }
        }

        console.log('Filter options loaded:', filterOptions);
        
        // Populate mobile filters and menu
        populateMobileFilters();
        populateMobileMenuCategories();
        
      } catch (error) {
        console.error('Error loading filter options:', error);
      }
    }

    /********************
     * Populate price dropdowns with options
     ********************/
    function populatePriceDropdowns(maxPrice) {
      if (!priceMin || !priceMax) return;
      
      // Clear existing options (keep first placeholder)
      while (priceMin.options.length > 1) priceMin.remove(1);
      while (priceMax.options.length > 1) priceMax.remove(1);
      
      // Create price options (increments of 50)
      for (let price = 0; price <= maxPrice; price += 50) {
        const optionText = price === 0 ? 'R0' : `R${price}`;
        
        const minOption = document.createElement('option');
        minOption.value = price;
        minOption.textContent = optionText;
        priceMin.appendChild(minOption);
        
        const maxOption = document.createElement('option');
        maxOption.value = price;
        maxOption.textContent = optionText;
        priceMax.appendChild(maxOption);
      }
      
      // Also add "max" option at the end
      const maxOption = document.createElement('option');
      maxOption.value = maxPrice;
      maxOption.textContent = `R${maxPrice}`;
      priceMax.appendChild(maxOption);
    }

    /********************
     * Show notification function
     ********************/
    function showNotification(message) {
      // Create notification element
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        background-color: var(--accent);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 9999;
        box-shadow: var(--shadow);
        animation: slideIn 0.3s ease;
        font-size: 14px;
        font-weight: 600;
      `;
      
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
          if (notification.parentNode) {
            document.body.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    /********************
     * Initialize mobile functionality
     ********************/
    function initializeMobileFunctionality() {
      // Initialize mobile search
      initMobileSearch();
      
      // Initialize mobile menu
      initMobileMenu();
      
      // Initialize mobile filters
      initMobileFilters();
    }

    /********************
     * Initialize
     ********************/
    document.addEventListener('DOMContentLoaded', function() {
      // Check URL for referral code
      checkUrlForReferral();
      
      // Setup lazy loading
      setupLazyLoading();
      
      // Initialize mobile functionality
      initializeMobileFunctionality();
      
      // Initialize sign button
      const signBtn = document.getElementById('signBtn');
      if (signBtn) {
        signBtn.addEventListener('click', function(e) {
          e.preventDefault();
          showModal(loginModal);
        });
      }
      
      // Initialize cart button to redirect to checkout
      if (cartBtn) {
        cartBtn.addEventListener('click', function(e) {
          e.preventDefault();
          redirectToCheckout();
        });
      }
      
      // Quick add modal close
      if (quickAddClose) {
        quickAddClose.addEventListener('click', () => {
          quickAddModal.classList.remove('open');
        });
      }
      
      // Quick add size change
      if (quickAddSize) {
        quickAddSize.addEventListener('change', updateQuickAddStockInfo);
      }
      
      // Quick add quantity change
      if (quickAddQty) {
        quickAddQty.addEventListener('change', updateQuickAddStockInfo);
      }
      
      // Quick add submit
      if (quickAddSubmit) {
        quickAddSubmit.addEventListener('click', function() {
          if (!currentQuickAddProduct) return;
          
          const selectedSize = quickAddSize.value;
          const quantity = parseInt(quickAddQty.value);
          const stock = getVariantStock(currentQuickAddProduct, selectedSize);
          
          if (quantity > stock) {
            quickAddStockError.style.display = 'block';
            return;
          }
          
          addToCart(currentQuickAddProduct.id, quantity, selectedSize);
          quickAddModal.classList.remove('open');
        });
      }
      
      // Password validation on input
      if (modalSignupPassword) {
        modalSignupPassword.addEventListener('input', function() {
          // Simple validation - just check if it meets requirements
          const isValid = checkPasswordRules(this.value);
          const errorElement = document.getElementById('modalSignupPasswordError');
          if (errorElement) {
            if (!isValid && this.value.length > 0) {
              errorElement.textContent = 'Password must be at least 8 characters with 1 number and 1 special character.';
              errorElement.style.display = 'block';
            } else {
              errorElement.style.display = 'none';
            }
          }
        });
      }
      
      // Initialize cart
      initializeCart();
      
      // Load filter options
      loadFilterOptions();
      
      // Run reveal animations
      runReveal();
      
      // Save cart on unload
      window.addEventListener('beforeunload', () => {
        localStorage.setItem('ss_cart', JSON.stringify(state.cart));
      });
      
      // Check if we have a pending referral code
      try {
        const pendingReferral = localStorage.getItem('pending_referral');
        if (pendingReferral) {
          if (modalSignupReferralCode) {
            modalSignupReferralCode.value = pendingReferral;
          }
        }
      } catch (e) {}
    });

    function runReveal(){ 
      document.querySelectorAll('.fade-up').forEach(el=>{ 
        const rect = el.getBoundingClientRect(); 
        if(rect.top < window.innerHeight - 60) el.classList.add('show'); 
      }); 
    }
    
    window.addEventListener('scroll', runReveal); 
    window.addEventListener('resize', runReveal);
    
    // Add CSS for animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);
    
  </script>
</body>
</html>