<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Your Profile — Umzila.Store</title>

  <style>
    :root{
      --bg:#f7f7f9; --card:#fff; --muted:#6b6b74; --accent:#0a2f66; --cta:#ff6b2c; --shadow:0 6px 18px rgba(11,13,20,0.08);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter, system-ui, Arial, sans-serif}
    html,body{height:100%;}
    body{background:var(--bg);color:#111;min-height:100vh;-webkit-font-smoothing:antialiased}

    /* Header */
    header{background:#fff;padding:12px 18px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:1200}
    .header-left{display:flex;align-items:center;gap:12px}
    .brand{font-weight:700;color:var(--accent);font-size:16px}
    .back-btn{padding:8px 12px;border-radius:8px;border:1px solid #e6e6ea;background:transparent;color:var(--accent);text-decoration:none}
    .header-title{flex:1;text-align:center;font-weight:700;color:#111}

    /* Desktop logout button shown on larger screens */
    #logoutBtn{padding:8px 12px;border-radius:8px;border:1px solid #e6e6ea;background:transparent;color:var(--accent)}

    /* Mobile menu (hamburger) */
    .hamburger{display:none;border:none;background:transparent;padding:8px;border-radius:8px;cursor:pointer}
    .hamburger .bar{display:block;width:20px;height:2px;background:var(--accent);margin:4px 0;border-radius:2px}

    /* Mobile nav drawer */
    .mobile-nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:1300}
    .mobile-nav{position:fixed;right:0;top:0;height:100%;width:280px;background:#fff;box-shadow: -12px 0 24px rgba(10,15,30,0.12);transform:translateX(100%);transition:transform .28s ease;padding:18px;z-index:1400}
    .mobile-nav.open{transform:translateX(0)}
    .mobile-nav .nav-item{padding:12px;border-radius:8px;display:block;color:var(--accent);font-weight:600;margin-bottom:8px}
    .mobile-nav .nav-item.secondary{font-weight:400;color:var(--muted)}

    /* Layout */
    .container{max-width:1200px;margin:18px auto;padding:0 18px}
    .btn{padding:8px 14px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid #e6e6ea;color:var(--accent)}
    .profile-wrap{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap}
    .profile-card{background:var(--card);padding:16px;border-radius:12px;box-shadow:var(--shadow);width:320px;min-width:280px}
    .panel{flex:1;background:var(--card);padding:16px;border-radius:12px;box-shadow:var(--shadow);min-width:320px}
    h2{color:var(--accent);margin-bottom:8px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input, select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6ea;margin-bottom:10px}
    .section{margin-bottom:18px}
    .small{font-size:13px;color:var(--muted)}
    .cards-list{display:flex;flex-direction:column;gap:8px}
    .card-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:#fafafa;border:1px solid #f0f0f5}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .addresses-list, .orders-list{display:flex;flex-direction:column;gap:10px}
    .address-item, .order-item{padding:12px;border-radius:8px;background:#fafafa;border:1px solid #f0f0f5;cursor:pointer}
    .order-item{transition:box-shadow .18s ease}
    .order-item:hover{box-shadow:0 6px 18px rgba(10,15,30,0.04)}
    .muted-inline{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #f2f2f6;text-align:left;font-size:14px}

    /* Order thumbnails */
    .order-item img{width:48px;height:48px;border-radius:6px;object-fit:cover}
    .order-item .thumbs{display:flex;align-items:center}

    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(4,6,12,0.5); display:none; align-items:center; justify-content:center; z-index:2200; padding:18px; }
    .modal.open { display:flex; }
    .modal-card { background: #fff; border-radius:12px; width:100%; max-width:800px; max-height:90vh; overflow:auto; padding:18px; box-shadow:var(--shadow); }
    .modal-row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; margin-bottom:8px; }
    .modal-row .label { width:180px; color:var(--muted); font-size:13px; }
    .modal-close { background:transparent;border:none;font-size:18px;cursor:pointer; }
    .modal-row .value { font-weight: 600; color: #111; }
    .confirm-body { display:flex; gap:12px; align-items:center; justify-content:center; padding-top:12px; }

    @media (max-width:900px){
      .profile-wrap{flex-direction:column}
      .header-title{text-align:left;padding-left:8px}
      .back-btn{display:inline-flex}
      /* hide desktop logout and show hamburger */
      #logoutBtn{display:none}
      .hamburger{display:block}
      .header-title{font-size:15px}
      .brand{font-size:14px}
      .profile-card{width:100%;min-width:unset}
      .panel{min-width:unset}
      .mobile-nav-overlay{display:block}
    }

  </style>

  <!-- Use Supabase JS v2 (UMD bundle) so behavior matches other pages -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <script>
  // Fetch config and create a single global supabase client instance early
  (async function initSupabaseClient(){
    try {
      const res = await fetch('/.netlify/functions/get-client-config');
      if (!res.ok) {
        console.error('Failed to load Supabase config', res.status, await res.text());
        // don't return yet — allow fallback attempts below
      }
      const cfg = await res.json().catch(()=>null) || {};

      // Accept many possible key names from different environments
      const supabaseUrl = cfg.SUPABASE_URL || cfg.supabaseUrl || cfg.url || (cfg.SUPABASE_URL && cfg.SUPABASE_URL.value) || (cfg.supabase && cfg.supabase.url) || '';
      const supabaseAnonKey = cfg.SUPABASE_ANON_KEY || cfg.supabaseAnonKey || (cfg.SUPABASE_ANON_KEY && cfg.SUPABASE_ANON_KEY.value) || cfg.anonKey || cfg.key || (cfg.supabase && cfg.supabase.anonKey) || '';

      if (!supabaseUrl || !supabaseAnonKey) {
        console.warn('Missing Supabase config from server — falling back to window.SUPABASE_CONFIG if present');
        const fallback = window.SUPABASE_CONFIG || {};
        const fbUrl = fallback.SUPABASE_URL || fallback.supabaseUrl || fallback.url || (fallback.SUPABASE_URL && fallback.SUPABASE_URL.value) || '';
        const fbKey = fallback.SUPABASE_ANON_KEY || fallback.supabaseAnonKey || fallback.anonKey || fallback.key || '';
        if (fbUrl && fbKey) {
          window.SUPABASE_CONFIG = { supabaseUrl: fbUrl, supabaseAnonKey: fbKey };
        } else {
          // Final fallback: try looking for meta tags (useful during local dev)
          const metaUrl = document.querySelector('meta[name="supabase-url"]')?.getAttribute('content');
          const metaKey = document.querySelector('meta[name="supabase-anon-key"]')?.getAttribute('content');
          if (metaUrl && metaKey) {
            window.SUPABASE_CONFIG = { supabaseUrl: metaUrl, supabaseAnonKey: metaKey };
          } else {
            console.error('Supabase configuration not found. Ensure get-client-config returns credentials or provide meta tags.');
            // still set empty config so page can handle gracefully
            window.SUPABASE_CONFIG = { supabaseUrl: '', supabaseAnonKey: '' };
          }
        }
      } else {
        window.SUPABASE_CONFIG = { supabaseUrl, supabaseAnonKey };
      }

      // Create a stable client and expose as window.supabaseClient and window.supabase
      try {
        const client = supabase.createClient(window.SUPABASE_CONFIG.supabaseUrl, window.SUPABASE_CONFIG.supabaseAnonKey);
        window.supabaseClient = client;
        window.supabase = client; // some pages reference window.supabase
      } catch (err) {
        console.error('Error creating Supabase client', err);
        window.supabaseClient = null;
        window.supabase = null;
      }

      // Let the rest of the page know supabase is ready
      document.dispatchEvent(new CustomEvent('supabase-ready', { detail: { supabaseClient: window.supabaseClient } }));
      console.log('Supabase client initialized (profile.html)');
    } catch (err) {
      console.error('Error initializing Supabase client', err);
      // ensure event is still dispatched so page doesn't hang
      document.dispatchEvent(new CustomEvent('supabase-ready', { detail: { supabaseClient: window.supabaseClient || null } }));
    }
  })();
  </script>
</head>
<body>
  <header>
    <div class="header-left">
      <a href="index.html" class="back-btn">← Back</a>
      <div class="brand">StreetSale</div>
    </div>
    <div class="header-title">Your profile</div>
    <button id="logoutBtn" class="btn ghost">Log out</button>
    <button id="menuBtn" class="hamburger" aria-label="Open menu" aria-expanded="false">
      <span class="bar"></span>
      <span class="bar"></span>
      <span class="bar"></span>
    </button>

    <!-- Mobile nav drawer -->
    <div id="mobileNavOverlay" class="mobile-nav-overlay" style="display:none"></div>
    <nav id="mobileNav" class="mobile-nav" aria-hidden="true">
      <a href="profile.html" class="nav-item">Profile</a>
      <a href="#orders" id="navOrders" class="nav-item">Orders</a>
      <a href="#addresses" id="navAddresses" class="nav-item">Addresses</a>
      <a href="#security" id="navSecurity" class="nav-item">Security</a>
      <button id="mobileLogout" class="nav-item secondary" style="border:none;background:transparent;text-align:left;padding:0;margin-top:12px">Log out</button>
    </nav>
  </header>

  <div class="container">
    <div class="profile-wrap">
      <aside class="profile-card">
        <h2>Account</h2>
        <div class="section">
          <div class="small">Signed in as</div>
          <div id="profileEmail" style="font-weight:800;margin-top:8px">—</div>
        </div>

        <div class="section">
          <label for="profileFirstName">First name</label>
          <input id="profileFirstName" placeholder="First name" />
          <label for="profileLastName">Last name</label>
          <input id="profileLastName" placeholder="Last name" />
          <label for="profilePhone">Phone</label>
          <input id="profilePhone" placeholder="+27 7xx xxx xxxx" />
          <button id="saveProfileBtn" class="btn" style="width:100%;margin-top:6px">Save profile</button>
        </div>

        <div class="section">
          <h3 style="font-size:15px">Address book</h3>
          <div class="small" style="margin-bottom:8px">Save an address that will be stored on your profile (1 address per user).</div>

          <div id="addressesContainer" class="addresses-list" style="margin-bottom:8px"></div>

          <div style="margin-top:8px">
            <label for="addrLabel">Label (Home, Work)</label>
            <input id="addrLabel" placeholder="e.g. Home" />
            <label for="addrLine">Address</label>
            <textarea id="addrLine" rows="2" placeholder="Street, area, city"></textarea>
            <label for="province">Province</label>
            <input type="text" id="addrProvince" placeholder="Enter your province" />
            <label for="addrCity">City</label>
            <input id="addrCity" placeholder="e.g. Cape Town" />
            <label for="addrPostal">Postal / ZIP</label>
            <input id="addrPostal" placeholder="Postal code" />
            <button id="addAddressBtn" class="btn" style="width:100%;margin-top:6px">Save address</button>
          </div>
        </div>
      </aside>

      <main class="panel">
        <h2>Order History</h2>
        <div class="small">Recent orders from your account (if available). Click any order to view full details.</div>
        <div id="ordersContainer" class="orders-list" style="margin-top:12px;margin-bottom:12px"></div>

        <div style="margin-top:10px">
          <h3 style="font-size:15px">Security</h3>
          <div class="small">Send a password reset email to update your password.</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="emailForReset" placeholder="you@example.com" />
            <button id="sendReset" class="btn">Send reset</button>
          </div>
          <div id="resetStatus" class="small" style="margin-top:8px"></div>
        </div>

        <div class="section" style="margin-top:14px">
          <h3 style="font-size:15px">Account actions</h3>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="deleteAccount" class="btn ghost">Delete account (!)</button>
            <button id="refreshBtn" class="btn">Refresh</button>
          </div>
          
        </div>
      </main>
    </div>
  </div>

  <!-- Order modal -->
  <div id="orderModal" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-card" role="document" aria-labelledby="orderModalTitle">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <h3 id="orderModalTitle" style="margin:0">Order details</h3>
          <div class="muted-inline" id="orderModalSub"></div>
        </div>
        <button class="modal-close" id="orderModalClose" aria-label="Close">✕</button>
      </div>
      <div id="orderModalBody"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button class="btn ghost" id="orderModalClose2">Close</button>
      </div>
    </div>
  </div>

  <!-- Logout confirm -->
  <div id="logoutConfirm" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-card" style="max-width:420px; text-align:center;">
      <h3 style="margin:0 0 8px 0">Confirm logout</h3>
      <div class="small">Do you want to log out?</div>
      <div class="confirm-body">
        <button id="logoutYes" class="btn">Yes, log out</button>
        <button id="logoutNo" class="btn ghost">No, stay</button>
      </div>
    </div>
  </div>

  <script>
  (async function(){
    // Wait for supabase client ready
    if (!window.supabaseClient) {
      await new Promise(resolve => {
        if (window.supabaseClient) return resolve();
        document.addEventListener('supabase-ready', () => resolve());
        // defensive timeout so page doesn't hang forever
        setTimeout(resolve, 4000);
      });
    }

    // If supabase client still not set, attempt to create from window.SUPABASE_CONFIG
    if (!window.supabaseClient && window.SUPABASE_CONFIG && window.SUPABASE_CONFIG.supabaseUrl && window.SUPABASE_CONFIG.supabaseAnonKey) {
      try {
        window.supabaseClient = supabase.createClient(window.SUPABASE_CONFIG.supabaseUrl, window.SUPABASE_CONFIG.supabaseAnonKey);
        window.supabase = window.supabaseClient;
        console.log('Supabase client created from window.SUPABASE_CONFIG fallback');
      } catch (e) {
        console.error('Fallback supabase client creation failed', e);
      }
    }

    const supabase = window.supabaseClient;

    if(!supabase){
      console.error('Supabase client not initialized. Check script include and keys.');
      const el = document.getElementById('profileEmail'); if(el) el.textContent = 'Supabase not initialised';
      return;
    }

    // DOM refs
    const profileEmail = document.getElementById('profileEmail');
    const profileFirstName = document.getElementById('profileFirstName');
    const profileLastName = document.getElementById('profileLastName');
    const profilePhone = document.getElementById('profilePhone');
    const saveBtn = document.getElementById('saveProfileBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const sendReset = document.getElementById('sendReset');
    const emailForReset = document.getElementById('emailForReset');
    const resetStatus = document.getElementById('resetStatus');
    const addressesContainer = document.getElementById('addressesContainer');
    const addAddressBtn = document.getElementById('addAddressBtn');
    const addrLabel = document.getElementById('addrLabel');
    const addrLine = document.getElementById('addrLine');
    const addrCity = document.getElementById('addrCity');
    const addrProvince = document.getElementById('addrProvince');
    const addrPostal = document.getElementById('addrPostal');
    const ordersContainer = document.getElementById('ordersContainer');
    const deleteAccount = document.getElementById('deleteAccount');
    const refreshBtn = document.getElementById('refreshBtn');

    const orderModal = document.getElementById('orderModal');
    const orderModalClose = document.getElementById('orderModalClose');
    const orderModalClose2 = document.getElementById('orderModalClose2');
    const orderModalBody = document.getElementById('orderModalBody');
    const orderModalTitle = document.getElementById('orderModalTitle');
    const orderModalSub = document.getElementById('orderModalSub');

    const logoutConfirm = document.getElementById('logoutConfirm');
    const logoutYes = document.getElementById('logoutYes');
    const logoutNo = document.getElementById('logoutNo');

    // mobile menu elements
    const menuBtn = document.getElementById('menuBtn');
    const mobileNav = document.getElementById('mobileNav');
    const mobileNavOverlay = document.getElementById('mobileNavOverlay');
    const mobileLogout = document.getElementById('mobileLogout');

    function openMobileNav(){
      mobileNav.classList.add('open');
      mobileNav.setAttribute('aria-hidden','false');
      menuBtn.setAttribute('aria-expanded','true');
      mobileNavOverlay.style.display = 'block';
    }
    function closeMobileNav(){
      mobileNav.classList.remove('open');
      mobileNav.setAttribute('aria-hidden','true');
      menuBtn.setAttribute('aria-expanded','false');
      mobileNavOverlay.style.display = 'none';
    }

    menuBtn && menuBtn.addEventListener('click', ()=>{
      if(mobileNav.classList.contains('open')) closeMobileNav(); else openMobileNav();
    });
    mobileNavOverlay && mobileNavOverlay.addEventListener('click', closeMobileNav);
    document.getElementById('navOrders')?.addEventListener('click', (e)=>{ e.preventDefault(); closeMobileNav(); document.getElementById('ordersContainer')?.scrollIntoView({behavior:'smooth'}); });
    document.getElementById('navAddresses')?.addEventListener('click', (e)=>{ e.preventDefault(); closeMobileNav(); document.getElementById('addressesContainer')?.scrollIntoView({behavior:'smooth'}); });
    document.getElementById('navSecurity')?.addEventListener('click', (e)=>{ e.preventDefault(); closeMobileNav(); document.getElementById('emailForReset')?.scrollIntoView({behavior:'smooth'}); });
    mobileLogout && mobileLogout.addEventListener('click', ()=>{ closeMobileNav(); showModal(logoutConfirm); });

    // helpers
    function showModal(el){ if(!el) return; el.classList.add('open'); el.setAttribute('aria-hidden','false'); el.style.display='flex'; }
    function hideModal(el){ if(!el) return; el.classList.remove('open'); el.setAttribute('aria-hidden','true'); el.style.display='none'; }
    function showError(el, msg){ if(!el) return; el.style.color='red'; el.textContent = msg || ''; }
    function showSuccess(el, msg){ if(!el) return; el.style.color='green'; el.textContent = msg || ''; }
    function escapeHtml(s){ if(s===null || s===undefined) return ''; return String(s).replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'})[m]); }

    // Use getSession consistently
    async function getUserOrRedirect(){
      try{
        const { data } = await supabase.auth.getSession();
        const user = data?.session?.user || null;
        if(!user){
          // not signed in — send back to store
          window.location.href = 'index.html';
          return null;
        }
        return user;
      }catch(err){
        console.warn('getUserOrRedirect error', err);
        window.location.href = 'index.html';
        return null;
      }
    }

    // profile load/save (single-address model)
    async function loadProfile(){
      const user = await getUserOrRedirect();
      if(!user) return;

      profileEmail.textContent = user.email || (user.user_metadata && user.user_metadata.email) || '—';
      emailForReset.value = user.email || '';

      try{
        const { data, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('user_id', user.id)
          .maybeSingle();

        if(error){
          console.warn('profile select error', error);
          return;
        }

        if(data){
          profileFirstName.value = data.first_name || data.full_name || '';
          profileLastName.value = data.last_name || '';
          profilePhone.value = data.phone || '';
          addrLabel.value = data.label || '';
          addrLine.value = data.address || data.address_line || data.adress || '';
          addrCity.value = data.city || '';
          addrProvince.value = data.province || data.Province || '';
          addrPostal.value = data.postal_code || data.postal || data.zip || '';
          renderSavedAddressPreview(data);
        } else {
          // Profile row missing in DB; create minimal row so other pages (index.html) can rely on it
          const payload = {
            user_id: user.id,
            email: user.email || null,
            first_name: '',
            last_name: '',
            phone: ''
          };
          const { data: newProfile, error: createErr } = await supabase.from('profiles').insert([payload]).select().maybeSingle();
          if(createErr){
            console.warn('Could not create profile row automatically', createErr);
            addressesContainer.innerHTML = '<div class="small" style="color:var(--muted)">No address saved yet.</div>';
          } else {
            // reload to pick up created row
            await loadProfile();
          }
        }
      }catch(e){
        console.warn('loadProfile exception', e);
      }
    }

    function renderSavedAddressPreview(row){
      const addr = (row.address || row.address_line || row.adress || '') || '';
      const label = row.label || '';
      const city = row.city || '';
      const province = row.province || row.Province || '';
      const postal = row.postal_code || row.postal || row.zip || '';
      if(!addr){
        addressesContainer.innerHTML = '<div class="small" style="color:var(--muted)">No address saved yet.</div>';
        return;
      }
      addressesContainer.innerHTML = `
        <div class="address-item">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>${escapeHtml(label || 'Saved address')}</strong>
            <div style="font-size:12px;color:var(--muted)"></div>
          </div>
          <div style="margin-top:8px">${escapeHtml(addr)}</div>
          <div style="margin-top:6px;font-size:13px;color:var(--muted)">${escapeHtml(city)} • ${escapeHtml(province)} • ${escapeHtml(postal)}</div>
        </div>`;
    }

    // save (upsert) profile row
    saveBtn.addEventListener('click', async ()=>{
      const user = await getUserOrRedirect();
      if(!user) return;
      saveBtn.disabled = true;
      try{
        const payload = {
          user_id: user.id,
          first_name: (profileFirstName.value||'').trim(),
          last_name: (profileLastName.value||'').trim(),
          phone: (profilePhone.value||'').trim(),
          label: (addrLabel.value||'').trim(),
          address: (addrLine.value||'').trim(),
          city: (addrCity.value||'').trim(),
          province: (addrProvince.value||'').trim(),
          postal_code: (addrPostal.value||'').trim(),
          email: user.email || null,
          updated_at: new Date().toISOString()
        };

        const { error } = await supabase.from('profiles').upsert([payload], { onConflict: ['user_id'] });
        if(error){
          console.error('upsert profiles error', error);
          alert('Profile deleted.');
        window.location.href = 'index.html';
      }catch(e){
        console.error('deleteAccount exception', e);
        alert('Unable to delete account (see console).');
      }
    });

    refreshBtn.addEventListener('click', async ()=>{ await loadAll(); alert('Refreshed'); });

    // init loader
    async function loadAll(){
      await loadProfile();
      await loadOrders();
    }

    // --- auth state listener to avoid "logout then immediate login" loops and to re-load profile on sign-in ---
    supabase.auth.onAuthStateChange((event, session) => {
      console.log('auth event', event);
      if(event === 'SIGNED_OUT'){
        // user explicitly signed out; ensure page redirects and does not auto-sign-in
        window.location.href = 'index.html';
      }
      if(event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED'){
        // reload profile data when user signs in on another tab
        loadAll().catch(e=>console.warn('loadAll after auth event failed', e));
      }
    });

    // initial check: require session and then load data
    (async function init(){
      const { data } = await supabase.auth.getSession();
      const session = data?.session || null;
      if(!session || !session.user){ window.location.href = 'index.html'; return; }
      await loadAll();
    })();

    // expose for debug
    window._ssProfile = { loadProfile, loadOrders, openOrderModal };

  })();
  </script>
</body>
</html>
