<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Your Profile — Umzila.Store</title>

  <style>
    :root{
      --bg:#f7f7f9; --card:#fff; --muted:#6b6b74; --accent:#0a2f66; --cta:#ff6b2c; --shadow:0 6px 18px rgba(11,13,20,0.08);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter, system-ui, Arial, sans-serif}
    body{background:var(--bg);color:#111;min-height:100vh}
    header{background:#fff;padding:12px 18px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:12px}
    .container{max-width:1200px;margin:18px auto;padding:0 18px}
    .btn{padding:8px 14px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid #e6e6ea;color:var(--accent)}
    .profile-wrap{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap}
    .profile-card{background:var(--card);padding:16px;border-radius:12px;box-shadow:var(--shadow);width:320px;min-width:280px}
    .panel{flex:1;background:var(--card);padding:16px;border-radius:12px;box-shadow:var(--shadow);min-width:320px}
    h2{color:var(--accent);margin-bottom:8px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input, select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6ea;margin-bottom:10px}
    .section{margin-bottom:18px}
    .small{font-size:13px;color:var(--muted)}
    .cards-list{display:flex;flex-direction:column;gap:8px}
    .card-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:#fafafa;border:1px solid #f0f0f5}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .addresses-list, .orders-list{display:flex;flex-direction:column;gap:10px}
    .address-item, .order-item{padding:12px;border-radius:8px;background:#fafafa;border:1px solid #f0f0f5;cursor:pointer}
    .order-item:hover{box-shadow:0 6px 18px rgba(10,15,30,0.04)}
    .muted-inline{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #f2f2f6;text-align:left;font-size:14px}
    @media (max-width:900px){
      .profile-wrap{flex-direction:column}
    }

    /* --- Order detail modal (keeps look consistent) --- */
    .modal { position: fixed; inset: 0; background: rgba(4,6,12,0.5); display:none; align-items:center; justify-content:center; z-index:2200; padding:18px; }
    .modal.open { display:flex; }
    .modal-card { background: #fff; border-radius:12px; width:100%; max-width:800px; max-height:90vh; overflow:auto; padding:18px; box-shadow:var(--shadow); }
    .modal-row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; margin-bottom:8px; }
    .modal-row .label { width:180px; color:var(--muted); font-size:13px; }
    .modal-close { background:transparent;border:none;font-size:18px;cursor:pointer; }
    .modal-row .value { font-weight: 600; color: #111; }
    .confirm-body { display:flex; gap:12px; align-items:center; justify-content:center; padding-top:12px; }
  </style>

  <!-- Supabase initialization via Netlify function -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

  <script>
  (async function initSupabaseClient(){
    try {
      const res = await fetch('/.netlify/functions/get-client-config');
      if (!res.ok) {
        console.error('Failed to load Supabase config', res.status, await res.text());
        return;
      }
      const cfg = await res.json();

      if (!cfg.SUPABASE_URL || !cfg.SUPABASE_ANON_KEY) {
        console.error('Missing Supabase config from server');
        return;
      }

      // Initialize Supabase client
      const supabaseClient = supabase.createClient(cfg.SUPABASE_URL, cfg.SUPABASE_ANON_KEY);
      window.supabase = supabaseClient; // make it accessible globally

      // Optional: notify other scripts that Supabase is ready
      document.dispatchEvent(new CustomEvent('supabase-ready', { detail: { supabase: supabaseClient } }));
      console.log('Supabase client initialized');
    } catch (err) {
      console.error('Error initializing Supabase client', err);
    }
  })();
  </script>
</head>
<body>
  <header>
    <a href="index.html" class="btn ghost">← Back</a>
    <div style="flex:1">
      <strong>StreetSale — Your profile</strong>
    </div>
    <button id="logoutBtn" class="btn ghost">Log out</button>
  </header>

  <div class="container">
    <div class="profile-wrap">
      <aside class="profile-card">
        <h2>Account</h2>
        <div class="section">
          <div class="small">Signed in as</div>
          <div id="profileEmail" style="font-weight:800;margin-top:8px">—</div>
        </div>

        <div class="section">
          <label for="profileFirstName">First name</label>
          <input id="profileFirstName" placeholder="First name" />
          <label for="profileLastName">Last name</label>
          <input id="profileLastName" placeholder="Last name" />
          <label for="profilePhone">Phone</label>
          <input id="profilePhone" placeholder="+27 7xx xxx xxxx" />
          <button id="saveProfileBtn" class="btn" style="width:100%;margin-top:6px">Save profile</button>
        </div>

        <div class="section">
          <h3 style="font-size:15px">Address book</h3>
          <div class="small" style="margin-bottom:8px">Save an address that will be stored on your profile (1 address per user).</div>

          <div id="addressesContainer" class="addresses-list" style="margin-bottom:8px"></div>

          <div style="margin-top:8px">
            <label for="addrLabel">Label (Home, Work)</label>
            <input id="addrLabel" placeholder="e.g. Home" />
            <label for="addrLine">Address</label>
            <textarea id="addrLine" rows="2" placeholder="Street, area, city"></textarea>
            <label for="province">Province</label>
            <input type="text" id="addrProvince" placeholder="Enter your province" />
            <label for="addrCity">City</label>
            <input id="addrCity" placeholder="e.g. Cape Town" />
            <label for="addrPostal">Postal / ZIP</label>
            <input id="addrPostal" placeholder="Postal code" />
            <button id="addAddressBtn" class="btn" style="width:100%;margin-top:6px">Save address</button>
          </div>
        </div>
      </aside>

      <main class="panel">
        <h2>Order History</h2>
        <div class="small">Recent orders from your account (if available). Click any order to view full details.</div>
        <div id="ordersContainer" class="orders-list" style="margin-top:12px;margin-bottom:12px"></div>

        <div style="margin-top:10px">
          <h3 style="font-size:15px">Security</h3>
          <div class="small">Send a password reset email to update your password.</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="emailForReset" placeholder="you@example.com" />
            <button id="sendReset" class="btn">Send reset</button>
          </div>
          <div id="resetStatus" class="small" style="margin-top:8px"></div>
        </div>

        <div class="section" style="margin-top:14px">
          <h3 style="font-size:15px">Account actions</h3>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="deleteAccount" class="btn ghost">Delete account (!)</button>
            <button id="refreshBtn" class="btn">Refresh</button>
          </div>
          <div class="small" style="margin-top:8px">Deleting an account is irreversible. This button will attempt to delete auth user and linked profile rows if allowed by your DB policies.</div>
        </div>
      </main>
    </div>
  </div>

  <!-- Order modal -->
  <div id="orderModal" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-card" role="document" aria-labelledby="orderModalTitle">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <h3 id="orderModalTitle" style="margin:0">Order details</h3>
          <div class="muted-inline" id="orderModalSub"></div>
        </div>
        <button class="modal-close" id="orderModalClose" aria-label="Close">✕</button>
      </div>
      <div id="orderModalBody"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button class="btn ghost" id="orderModalClose2">Close</button>
      </div>
    </div>
  </div>

  <!-- Logout confirm -->
  <div id="logoutConfirm" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-card" style="max-width:420px; text-align:center;">
      <h3 style="margin:0 0 8px 0">Confirm logout</h3>
      <div class="small">Do you want to log out?</div>
      <div class="confirm-body">
        <button id="logoutYes" class="btn">Yes, log out</button>
        <button id="logoutNo" class="btn ghost">No, stay</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // ---------- CONFIG ----------
    const FALLBACK_SUPABASE_URL = 'https://ojwnjtcxbitwmtlsbjnx.supabase.co';
    const FALLBACK_SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qd25qdGN4Yml0d210bHNiam54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MDMxNzksImV4cCI6MjA4MDE3OTE3OX0.OixLdTUF2ypuLbWs5S3QKwowJ-nGzpG8U7CE_Kic93o';

    const SUPABASE_URL = window.SUPABASE_URL || FALLBACK_SUPABASE_URL;
    const SUPABASE_ANON = window.SUPABASE_ANON || FALLBACK_SUPABASE_ANON;

    // prefer a single global client (avoid duplicate declarations)
    window.supabaseClient = window.supabaseClient || (window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON) : null);
    const supabase = window.supabaseClient;

    if(!supabase){
      console.error('Supabase client not initialized. Check script include and keys.');
      const el = document.getElementById('profileEmail'); if(el) el.textContent = 'Supabase not initialised';
      return;
    }

    // ---------- DOM refs ----------
    const profileEmail = document.getElementById('profileEmail');
    const profileFirstName = document.getElementById('profileFirstName');
    const profileLastName = document.getElementById('profileLastName');
    const profilePhone = document.getElementById('profilePhone');
    const saveBtn = document.getElementById('saveProfileBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const sendReset = document.getElementById('sendReset');
    const emailForReset = document.getElementById('emailForReset');
    const resetStatus = document.getElementById('resetStatus');
    const addressesContainer = document.getElementById('addressesContainer');
    const addAddressBtn = document.getElementById('addAddressBtn');
    const addrLabel = document.getElementById('addrLabel');
    const addrLine = document.getElementById('addrLine');
    const addrCity = document.getElementById('addrCity');
    const addrProvince = document.getElementById('addrProvince');
    const addrPostal = document.getElementById('addrPostal');
    const ordersContainer = document.getElementById('ordersContainer');
    const deleteAccount = document.getElementById('deleteAccount');
    const refreshBtn = document.getElementById('refreshBtn');

    const orderModal = document.getElementById('orderModal');
    const orderModalClose = document.getElementById('orderModalClose');
    const orderModalClose2 = document.getElementById('orderModalClose2');
    const orderModalBody = document.getElementById('orderModalBody');
    const orderModalTitle = document.getElementById('orderModalTitle');
    const orderModalSub = document.getElementById('orderModalSub');

    const logoutConfirm = document.getElementById('logoutConfirm');
    const logoutYes = document.getElementById('logoutYes');
    const logoutNo = document.getElementById('logoutNo');

    // ---------- helpers ----------
    function showModal(el){ if(!el) return; el.classList.add('open'); el.setAttribute('aria-hidden','false'); el.style.display='flex'; }
    function hideModal(el){ if(!el) return; el.classList.remove('open'); el.setAttribute('aria-hidden','true'); el.style.display='none'; }
    function showError(el, msg){ if(!el) return; el.style.color='red'; el.textContent = msg || ''; }
    function showSuccess(el, msg){ if(!el) return; el.style.color='green'; el.textContent = msg || ''; }
    function escapeHtml(s){ if(s===null || s===undefined) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

    async function getUserOrRedirect(){
      try{
        const { data } = await supabase.auth.getUser();
        const user = data?.user || null;
        if(!user){
          window.location.href = 'index.html';
          return null;
        }
        return user;
      }catch(err){
        console.warn('getUserOrRedirect error', err);
        window.location.href = 'index.html';
        return null;
      }
    }

    // ---------- profile load/save (single-address model) ----------
    async function loadProfile(){
      const user = await getUserOrRedirect();
      if(!user) return;
      profileEmail.textContent = user.email || (user.user_metadata && user.user_metadata.email) || '—';
      emailForReset.value = user.email || '';

      try{
        const { data, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('user_id', user.id)
          .maybeSingle();

        if(error){
          console.warn('profile select error', error);
          return;
        }

        if(data){
          profileFirstName.value = data.first_name || data.full_name || '';
          profileLastName.value = data.last_name || '';
          profilePhone.value = data.phone || '';
          addrLabel.value = data.label || '';
          addrLine.value = data.address || data.address_line || data.adress || '';
          addrCity.value = data.city || '';
          addrProvince.value = data.province || data.Province || '';
          addrPostal.value = data.postal_code || data.postal || data.zip || '';
          renderSavedAddressPreview(data);
        } else {
          profileFirstName.value = '';
          profileLastName.value = '';
          profilePhone.value = '';
          addrLabel.value = '';
          addrLine.value = '';
          addrCity.value = '';
          addrProvince.value = '';
          addrPostal.value = '';
          addressesContainer.innerHTML = '<div class="small" style="color:var(--muted)">No address saved yet.</div>';
        }
      }catch(e){
        console.warn('loadProfile exception', e);
      }
    }

    function renderSavedAddressPreview(row){
      const addr = (row.address || row.address_line || row.adress || '') || '';
      const label = row.label || '';
      const city = row.city || '';
      const province = row.province || row.Province || '';
      const postal = row.postal_code || row.postal || row.zip || '';
      if(!addr){
        addressesContainer.innerHTML = '<div class="small" style="color:var(--muted)">No address saved yet.</div>';
        return;
      }
      addressesContainer.innerHTML = `
        <div class="address-item">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>${escapeHtml(label || 'Saved address')}</strong>
            <div style="font-size:12px;color:var(--muted)"></div>
          </div>
          <div style="margin-top:8px">${escapeHtml(addr)}</div>
          <div style="margin-top:6px;font-size:13px;color:var(--muted)">${escapeHtml(city)} • ${escapeHtml(province)} • ${escapeHtml(postal)}</div>
        </div>`;
    }

    // Upsert profile row (will create if missing)
    saveBtn.addEventListener('click', async ()=>{
      const user = await getUserOrRedirect();
      if(!user) return;
      saveBtn.disabled = true;
      try{
        const payload = {
          user_id: user.id,
          first_name: (profileFirstName.value||'').trim(),
          last_name: (profileLastName.value||'').trim(),
          phone: (profilePhone.value||'').trim(),
          label: (addrLabel.value||'').trim(),
          address: (addrLine.value||'').trim(),
          city: (addrCity.value||'').trim(),
          province: (addrProvince.value||'').trim(),
          postal_code: (addrPostal.value||'').trim(),
          email: user.email || null,
          updated_at: new Date().toISOString()
        };

        const { error } = await supabase.from('profiles').upsert([payload], { onConflict: ['user_id'] });
        if(error){
          console.error('upsert profiles error', error);
          alert('Error saving profile: ' + (error.message || JSON.stringify(error)));
        } else {
          alert('Profile saved!');
          await loadProfile();
        }
      }catch(e){
        console.error('save profile exception', e);
        alert('Unexpected error. See console.');
      } finally {
        saveBtn.disabled = false;
      }
    });

    // Save address button reuses save logic (single-address model)
    addAddressBtn.addEventListener('click', ()=> saveBtn.click());

    // ---------- orders ----------
    async function loadOrders(){
      ordersContainer.innerHTML = '';
      const user = await getUserOrRedirect();
      if(!user) return;
      try{
        const { data, error } = await supabase
          .from('orders')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })
          .limit(100);

        if(error){
          console.warn('orders select error', error);
          ordersContainer.innerHTML = `<div class="small" style="color:var(--muted)">No orders or orders table unavailable. To show order history create an <code>orders</code> table with a <code>user_id</code> column and <code>created_at</code>.</div>`;
          return;
        }
        if(!data || data.length===0){
          ordersContainer.innerHTML = `<div class="small" style="color:var(--muted)">You have no orders yet.</div>`;
          return;
        }

        ordersContainer.innerHTML = data.map(o => {
          const id = o.id || '';
          const order_number = o.order_number || '';
          const total = (o.total !== null && o.total !== undefined) ? 'R' + Number(o.total).toFixed(2) : '';
          const status = o.order_status || '';
          const created = o.created_at ? new Date(o.created_at).toLocaleString() : '';
          const qty = o.quantity || '';
          const displayTitle = order_number ? `${order_number}` : String(id).slice(0,8);
          const smallMeta = `${escapeHtml(created)} • ${escapeHtml(String(qty))} items`;

          return `<div class="order-item" data-order-id="${escapeHtml(id)}" role="button" tabindex="0">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <strong>Order ${escapeHtml(displayTitle)}</strong>
                <div class="muted-inline" style="margin-top:6px">${smallMeta}</div>
              </div>
              <div style="text-align:right">
                <div style="font-weight:700">${escapeHtml(total)}</div>
                <div class="muted-inline">${escapeHtml(status)}</div>
              </div>
            </div>
          </div>`;
        }).join('');

        Array.from(ordersContainer.querySelectorAll('.order-item')).forEach(el=>{
          el.addEventListener('click', ()=> openOrderModal(el.getAttribute('data-order-id')));
          el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') openOrderModal(el.getAttribute('data-order-id')); });
        });

      }catch(e){
        console.warn('loadOrders exception', e);
        ordersContainer.innerHTML = `<div class="small" style="color:var(--muted)">Unable to load orders (see console).</div>`;
      }
    }

    async function openOrderModal(orderId){
      if(!orderId) return;
      try{
        const { data, error } = await supabase.from('orders').select('*').eq('id', orderId).maybeSingle();
        if(error){ console.warn('order fetch error', error); alert('Unable to load order details. See console.'); return; }
        if(!data){ alert('Order not found'); return; }

        const title = data.order_number || data.id || 'Order';
        const sub = data.created_at ? new Date(data.created_at).toLocaleString() : '';

        orderModalTitle.textContent = `Order ${title}`;
        orderModalSub.textContent = sub;

        const rows = [];
        const keysOrder = ['order_number','customer_name','customer_phone','order_status','quantity','total','package_type','pickup_address','delivery_address','notes','created_at','updated_at','user_id','profile_id','id'];
        const allKeys = Object.keys(data);
        const remaining = allKeys.filter(k=>!keysOrder.includes(k)).sort();
        const finalKeys = keysOrder.concat(remaining).filter(Boolean);

        // Hide sensitive fields from modal
        const HIDDEN_FIELDS = [
          'created_at',
          'updated_at',
          'user_id',
          'profile_id',
          'id'
        ];

        finalKeys.forEach(k=>{
          if (HIDDEN_FIELDS.includes(k)) return; // <-- do not display sensitive fields
          if(!(k in data)) return;
          let label = k.replace(/_/g,' ').replace(/\b\w/g, s=>s.toUpperCase());
          let val = data[k];
          if(val === null || val === undefined) val = '';
          if(k === 'total' && val!=='') { try{ val = 'R' + Number(val).toFixed(2); } catch(e){} }
          if((k.endsWith('_at') || k === 'created_at' || k === 'updated_at') && val){
            try{ val = new Date(val).toLocaleString(); }catch(e){}
          }
          if(typeof val === 'string' && val.includes('\n')) {
            val = val.split('\n').map(escapeHtml).join('<br>');
          } else {
            val = escapeHtml(String(val));
          }
          rows.push(`<div class="modal-row"><div class="label">${escapeHtml(label)}</div><div class="value" style="flex:1">${val}</div></div>`);
        });

        orderModalBody.innerHTML = rows.join('');
        showModal(orderModal);
      }catch(e){
        console.error('openOrderModal exception', e);
        alert('Unable to load order details (see console).');
      }
    }

    orderModalClose.addEventListener('click', ()=> hideModal(orderModal));
    orderModalClose2.addEventListener('click', ()=> hideModal(orderModal));
    orderModal.addEventListener('click', (e)=> { if(e.target === orderModal) hideModal(orderModal); });

    // ---------- password reset ----------
    sendReset.addEventListener('click', async ()=>{
      const email = (emailForReset.value || '').trim();
      if(!email){ showError(resetStatus, 'Enter an email'); return; }
      resetStatus.textContent = '';
      try{
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin + '/' });
        if(error){ showError(resetStatus, error.message || 'Error requesting reset'); }
        else { showSuccess(resetStatus, 'Reset link sent — check your email'); }
      }catch(e){
        console.warn('reset password exception', e);
        showError(resetStatus, 'Unexpected error (see console).');
      }
    });

    // ---------- logout ----------
    logoutBtn.addEventListener('click', ()=> showModal(logoutConfirm));
    logoutNo.addEventListener('click', ()=> hideModal(logoutConfirm));
    logoutConfirm.addEventListener('click', (e)=> { if(e.target === logoutConfirm) hideModal(logoutConfirm); });

    logoutYes.addEventListener('click', async ()=>{
      hideModal(logoutConfirm);
      try{ await supabase.auth.signOut(); } catch(e){ console.warn('signOut error', e); }
      alert('You have been logged out.');
      window.location.href = 'index.html';
    });

    // ---------- delete account (safe: only show success when delete actually succeeds) ----------
    deleteAccount.addEventListener('click', async ()=>{
      if(!confirm('Delete account? This is irreversible.')) return;
      const user = await getUserOrRedirect();
      if(!user) return;

      try{
        // Attempt to delete the profile row(s) that are linked to this user.
        // We use user_id as the filter because that's how profiles are looked up elsewhere.
        const { data: deletedRows, error: delErr } = await supabase
          .from('profiles')
          .delete()
          .eq('user_id', user.id);

        if(delErr){
          console.warn('delete profiles error', delErr);
          alert('Your profile could not be deleted. RLS or DB policies prevented deletion.');
          return;
        }

        // Optionally delete addresses (if your project uses an addresses table)
        try{ await supabase.from('addresses').delete().eq('user_id', user.id); }catch(e){ /* ignore if missing */ }

        // We're done client-side — sign out and redirect.
        try{ await supabase.auth.signOut(); }catch(e){ console.warn('signOut after delete failed', e); }

        alert('Profile deleted (client-side). If you need the Auth user removed please deploy a server-side function to perform full deletion.');
        window.location.href = 'index.html';
      }catch(e){
        console.error('deleteAccount exception', e);
        alert('Unable to delete account (see console).');
      }
    });

    // ---------- refresh ----------
    refreshBtn.addEventListener('click', async ()=>{ await loadAll(); alert('Refreshed'); });

    // ---------- init ----------
    async function loadAll(){
      await loadProfile();
      await loadOrders();
    }

    (async function init(){
      // require client
      if(!supabase){ console.error('Supabase not initialized. aborting profile load.'); return; }
      const { data } = await supabase.auth.getSession();
      const session = data?.session || null;
      if(!session || !session.user){ window.location.href = 'index.html'; return; }
      await loadAll();
    })();

    // expose for debug
    window._ssProfile = { loadProfile, loadOrders, openOrderModal };

  })();
  </script>
</body>
</html>